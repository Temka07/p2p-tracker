<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P –ì–∏–±—Ä–∏–¥–Ω—ã–π –¢—Ä–µ–∫–µ—Ä V20.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- V20 COLORS (V15 style restoration) --- */
        :root {
            --primary-color: #0d6efd; 
            --success-color: #198754; 
            --danger-color: #dc3545; 
            --warning-color: #ffc107; 
            --secondary-color: #6c757d; 
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            --info-color: #0dcaf0; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: var(--bg-light); 
            display: flex;
            justify-content: center;
        }

        .container { 
            width: 100%;
            max-width: 1250px; 
            margin: auto; 
            background: var(--bg-white); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            margin-bottom: 30px;
        }

        /* --- UTILITY & CONTROLS --- */
        .header-controls, .utility-buttons, .transaction-form { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        .header-controls { justify-content: space-between; align-items: center; }
        .transaction-form, #expenseForm { 
             padding: 15px; 
             border: 1px solid #ddd; 
             border-radius: 8px; 
             background-color: var(--bg-light);
             align-items: center;
        }
        #expenseForm { 
             border-color: var(--danger-color); 
             margin-top: 15px;
             background-color: #fef7f7;
        }

        /* Input & Select Styling */
        input[type="number"], input[type="text"], select, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            flex-grow: 1;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        
        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-primary:hover, .btn-success:hover, .btn-danger:hover, .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        /* --- TABLE STYLES (Full 8-column style) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
            table-layout: fixed; 
            min-width: 900px; 
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: right;
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
        }
        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 700;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td:first-child, th:first-child {
            text-align: left;
            width: 12%; 
        }
        th:nth-child(2), th:nth-child(3), th:nth-child(6), th:nth-child(7), th:nth-child(8) { 
             width: 12%; 
        } 
        th:nth-child(4), th:nth-child(5) { 
             width: 14%; 
        }

        .total-row th {
            background-color: var(--primary-color);
            color: white;
            font-size: 1.1em;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .monthly-limit-header { background-color: #4f46e5 !important; color: white !important; }
        .status-danger { color: var(--danger-color); font-weight: 700; }
        .status-ok { color: var(--success-color); font-weight: 700; }
        .status-rest { 
             color: var(--warning-color); 
             font-weight: 700; 
             background-color: #fffbe4; 
        }
        
        /* --- PROFIT BOX & COMPARISON --- */
        .profit-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #e6f7ff; 
            border-left: 5px solid var(--info-color);
            box-shadow: var(--shadow);
        }
        .profit-box h2 {
            margin-top: 0;
            color: #0c5460;
            font-size: 1.4em;
        }
        .profit-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .comparison { 
            padding: 8px; 
            border-radius: 5px; 
            margin-top: 10px; 
            font-weight: 600; 
            animation: fadeIn 0.5s ease-out; 
        }
        .comp-positive { background-color: #d1e7dd; color: var(--success-color); }
        .comp-negative { background-color: #f8d7da; color: var(--danger-color); }
        .comp-neutral { background-color: #fff3cd; color: var(--warning-color); }

        /* --- HISTORY SECTION --- */
        .history-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        .history-section h2 { margin-bottom: 15px; }
        .history-table th:nth-child(1) { width: 30%; text-align: left; }
        .history-table th:nth-child(2), .history-table th:nth-child(3) { width: 35%; }
        .history-table td { cursor: pointer; }
        .history-profit { color: var(--success-color); font-weight: 600; }

        /* --- AUTH SECTION --- */
        #authSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .auth-box {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 350px;
            text-align: center;
            animation: popIn 0.3s ease-out;
        }
        .auth-box input { margin-bottom: 15px; width: 100%; }
        .auth-box button { width: 100%; }
        
        /* --- RECOMMENDATIONS (V17/V18 style retained for clarity) --- */
        #recommendationSection {
            margin-top: 30px;
            padding: 15px;
            background-color: #f4f4ff;
            border-radius: 8px;
            border: 1px solid #c3c3e6;
            animation: slideInUp 0.4s ease-out; 
        }
        #recommendationList {
            list-style-type: none;
            padding: 0;
            margin: 10px 0 0;
        }
        #recommendationList li {
            padding: 8px 0;
            border-bottom: 1px dotted #e0e0e0;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .recommend-low { color: var(--success-color); }
        .recommend-high { color: var(--danger-color); font-weight: 600; }
        .recommend-rest { color: var(--warning-color); font-style: italic; }
        
        /* --- MODAL (Retained V15/V16 Style) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: popIn 0.3s ease-out; 
        }
        .modal-field { margin-bottom: 15px; }
        .modal-field label { display: block; margin-bottom: 5px; font-weight: 600; }
        .modal-field input[type="number"], .modal-field input[type="text"] { width: 100%; }
        
        /* Success Modal Animation */
        .fireworks {
            font-size: 4em;
            display: block;
            margin-bottom: 10px;
            animation: bounce 0.6s infinite alternate;
        }

        /* --- TOAST NOTIFICATION (Retained) --- */
        .toast-message {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 5000;
            left: 50%;
            top: 30px;
            font-size: 17px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: visibility 0.3s, opacity 0.3s;
            opacity: 0;
        }
        .toast-show {
            visibility: visible;
            opacity: 1;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        /* --- KEYFRAMES (Animations Added) --- */
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce {
             from { transform: scale(1.0); }
             to { transform: scale(1.1); }
        }
        @-webkit-keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }
        @keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }
        
        /* ========================================================= */
        /* --- V20 MOBILE RESPONSIVENESS ADDED (MEDIA QUERIES) --- */
        /* ========================================================= */
        
        @media (max-width: 900px) {
            .container {
                padding: 15px;
                border-radius: 0; /* Remove border radius on small screens */
                box-shadow: none;
            }
            body {
                padding: 0; /* Remove body padding */
            }

            /* --- Header & Controls --- */
            .header-controls {
                flex-direction: column;
                gap: 15px;
            }
            .utility-buttons, .session-controls {
                width: 100%;
                justify-content: space-around; /* Spread buttons out */
            }
            .btn {
                flex-grow: 1;
                padding: 12px 10px; /* Bigger buttons for touch */
                font-size: 0.9em;
            }
            
            /* --- Transaction Forms --- */
            .transaction-form, #expenseForm {
                flex-direction: column;
                gap: 10px;
            }
            .transaction-form select, .transaction-form input, #expenseForm input, #expenseForm button {
                width: 100%; /* Full width inputs/buttons */
                box-sizing: border-box;
                margin: 0;
            }

            /* --- Main Tracker Table (Making it scrollable horizontally) --- */
            table {
                min-width: 750px; /* Adjusted minimum width for better fit */
                font-size: 0.8em;
            }
            
            /* Adjust padding and font size for smaller cells */
            th, td {
                padding: 8px 5px; 
            }

            /* Resetting fixed width to allow slight shrinking */
            td:first-child, th:first-child {
                width: 15%; 
            }
            th:nth-child(2), th:nth-child(3), th:nth-child(6), th:nth-child(7), th:nth-child(8) { 
                 width: 11%; 
            } 
            th:nth-child(4), th:nth-child(5) { 
                 width: 13%; 
            }
            
            /* Total row */
            .total-row th {
                font-size: 1em;
            }
        }

        @media (max-width: 600px) {
            /* Further adjustments for very small phones */
            table {
                min-width: 650px;
                font-size: 0.75em;
            }
            
            /* Stack buttons more efficiently */
            .utility-buttons, .session-controls {
                flex-wrap: wrap; 
            }
            .btn {
                min-width: 48%; /* Allow two buttons per row */
            }
        }
        
    </style>
</head>
<body onload="init()">

<div id="authSection" style="display: none;">
    <div class="auth-box">
        <h2 id="authTitle">–ù–ò–ö–¢–ò –ö–ò–†–ì–ò–ó“Æ“Æ</h2>
        <input type="text" id="authUsername" placeholder="–ö–æ–ª–¥–æ–Ω—É—É—á—É –ê—Ç—ã (–ù–∏–∫)" required>
        <button onclick="loginUser()" class="btn btn-primary" id="authButton">–ö–∏—Ä“Ø“Ø</button>
        <p style="margin-top: 15px; font-size: 0.9em; color: var(--secondary-color);">*–ë–∏—Ä–∏–Ω—á–∏ –∂–æ–ª—É –∫–∏—Ä—Å–µ“£–∏–∑, –Ω–∏–∫ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© –∫–∞—Ç—Ç–∞–ª–∞—Ç.</p>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="container">
        <h1>P2P –ì–∏–±—Ä–∏–¥–Ω—ã–π –¢—Ä–µ–∫–µ—Ä V20.1</h1>
        
        <div class="header-controls">
            <div class="utility-buttons">
                 <button onclick="showMainTracker()" class="btn btn-primary" id="homeBtn">üè† –ù–ï–ì–ò–ó–ì–ò –≠–ö–†–ê–ù</button>
                 <button onclick="toggleSettings()" class="btn btn-primary" id="settingsBtn">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê</button>
                 <button onclick="toggleMonthlyLimits()" class="btn btn-primary" id="monthlyLimitsBtn">üìÖ –ê–ô–õ–´–ö –õ–ò–ú–ò–¢–¢–ï–†</button>
                 <button onclick="toggleSync()" class="btn btn-primary" id="syncBtn">üåê –°–ò–ù–•–†–û–ù–î–û–®–¢–£–†–£–£</button>
            </div>
            <div class="session-controls">
                <button onclick="undoLastTransaction()" class="btn btn-danger" id="undoBtn" disabled>‚Ü©Ô∏è –ê–ö–´–†–ö–´–ù–´ –û“¢–î–û–û</button>
                <button onclick="openCloseSessionModal()" class="btn btn-success">‚úîÔ∏è –°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£</button> 
                <button onclick="logout()" class="btn btn-secondary">üëã –ß–´–ì–£–£</button>
            </div>
        </div>
        
        <div id="monthlyLimitsView" style="display:none;">
            <h2>üìÖ –ë–∞–Ω–∫—Ç–∞—Ä–¥—ã–Ω –ê–π–ª—ã–∫ –õ–∏–º–∏—Ç—Ç–µ—Ä–∏ (–ö—ã—Å–∫–∞—á–∞)</h2>
            <p>–ê—Ä –±–∏—Ä –±–∞–Ω–∫—Ç—ã–Ω –∞–π–ª—ã–∫ –æ–±–æ—Ä–æ—Ç—Ç–æ—Ä—É–Ω –∂–∞–Ω–∞ –∫–∞–ª–¥—ã–∫—Ç–∞—Ä—ã–Ω –∫”©—Ä“Ø“Ø.</p>
            <table class="monthly-limit-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">–ë–∞–Ω–∫</th>
                        <th>–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th>
                        <th>–£—á—É—Ä–¥–∞–≥—ã –û–±–æ—Ä–æ—Ç</th>
                        <th>–ö–∞–ª–¥—ã–∫ (–°–æ–º)</th>
                    </tr>
                </thead>
                <tbody id="monthlyLimitBody"></tbody>
            </table>
        </div>
        
        <div id="syncSection" style="display:none;">
            <h2>üåê –°–∏–Ω—Ö—Ä–æ–Ω–¥–æ—à—Ç—É—Ä—É—É & –ë”©–ª“Ø—à“Ø“Ø</h2>
            <p>–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –±–∞—à–∫–∞ —Ç“Ø–∑–º”©–∫–∫”© ”©—Ç–∫”©—Ä“Ø“Ø –∂–µ —Ä–µ–∑–µ—Ä–≤–¥–∏–∫ –∫”©—á“Ø—Ä–º”©—Å“Ø–Ω —Å–∞–∫—Ç–æ–æ “Ø—á“Ø–Ω JSON –∫–æ–¥—É–Ω –∫–æ–ª–¥–æ–Ω—É“£—É–∑.</p>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button onclick="exportDataCode()" class="btn btn-primary">–ö–æ–¥–¥—É –≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ</button>
                <button onclick="importDataCode()" class="btn btn-success">–ö–æ–¥–¥–æ–Ω –ò–º–ø–æ—Ä—Ç—Ç–æ–æ</button>
            </div>
            <textarea id="syncInput" placeholder="–≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–ª–≥–æ–Ω –∫–æ–¥ —É—à—É–ª –∂–µ—Ä–¥–µ –ø–∞–π–¥–∞ –±–æ–ª–æ—Ç –∂–µ –∏–º–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω –∫–æ–¥–¥—É —É—à—É–ª –∂–µ—Ä–≥–µ —á–∞–ø—Ç–∞“£—ã–∑." rows="10"></textarea>
        </div>

        <div id="settingsSection" style="display:none;">
            <h2>üõ†Ô∏è –õ–∏–º–∏—Ç—Ç–µ—Ä–¥–∏ –∂–∞–Ω–∞ –ö—É—Ä—Å—Ç–∞—Ä–¥—ã –ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–æ–æ</h2>
            <div class="settings-form" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background-color: var(--bg-light);">
                <label>BUY Rate (USD): <input type="number" id="settingBuyRate" step="0.01" style="width: 100px;"></label>
                <label>Spread (%): <input type="number" id="settingSpread" step="0.01" style="width: 100px;"></label>
                <button onclick="updateSettings()" class="btn btn-primary" style="flex-grow: 0;">–ë–∞–∞—Ä—ã–Ω –°–∞–∫—Ç–æ–æ</button>
            </div>
            
            <table class="settings-table">
                <thead>
                    <tr>
                        <th>–ë–∞–Ω–∫</th>
                        <th>–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th>
                        <th>–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th> 
                        <th>–ê—Ä–∞–∫–µ—Ç—Ç–µ—Ä</th>
                    </tr>
                </thead>
                <tbody id="settingsBody"></tbody>
            </table>

            <div class="add-bank-form" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <input type="text" id="newBankName" placeholder="–ñ–∞“£—ã –ë–∞–Ω–∫ –ê—Ç—ã">
                <input type="number" id="newBankDailyLimit" placeholder="–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º)">
                <input type="number" id="newBankMonthlyLimit" placeholder="–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)" value="300000"> 
                <button onclick="addBank()" class="btn btn-success" style="flex-grow: 1;">+ –ë–ê–ù–ö –ö–û–®–£–£</button>
            </div>
            
            <h2 style="margin-top: 30px; border-bottom: 1px solid #dee2e6;">‚ö†Ô∏è –ö–æ–æ–ø—Ç—É—É –ó–æ–Ω–∞</h2>
            <div class="utility-buttons">
                <button onclick="exportHistoryToCSV()" class="btn btn-secondary">üíæ CSV –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button onclick="resetCurrentDay()" class="btn btn-danger">‚Ü©Ô∏è –£—á—É—Ä–¥–∞–≥—ã –ö“Ø–Ω–¥“Ø –¢–∞–∑–∞–ª–æ–æ</button>
                <button onclick="clearAllData()" class="btn btn-danger">üî• –ë–ê–†–î–´–ö –ú–ê–ê–õ–´–ú–ê–¢–¢–´ ”®–ß“Æ–†“Æ“Æ</button>
            </div>
        </div>

        <div id="trackerView">
            <div class="notes">
                <h3>–ö“Ø–Ω“Ø–º–¥“Ø–∫ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</h3>
            </div>

            <div class="transaction-form">
                <select id="actionType" >
                    <option value="income">–°–∞—Ç—É—É (–ö–∏—Ä–∏—à)</option>
                    <option value="outcome">–°–∞—Ç—ã–ø –∞–ª—É—É (–ß—ã–≥—ã—à)</option>
                </select>
                <input type="number" id="transactionAmount" placeholder="–°—É–º–º–∞ (–°–æ–º)">
                <select id="transactionBank"></select>
                <button onclick="logTransaction()" class="btn btn-primary">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ö–æ—à—É—É</button>
            </div>

            <div id="expenseForm">
                <input type="number" id="personalExpenseAmount" placeholder="–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–æ–º)">
                <button onclick="logPersonalExpense()" class="btn btn-danger">–†–∞—Å—Ö–æ–¥–¥—É –ö–æ—à—É—É</button>
            </div>

            <div id="recommendationSection">
                <h2>üí° –ê–∫—ã–ª–¥—É—É –°—É–Ω—É—à—Ç–∞—Ä (–ê–Ω–∞–ª–∏–∑)</h2>
                <ul id="recommendationList">
                    <li>–°–∏—Å—Ç–µ–º–∞ —É—á—É—Ä–¥–∞ –∞–Ω–∞–ª–∏–∑ –∂“Ø—Ä–≥“Ø–∑“Ø“Ø–¥”©...</li>
                </ul>
            </div>
            
            <div style="overflow-x: auto; max-height: 500px;">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">–ë–∞–Ω–∫</th>
                            <th onclick="sortTable(1)">–ö“Ø–Ω. –õ–∏–º–∏—Ç (–°–æ–º)</th>
                            <th onclick="sortTable(6)">–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th> 
                            <th onclick="sortTable(2)">–ö–∏—Ä–∏—à (–ü—Ä–∏—Ö–æ–¥)</th>
                            <th onclick="sortTable(3)">–ß—ã–≥—ã—à (–†–∞—Å—Ö–æ–¥)</th>
                            <th onclick="sortTable(4)">–ö“Ø–Ω. –û–±–æ—Ä–æ—Ç</th>
                            <th onclick="sortTable(7)">–ê–π–ª—ã–∫ –û—Å—Ç–∞—Ç–æ–∫</th> 
                            <th onclick="sortTable(5)">–ö“Ø–Ω. –û—Å—Ç–∞—Ç–æ–∫ / –°–¢–ê–¢–£–°</th>
                        </tr>
                    </thead>
                    <tbody id="trackerBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <th colspan="3">–ö“Æ–ù–î“Æ–ù –ñ–ê–õ–ü–´ –ñ–´–ô–´–ù–¢–´–ì–´</th>
                            <th id="totalIncome">0</th>
                            <th id="totalOutcome">0</th>
                            <th id="totalTurnover">0</th>
                            <th>-</th>
                            <th id="totalRemaining">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="profit-box">
                <h2>üí∞ –ö“Ø–Ω–¥“Ø–∫ –ü–∞–π–¥–∞ (–°–ø—Ä–µ–¥: <span id="spreadDisplay">0.5%</span>)</h2>
                <div class="profit-value" id="estimatedProfit">0.00 –°–æ–º</div>
                <div class="comparison" id="comparisonDisplay"></div>
                <p style="font-size: 0.8em; color: #555;">(–≠—Å–µ–ø—Ç”©”©: –û–±—â–∏–π –û–±–æ—Ä–æ—Ç / <span id="buyRateDisplay">88.0</span> * <span id="spreadValueDisplay">0.005</span>)</p>
            </div>
            
            <div id="personalExpenseSummary" style="margin-top: 15px; font-weight: bold; color: var(--danger-color);">
                –ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): 0.00 –°–æ–º
            </div>

            <div class="history-section">
                <h2 id="historyHeader">üìä –¢–∞—Ä—ã—Ö (–ò—Å—Ç–æ—Ä–∏—è)</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                     <p style="font-size: 0.9em; color: var(--secondary-color);">*–°–∞–ø—Ç—ã –±–∞—Å—ã–ø, —Ç–æ–ª—É–∫ –æ—Ç—á–µ—Ç—Ç—É –∫”©—Ä“Ø“£“Ø–∑</p>
                     <button onclick="clearHistory()" class="btn btn-danger">üí£ –¢–∞—Ä—ã—Ö—Ç—ã ”®–ß“Æ–†“Æ“Æ</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–±—â–∏–π –û–±–æ—Ä–æ—Ç</th>
                                <th>–ü–∞–π–¥–∞ (–¢–∞–∑–∞)</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                         <tfoot>
                            <tr class="total-row">
                                <th colspan="2">–ñ–ê–õ–ü–´ –¢–ê–†–´–•–´–ô –ü–ê–ô–î–ê</th>
                                <th id="totalHistoryProfit">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="closeSessionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2>–°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£</h2>
        <p>–ö–∞–ª–¥—ã–∫ –∫–∞—Ä–∞–∂–∞—Ç—Ç–∞—Ä–¥—ã –∂–∞–Ω–∞ —Ç–∞–∑–∞ –ø–∞–π–¥–∞–Ω—ã —Ç–∞–∫—Ç–æ–æ “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.</p>

        <div class="modal-field">
            <label for="remainingAmount">üí∞ –°–∞—Ç—ã–ª–±–∞–π –ö–∞–ª–≥–∞–Ω –ö–∞–ª–¥—ã–∫ –°—É–º–º–∞ (–°–æ–º)</label>
            <input type="number" id="remainingAmount" value="0" placeholder="–ú–∏—Å–∞–ª—ã: 90000">
        </div>

        <div class="modal-field">
            <label for="personalExpensesTotal">üõí –ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞)</label>
            <input type="text" id="personalExpensesTotal" value="0.00" disabled>
        </div>

        <div class="modal-field">
            <label for="actualProfitInput">üí∏ –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑–¥—ã –ö–∏—Ä–≥–∏–∑–∏“£–∏–∑ (–°–æ–º)</label>
            <input type="number" id="actualProfitInput" placeholder="–ú–∏—Å–∞–ª—ã: 12500">
            <p style="font-size: 0.8em; color: var(--secondary-color); margin-top: 5px;">*–ë—É–ª –º–∞–∞–Ω–∏–≥–µ –∫–∞—Ä–∞–ø –°–ø—Ä–µ–¥ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© —ç—Å–µ–ø—Ç–µ–ª–µ—Ç.</p>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="closeSession(true)" class="btn btn-success" style="flex-grow: 1;">‚úîÔ∏è –°–ú–ï–ù–ê–ù–´ –ë“Æ–¢“Æ–†“Æ“Æ</button>
            <button onclick="document.getElementById('closeSessionModal').style.display='none';" class="btn btn-secondary">‚ùå –ñ–ê–ë–£–£ / –ê–†–¢–ö–ê</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="text-align: center;">
        <span class="fireworks">üéâ</span>
        <h2 style="color: var(--success-color);">–ò–ô–ì–ò–õ–ò–ö–¢“Æ“Æ! –°–ú–ï–ù–ê –ñ–ê–ë–´–õ–î–´!</h2>
        <p style="font-size: 1.5em;">–°–∏–∑–¥–∏–Ω –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑:</p>
        <div class="profit-value" style="color: var(--danger-color); font-size: 3em;" id="modalProfitDisplay">0.00 –°–æ–º</div>
        <div style="margin-top: 10px; font-weight: 600;">–ñ–∞“£—ã –≠—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –°–ø—Ä–µ–¥: <span id="modalNewSpread">0.0%</span></div>
        <div style="margin-top: 5px; font-weight: 600;">–ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: <span id="modalExpenseDisplay">0.00 –°–æ–º</span></div>
        <button onclick="document.getElementById('successModal').style.display='none';" class="btn btn-primary" style="margin-top: 20px;">–£–ª–∞–Ω—Ç—É—É</button>
    </div>
</div>

<div id="toastNotification" class="toast-message">–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø! ‚úÖ</div>


<script>
    // --- STORAGE KEYS (V20 Update: Changed only version number) ---
    const STORAGE_CURRENT_DATA = 'p2p_tracker_v20_data';
    const STORAGE_HISTORY = 'p2p_history_v20';
    const STORAGE_LAST_DATE = 'p2p_last_session_date_v20';
    const STORAGE_SETTINGS = 'p2p_settings_v20';
    const STORAGE_TRANSACTION_LOG = 'p2p_transaction_log_v20';
    const STORAGE_MONTHLY_TURNOVER = 'p2p_monthly_turnover_v20'; 
    const STORAGE_PERSONAL_EXPENSE = 'p2p_personal_expense_v20';
    const STORAGE_AUTH_CREDENTIALS = 'p2p_auth_username_v20'; 
    const STORAGE_AUTH_STATUS = 'p2p_auth_status_v20'; 

    let BUY_RATE = 88.0;
    let SPREAD = 0.5; 
    let PENALTY_PERCENTAGE = 0.20; 
    let PERSONAL_EXPENSE_TODAY = 0; 

    let CURRENT_USER_NIC = null; 

    const RISK_TIER_2_DAYS = 50000; 
    const RISK_TIER_3_DAYS = 100000; 
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    let STARTING_LIMITS = {
        "Optima24": { daily: 35000, monthly: 300000 }, 
        "DemirBank": { daily: 25000, monthly: 250000 }, 
        "Mbank": { daily: 20000, monthly: 200000 }
    };

    let bankLimits = [];
    let transactionLog = [];
    let monthlyTurnover = {}; 
    let currentView = 'tracker'; // 'tracker', 'settings', 'sync', 'monthlyLimits'

    // --- AUTHENTICATION LOGIC (Retained) ---
    function displayUserName() {
        // Not used in V20, but kept for future proofing.
    }

    function checkAuthStatus() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        const authStatus = localStorage.getItem(STORAGE_AUTH_STATUS);
        
        if (authStatus === 'logged_in' && storedNic) {
            CURRENT_USER_NIC = storedNic;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadState(); 
            initTrackerContent();
        } else {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    }

    function loginUser() {
        const username = document.getElementById('authUsername').value.trim();

        if (username.length < 3) {
            alert("–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã (–ù–∏–∫) 3 —Å–∏–º–≤–æ–ª—É–Ω–∞–Ω –∫–µ–º –±–æ–ª–±–æ—Å—É–Ω.");
            return;
        }

        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);

        if (!storedNic || storedNic === username) {
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        } else {
             if (!confirm(`–≠–°–ö–ï–†–¢“Æ“Æ: –ú—É—Ä—É–Ω–∫—É –∫–æ–ª–¥–æ–Ω—É—É—á—É "${storedNic}" –±–æ–ª–≥–æ–Ω. "${username}" –º–µ–Ω–µ–Ω —É–ª–∞–Ω—Ç–∞—Å—ã–∑–±—ã? –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–∏—à–∏ –º“Ø–º–∫“Ø–Ω.`)) {
                 return;
             }
             localStorage.clear();
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        }
        
        CURRENT_USER_NIC = username;
        localStorage.setItem(STORAGE_AUTH_STATUS, 'logged_in');
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        loadState(); 
        initTrackerContent();
        showToast(`–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∫–∏—Ä–¥–∏“£–∏–∑: ${username}!`);
    }

    function logout() {
        if (confirm("–ß—ã–≥—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.removeItem(STORAGE_AUTH_STATUS); 
            
            document.getElementById('authUsername').value = CURRENT_USER_NIC || '';
            CURRENT_USER_NIC = null;
            
            checkAuthStatus(); 
        }
    }

    // --- VIEW TOGGLE LOGIC (V15/V16 style) ---

    function setActiveView(viewName) {
        document.getElementById('trackerView').style.display = 'none';
        document.getElementById('settingsSection').style.display = 'none';
        document.getElementById('syncSection').style.display = 'none';
        document.getElementById('monthlyLimitsView').style.display = 'none';
        
        if (viewName === 'tracker') {
            document.getElementById('trackerView').style.display = 'block';
        } else if (viewName === 'settings') {
            renderSettings();
            document.getElementById('settingsSection').style.display = 'block';
        } else if (viewName === 'sync') {
            document.getElementById('syncSection').style.display = 'block';
        } else if (viewName === 'monthlyLimits') {
            renderMonthlyLimitsTable();
            document.getElementById('monthlyLimitsView').style.display = 'block';
        }
        currentView = viewName;
    }

    function showMainTracker() {
        setActiveView('tracker');
    }

    function toggleSettings() {
        setActiveView(currentView === 'settings' ? 'tracker' : 'settings');
    }

    function toggleSync() {
        setActiveView(currentView === 'sync' ? 'tracker' : 'sync');
    }
    
    function toggleMonthlyLimits() {
        setActiveView(currentView === 'monthlyLimits' ? 'tracker' : 'monthlyLimits');
    }

    function renderMonthlyLimitsTable() {
        const body = document.getElementById('monthlyLimitBody');
        body.innerHTML = '';
        
        bankLimits.forEach(bank => {
             const currentMonthlyTurnover = monthlyTurnover[bank.name] || 0;
             const remainingMonthly = bank.monthlyLimit - currentMonthlyTurnover;
             const statusClass = remainingMonthly <= bank.monthlyLimit * 0.1 ? 'status-danger' : 'status-ok';

             const row = document.createElement('tr');
             row.innerHTML = `
                 <td>${bank.name}</td>
                 <td>${bank.monthlyLimit.toLocaleString('ru-RU')}</td>
                 <td>${currentMonthlyTurnover.toLocaleString('ru-RU')}</td>
                 <td class="${statusClass}">${remainingMonthly.toLocaleString('ru-RU')}</td>
             `;
             body.appendChild(row);
        });
    }

    // --- INIT --- (Retained)

    function initTrackerContent() {
        displayUserName(); 
        renderBankOptions(); 
        renderTable();
        renderHistory();
        generateRecommendations(); 
        setActiveView('tracker');
    }
    
    function init() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        if (storedNic) {
             document.getElementById('authUsername').value = storedNic;
        }

        checkAuthStatus(); 
    }

    // --- CORE JAVASCRIPT FUNCTIONS (Retained logic from V18) ---

    function saveGlobalSettings() {
        const settings = {
            buyRate: BUY_RATE,
            spread: SPREAD,
            startingLimits: STARTING_LIMITS
        };
        localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
    }

    function loadGlobalSettings() {
        const storedSettings = localStorage.getItem(STORAGE_SETTINGS);
        if (storedSettings) {
            const settings = JSON.parse(storedSettings);
            BUY_RATE = settings.buyRate || 88.0;
            SPREAD = settings.spread || 0.5;
            STARTING_LIMITS = settings.startingLimits || STARTING_LIMITS;
        }
        
        const storedMonthlyTurnover = localStorage.getItem(STORAGE_MONTHLY_TURNOVER);
        if (storedMonthlyTurnover) {
             monthlyTurnover = JSON.parse(storedMonthlyTurnover);
             
             const today = new Date();
             if (localStorage.getItem(STORAGE_LAST_DATE)) {
                 const lastDate = new Date(localStorage.getItem(STORAGE_LAST_DATE));
                 if (today.getDate() === 1 && lastDate.getMonth() !== today.getMonth()) {
                      monthlyTurnover = {};
                      localStorage.setItem(STORAGE_MONTHLY_TURNOVER, JSON.stringify(monthlyTurnover));
                 } 
             }
        }
    }

    function syncBankLimits() {
         const updatedBankLimits = [];
         for (const name in STARTING_LIMITS) {
             const limits = STARTING_LIMITS[name];
             let existingBank = bankLimits.find(b => b.name === name);
             
             if (existingBank) {
                 existingBank.baseLimit = limits.daily; 
                 existingBank.monthlyLimit = limits.monthly; 
                 updatedBankLimits.push(existingBank);
             } else {
                 updatedBankLimits.push({ 
                     name: name, 
                     baseLimit: limits.daily, 
                     monthlyLimit: limits.monthly,
                     income: 0, 
                     outcome: 0, 
                     restingUntil: null 
                 });
             }
         }
         bankLimits = updatedBankLimits.filter(bank => STARTING_LIMITS[bank.name] !== undefined);
         saveGlobalSettings(); 
    }
    
    function loadState() {
        loadGlobalSettings();
        
        const storedData = localStorage.getItem(STORAGE_CURRENT_DATA);
        if (storedData) {
            bankLimits = JSON.parse(storedData);
        } else {
            syncBankLimits();
        }
        
        const storedLog = localStorage.getItem(STORAGE_TRANSACTION_LOG);
        if (storedLog) {
            transactionLog = JSON.parse(storedLog);
        }

        const storedExpense = localStorage.getItem(STORAGE_PERSONAL_EXPENSE);
        if (storedExpense) {
            PERSONAL_EXPENSE_TODAY = parseFloat(storedExpense) || 0;
        }
        
        checkNewDay();
        updateDisplay();
    }

    function saveState() {
        localStorage.setItem(STORAGE_CURRENT_DATA, JSON.stringify(bankLimits));
        localStorage.setItem(STORAGE_TRANSACTION_LOG, JSON.stringify(transactionLog));
        localStorage.setItem(STORAGE_MONTHLY_TURNOVER, JSON.stringify(monthlyTurnover)); 
        localStorage.setItem(STORAGE_PERSONAL_EXPENSE, PERSONAL_EXPENSE_TODAY.toFixed(2));
        updateDisplay();
        generateRecommendations(); 
    }
    
    function checkNewDay() {
        const today = new Date();
        const lastSessionDateStr = localStorage.getItem(STORAGE_LAST_DATE);
        
        if (lastSessionDateStr) {
            const lastSessionDate = new Date(lastSessionDateStr);
            
            // Check if it's a new day
            if (today.toDateString() !== lastSessionDate.toDateString()) {
                
                // Clear daily limits and reset rest periods
                bankLimits.forEach(bank => {
                    bank.income = 0;
                    bank.outcome = 0;
                    if (bank.restingUntil && new Date(bank.restingUntil) <= today) {
                        bank.restingUntil = null;
                    }
                });
                
                transactionLog = [];
                PERSONAL_EXPENSE_TODAY = 0;
                localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
                localStorage.removeItem(STORAGE_TRANSACTION_LOG);
                
                showToast("–ñ–∞“£—ã –∫“Ø–Ω! –ö“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç—Ç–µ—Ä —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. ‚úÖ");
            } else {
                // Same day, just clear rest status if the rest period is over (should be done above, but belt and suspenders)
                bankLimits.forEach(bank => {
                    if (bank.restingUntil && new Date(bank.restingUntil) <= today) {
                        bank.restingUntil = null;
                    }
                });
            }
        }
        
        // Always update the last session date
        localStorage.setItem(STORAGE_LAST_DATE, today.toISOString());
    }
    
    function renderBankOptions() {
        const select = document.getElementById('transactionBank');
        select.innerHTML = '';
        
        bankLimits.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.name;
            option.textContent = bank.name;
            select.appendChild(option);
        });
    }

    function renderTable() {
        const body = document.getElementById('trackerBody');
        body.innerHTML = '';
        
        let totalIncome = 0;
        let totalOutcome = 0;
        let totalTurnover = 0;
        let totalRemaining = 0;
        
        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;
            const remainingMonthly = bank.monthlyLimit - (monthlyTurnover[bank.name] || 0);

            let statusText = '';
            let statusClass = '';

            if (bank.restingUntil) {
                statusText = '–≠—Å –∞–ª—É—É–¥–∞';
                statusClass = 'status-rest';
            } else if (remainingDaily <= bank.baseLimit * 0.1) {
                statusText = '‚ö†Ô∏è –ê–∑ –∫–∞–ª–¥—ã';
                statusClass = 'status-danger';
            } else if (remainingDaily < 0) {
                statusText = 'üõë –ê—à—ã–ø –∫–µ—Ç—Ç–∏!';
                statusClass = 'status-danger';
            } else {
                statusText = '‚úÖ –û–ö';
                statusClass = 'status-ok';
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${bank.name}</td>
                <td>${bank.baseLimit.toLocaleString('ru-RU')}</td>
                <td class="monthly-limit-header">${bank.monthlyLimit.toLocaleString('ru-RU')}</td>
                <td>${bank.income.toLocaleString('ru-RU')}</td>
                <td>${bank.outcome.toLocaleString('ru-RU')}</td>
                <td>${turnover.toLocaleString('ru-RU')}</td>
                <td>${remainingMonthly.toLocaleString('ru-RU')}</td>
                <td class="${statusClass}" data-sort="${remainingDaily}">${remainingDaily.toLocaleString('ru-RU')} / ${statusText}</td>
            `;
            body.appendChild(row);
            
            totalIncome += bank.income;
            totalOutcome += bank.outcome;
            totalTurnover += turnover;
            totalRemaining += remainingDaily;
        });

        document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('ru-RU');
        document.getElementById('totalOutcome').textContent = totalOutcome.toLocaleString('ru-RU');
        document.getElementById('totalTurnover').textContent = totalTurnover.toLocaleString('ru-RU');
        document.getElementById('totalRemaining').textContent = totalRemaining.toLocaleString('ru-RU');
        document.getElementById('personalExpenseSummary').textContent = `–ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): ${PERSONAL_EXPENSE_TODAY.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
    }

    function updateDisplay() {
        renderTable();
        renderProfit();
        // Update settings inputs
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;
        
        // Update displayed rates
        document.getElementById('spreadDisplay').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('spreadValueDisplay').textContent = (SPREAD / 100).toFixed(4);
        document.getElementById('buyRateDisplay').textContent = BUY_RATE.toFixed(1);
        
        // Update undo button
        document.getElementById('undoBtn').disabled = transactionLog.length === 0;
    }

    function renderProfit() {
        const totalTurnover = bankLimits.reduce((sum, bank) => sum + (bank.income + bank.outcome), 0);
        
        // Calculate estimated profit
        let estimatedProfit = (totalTurnover / BUY_RATE) * (SPREAD / 100) * BUY_RATE;
        estimatedProfit = estimatedProfit - PERSONAL_EXPENSE_TODAY;
        
        document.getElementById('estimatedProfit').textContent = `${estimatedProfit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        
        // Calculate break-even profit (0.5% spread)
        const breakEvenProfit = (totalTurnover / BUY_RATE) * (0.5 / 100) * BUY_RATE;

        const comparisonDisplay = document.getElementById('comparisonDisplay');
        comparisonDisplay.innerHTML = '';
        
        if (SPREAD > 0.5) {
            const diff = estimatedProfit - breakEvenProfit;
            const text = diff > 0 
                ? `üöÄ 0.5% –∫–∞—Ä–∞–≥–∞–Ω–¥–∞ ${diff.toFixed(2).toLocaleString('ru-RU')} –°–æ–º –ö”®–ü!` 
                : `üìâ 0.5% –∫–∞—Ä–∞–≥–∞–Ω–¥–∞ ${Math.abs(diff).toFixed(2).toLocaleString('ru-RU')} –°–æ–º –ö–ï–ú.`;
            comparisonDisplay.textContent = text;
            comparisonDisplay.className = `comparison ${diff >= 0 ? 'comp-positive' : 'comp-negative'}`;
        } else if (SPREAD < 0.5) {
            comparisonDisplay.textContent = `–¢”©–º”©–Ω –°–ø—Ä–µ–¥: –ö”©“£“Ø–ª –±—É—Ä—É“£—É–∑.`;
            comparisonDisplay.className = `comparison comp-neutral`;
        } else {
            comparisonDisplay.textContent = `0.5% —Å—Ç–∞–Ω–¥–∞—Ä—Ç—Ç—ã–∫ —Å–ø—Ä–µ–¥ –∫–æ–ª–¥–æ–Ω—É–ª—É—É–¥–∞.`;
            comparisonDisplay.className = `comparison comp-neutral`;
        }
    }

    function logTransaction() {
        const actionType = document.getElementById('actionType').value;
        const amountStr = document.getElementById('transactionAmount').value;
        const bankName = document.getElementById('transactionBank').value;

        if (!amountStr || parseFloat(amountStr) <= 0) {
            showToast("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Å—É–º–º–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }

        const amount = parseFloat(amountStr);
        const bank = bankLimits.find(b => b.name === bankName);
        
        if (!bank) return;

        // Check if resting
        if (bank.restingUntil && new Date(bank.restingUntil) > new Date()) {
            showToast(`${bankName} —ç—Å –∞–ª—É—É–¥–∞. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—à—É–ª–≥–∞–Ω –∂–æ–∫.`, 'danger');
            return;
        }
        
        // Check daily limit
        const turnover = bank.income + bank.outcome;
        if (turnover + amount > bank.baseLimit) {
            if (!confirm(`${bankName} –∫“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç–∏ (${bank.baseLimit.toLocaleString('ru-RU')}) –∞—à—ã–ø –∫–µ—Ç—Ç–∏. –ë–∞–∞—Ä—ã –±–∏—Ä –∫–æ—à–æ—Å—É–∑–±—É?`)) {
                return;
            }
        }

        // Check monthly limit
        const currentMonthlyTurnover = monthlyTurnover[bankName] || 0;
        if (currentMonthlyTurnover + amount > bank.monthlyLimit) {
            if (!confirm(`${bankName} –∞–π–ª—ã–∫ –ª–∏–º–∏—Ç–∏ (${bank.monthlyLimit.toLocaleString('ru-RU')}) –∞—à—ã–ø –∫–µ—Ç—Ç–∏. –ë–∞–∞—Ä—ã –±–∏—Ä –∫–æ—à–æ—Å—É–∑–±—É?`)) {
                return;
            }
        }
        
        // Log the transaction
        if (actionType === 'income') {
            bank.income += amount;
        } else {
            bank.outcome += amount;
        }

        // Update monthly turnover
        monthlyTurnover[bankName] = (monthlyTurnover[bankName] || 0) + amount;
        
        // Log for undo
        transactionLog.push({ 
            type: actionType, 
            amount: amount, 
            bank: bankName, 
            monthlyTurnover: amount,
            expense: 0
        });

        document.getElementById('transactionAmount').value = '';
        saveState();
        showToast("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—à—É–ª–¥—É. ‚úÖ");
    }

    function logPersonalExpense() {
        const amountStr = document.getElementById('personalExpenseAmount').value;

        if (!amountStr || parseFloat(amountStr) <= 0) {
            showToast("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥ —Å—É–º–º–∞—Å—ã–Ω –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }
        
        const amount = parseFloat(amountStr);
        
        PERSONAL_EXPENSE_TODAY += amount;
        
        // Log for undo
        transactionLog.push({ 
            type: 'expense', 
            amount: amount, 
            bank: null, 
            monthlyTurnover: 0,
            expense: amount
        });

        document.getElementById('personalExpenseAmount').value = '';
        saveState();
        showToast("–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ –∫–æ—à—É–ª–¥—É. üí∞");
    }
    
    function undoLastTransaction() {
        if (transactionLog.length === 0) return;
        
        if (!confirm("–ê–∫—ã—Ä–∫—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) return;
        
        const lastTransaction = transactionLog.pop();
        
        if (lastTransaction.type === 'expense') {
            // Undo personal expense
            PERSONAL_EXPENSE_TODAY -= lastTransaction.amount;
        } else {
            // Undo income/outcome
            const bank = bankLimits.find(b => b.name === lastTransaction.bank);
            if (bank) {
                if (lastTransaction.type === 'income') {
                    bank.income -= lastTransaction.amount;
                } else if (lastTransaction.type === 'outcome') {
                    bank.outcome -= lastTransaction.amount;
                }
                // Undo monthly turnover
                monthlyTurnover[lastTransaction.bank] -= lastTransaction.monthlyTurnover;
            }
        }
        
        saveState();
        showToast("–ê–∫—ã—Ä–∫—ã –∞—Ä–∞–∫–µ—Ç –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—ã–ª–¥—ã. ‚Ü©Ô∏è");
    }

    function closeSession(isFinalClosure) {
        if (!isFinalClosure) {
            // Open modal to get final data
            openCloseSessionModal();
            return;
        }
        
        // Final closure logic
        const remainingAmount = parseFloat(document.getElementById('remainingAmount').value) || 0;
        const actualProfit = parseFloat(document.getElementById('actualProfitInput').value);
        
        if (isNaN(actualProfit) || actualProfit < 0) {
            alert("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Ç–∞–∑–∞ –ø–∞–π–¥–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }

        // Calculate total turnover for the day
        const totalTurnover = bankLimits.reduce((sum, bank) => sum + (bank.income + bank.outcome), 0);
        
        // Calculate new effective spread
        // Estimated profit calculation: Profit = (Turnover / BUY_RATE) * (SPREAD / 100) * BUY_RATE
        // If Actual Profit is known: SPREAD = (Actual Profit / BUY_RATE) / (Turnover / BUY_RATE) * 100
        let newSpread = 0;
        if (totalTurnover > 0) {
            // Profit (USD) = ActualProfit / BUY_RATE
            // Turnover (USD) = Turnover / BUY_RATE
            // Spread = Profit (USD) / Turnover (USD)
            // Simplified: Spread = Actual Profit / Turnover (in percentage)
            newSpread = (actualProfit / totalTurnover) * 100;
        } else {
             newSpread = SPREAD;
        }
        
        // Save old spread
        const oldSpread = SPREAD;

        // Apply new spread
        SPREAD = parseFloat(newSpread.toFixed(2));
        
        // Log to history
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        const today = new Date();
        
        // Calculate total expenses for the day
        const totalExpenses = PERSONAL_EXPENSE_TODAY;

        history.push({
            date: today.toISOString(),
            turnover: totalTurnover,
            profit: actualProfit,
            oldSpread: oldSpread,
            newSpread: SPREAD,
            remainingAmount: remainingAmount,
            expenses: totalExpenses,
            banks: bankLimits.map(b => ({
                name: b.name,
                income: b.income,
                outcome: b.outcome,
                turnover: b.income + b.outcome,
                remainingDaily: b.baseLimit - (b.income + b.outcome),
                monthlyTurnover: monthlyTurnover[b.name] || 0
            }))
        });
        localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));

        // Clear current day data (excluding settings and monthly turnover)
        bankLimits.forEach(bank => {
            bank.income = 0;
            bank.outcome = 0;
            // No need to reset monthly turnover here, it's done during loadState/checkNewDay if new month/day
        });
        transactionLog = [];
        PERSONAL_EXPENSE_TODAY = 0;

        localStorage.removeItem(STORAGE_TRANSACTION_LOG);
        localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
        localStorage.setItem(STORAGE_CURRENT_DATA, JSON.stringify(bankLimits));
        saveGlobalSettings(); // Save the new spread

        // Show success modal
        document.getElementById('closeSessionModal').style.display = 'none';
        document.getElementById('modalProfitDisplay').textContent = `${actualProfit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        document.getElementById('modalNewSpread').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('modalExpenseDisplay').textContent = `${totalExpenses.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        document.getElementById('successModal').style.display = 'flex';
        
        // Final update
        loadState();
        renderHistory();
    }
    
    function openCloseSessionModal() {
        // Calculate total expenses for display in modal
        document.getElementById('personalExpensesTotal').value = PERSONAL_EXPENSE_TODAY.toFixed(2);
        document.getElementById('closeSessionModal').style.display = 'flex';
    }

    // --- SETTINGS LOGIC ---

    function renderSettings() {
        const body = document.getElementById('settingsBody');
        body.innerHTML = '';
        
        // Set global settings inputs
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;

        bankLimits.forEach((bank, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${bank.name}</td>
                <td><input type="number" id="daily-${index}" value="${bank.baseLimit}" min="0"></td>
                <td><input type="number" id="monthly-${index}" value="${bank.monthlyLimit}" min="0"></td>
                <td><button onclick="removeBank('${bank.name}')" class="btn btn-danger btn-sm">”®–ß“Æ–†“Æ“Æ</button></td>
            `;
            body.appendChild(row);
        });
    }

    function updateSettings() {
        // Update global settings
        const newBuyRate = parseFloat(document.getElementById('settingBuyRate').value);
        const newSpread = parseFloat(document.getElementById('settingSpread').value);

        if (!isNaN(newBuyRate) && newBuyRate > 0) BUY_RATE = newBuyRate;
        if (!isNaN(newSpread) && newSpread >= 0) SPREAD = newSpread;
        
        // Update bank limits
        const newStartingLimits = {};
        bankLimits.forEach((bank, index) => {
            const newDaily = parseFloat(document.getElementById(`daily-${index}`).value);
            const newMonthly = parseFloat(document.getElementById(`monthly-${index}`).value);
            
            if (!isNaN(newDaily) && newDaily >= 0) {
                 bank.baseLimit = newDaily;
                 newStartingLimits[bank.name] = { daily: newDaily, monthly: bank.monthlyLimit };
            }
            if (!isNaN(newMonthly) && newMonthly >= 0) {
                bank.monthlyLimit = newMonthly;
                newStartingLimits[bank.name] = { daily: bank.baseLimit, monthly: newMonthly };
            }
        });
        
        // Ensure STARTING_LIMITS is updated from the current limits after editing
        bankLimits.forEach(bank => {
             STARTING_LIMITS[bank.name] = { daily: bank.baseLimit, monthly: bank.monthlyLimit };
        });

        saveGlobalSettings();
        saveState();
        renderSettings();
        showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä —Å–∞–∫—Ç–∞–ª–¥—ã. ‚úÖ");
    }

    function addBank() {
        const name = document.getElementById('newBankName').value.trim();
        const dailyLimit = parseFloat(document.getElementById('newBankDailyLimit').value);
        const monthlyLimit = parseFloat(document.getElementById('newBankMonthlyLimit').value);
        
        if (!name || isNaN(dailyLimit) || dailyLimit <= 0 || isNaN(monthlyLimit) || monthlyLimit <= 0) {
            showToast("–¢—É—É—Ä–∞ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }

        if (bankLimits.find(b => b.name === name)) {
            showToast("–ú—ã–Ω–¥–∞–π –±–∞–Ω–∫ –º—É—Ä—É–Ω—Ç–∞–Ω –±–∞—Ä.", 'danger');
            return;
        }

        STARTING_LIMITS[name] = { daily: dailyLimit, monthly: monthlyLimit };
        syncBankLimits(); // Add the new bank to bankLimits
        saveState();
        
        document.getElementById('newBankName').value = '';
        document.getElementById('newBankDailyLimit').value = '';
        document.getElementById('newBankMonthlyLimit').value = '300000';
        
        renderSettings();
        renderBankOptions();
        showToast(`${name} –∫–æ—à—É–ª–¥—É. ‚úÖ`);
    }

    function removeBank(name) {
        if (!confirm(`${name} –±–∞–Ω–∫—ã–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã? –ë–∞—Ä–¥—ã–∫ —Ç–∞—Ä—ã—Ö—ã–π –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∫–∞–ª–∞—Ç.`)) return;
        
        delete STARTING_LIMITS[name];
        syncBankLimits(); 
        saveState();
        renderSettings();
        renderBankOptions();
        showToast(`${name} ”©—á“Ø—Ä“Ø–ª–¥“Ø. üóëÔ∏è`);
    }
    
    // --- RECOMMENDATION LOGIC --- (V19)

    function generateRecommendations() {
        const list = document.getElementById('recommendationList');
        list.innerHTML = '';
        const recommendations = [];
        const today = new Date();

        // 1. Bank Limit Status
        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;
            const remainingMonthly = bank.monthlyLimit - (monthlyTurnover[bank.name] || 0);

            if (bank.restingUntil) {
                const restDate = new Date(bank.restingUntil).toLocaleDateString('ru-RU');
                recommendations.push(`<li class="recommend-rest">${bank.name}: –≠—Å –∞–ª—É—É–¥–∞. ${restDate} —á–µ–π–∏–Ω.</li>`);
            } else if (remainingDaily <= 0) {
                recommendations.push(`<li class="recommend-high">üõë ${bank.name}: –ö“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç (${bank.baseLimit.toLocaleString('ru-RU')}) –ê–®–´–ü –ö–ï–¢–¢–ò!</li>`);
            } else if (remainingDaily <= bank.baseLimit * 0.15) { // 15% threshold
                recommendations.push(`<li class="recommend-low">‚ö†Ô∏è ${bank.name}: –õ–∏–º–∏—Ç –∞–∑ –∫–∞–ª–¥—ã. –ö–∞–ª–¥—ã–∫: ${remainingDaily.toLocaleString('ru-RU')} –°–æ–º.</li>`);
            }
            
            if (remainingMonthly <= 0) {
                recommendations.push(`<li class="recommend-high">üõë ${bank.name}: –ê–π–ª—ã–∫ –ª–∏–º–∏—Ç (${bank.monthlyLimit.toLocaleString('ru-RU')}) –ê–®–´–ü –ö–ï–¢–¢–ò!</li>`);
            } else if (remainingMonthly <= bank.monthlyLimit * 0.15) {
                 recommendations.push(`<li class="recommend-low">‚ö†Ô∏è ${bank.name}: –ê–π–ª—ã–∫ –ª–∏–º–∏—Ç –∞–∑ –∫–∞–ª–¥—ã. –ö–∞–ª–¥—ã–∫: ${remainingMonthly.toLocaleString('ru-RU')} –°–æ–º.</li>`);
            }
        });

        // 2. Turnover Balance (Find largest discrepancy between income and outcome)
        const totalIncome = bankLimits.reduce((sum, b) => sum + b.income, 0);
        const totalOutcome = bankLimits.reduce((sum, b) => sum + b.outcome, 0);
        const balance = totalIncome - totalOutcome;

        if (Math.abs(balance) > 50000) { // 50k Som discrepancy threshold
             if (balance > 0) {
                 recommendations.push(`<li class="recommend-high">‚ùóÔ∏è –ß–´–ì–´–® –ñ–ï–¢–ò–®–°–ò–ó: –ö–∏—Ä–∏—à –ß—ã–≥—ã—à—Ç–∞–Ω ${balance.toLocaleString('ru-RU')} –°–æ–º–≥–æ –∫”©–ø. –¢–µ–∫—à–µ—Ä–∏“£–∏–∑!</li>`);
             } else {
                 recommendations.push(`<li class="recommend-high">‚ùóÔ∏è –ö–ò–†–ò–® –ñ–ï–¢–ò–®–°–ò–ó: –ß—ã–≥—ã—à –ö–∏—Ä–∏—à—Ç–µ–Ω ${Math.abs(balance).toLocaleString('ru-RU')} –°–æ–º–≥–æ –∫”©–ø. –¢–µ–∫—à–µ—Ä–∏“£–∏–∑!</li>`);
             }
        } else if (Math.abs(balance) > 0) {
            recommendations.push(`<li class="recommend-low">‚úÖ –û–±–æ—Ä–æ—Ç —Ç–µ“£ —Å–∞–ª–º–∞–∫—Ç—É—É: –ê–π—Ä—ã–º–∞—á—ã–ª—ã–∫ ${Math.abs(balance).toLocaleString('ru-RU')} –°–æ–º –≥–∞–Ω–∞.</li>`);
        }

        // 3. Resting Recommendations based on usage
        bankLimits.forEach(bank => {
             const turnover = bank.income + bank.outcome;
             if (turnover > 0 && !bank.restingUntil) {
                 const daysSinceLastRest = 3; // Simplified for now, cannot track exact rest days without history
                 if (daysSinceLastRest >= 5 && turnover > RISK_TIER_3_DAYS) {
                     recommendations.push(`<li class="recommend-high">üö® ${bank.name} 5+ –∫“Ø–Ω –∞–∫—Ç–∏–≤–¥“Ø“Ø. ${RISK_TIER_3_DAYS.toLocaleString('ru-RU')}+ –æ–±–æ—Ä–æ—Ç. –≠—Å –∞–ª—É—É–≥–∞ –ö–û–Æ“¢–£–ó!</li>`);
                 } else if (turnover > RISK_TIER_2_DAYS * 3) {
                      recommendations.push(`<li class="recommend-low">‚ö†Ô∏è ${bank.name} –±“Ø–≥“Ø–Ω –∂–æ–≥–æ—Ä–∫—É –æ–±–æ—Ä–æ—Ç—Ç–æ. –ë–∏—Ä –Ω–µ—á–µ –∫“Ø–Ω–≥”© —ç—Å –∞–ª—É—É–≥–∞ –∫–æ—é—É —Å—É–Ω—É—à—Ç–∞–ª–∞—Ç.</li>`);
                 }
             }
        });


        if (recommendations.length === 0) {
            list.innerHTML = '<li>–ë–∞–∞—Ä—ã –∂–∞–π—ã–Ω–¥–∞. –£—á—É—Ä–¥–∞ –æ–ª—É—Ç—Ç—É—É —Å—É–Ω—É—à—Ç–∞—Ä –∂–æ–∫.</li>';
        } else {
            list.innerHTML = recommendations.join('');
        }
    }
    
    // --- HISTORY & UTILITY ---
    
    function renderHistory() {
        const body = document.getElementById('historyBody');
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        body.innerHTML = '';
        
        let totalProfit = 0;

        history.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort descending by date
        
        history.forEach((session, index) => {
            const date = new Date(session.date).toLocaleDateString('ru-RU');
            totalProfit += session.profit;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${date}</td>
                <td>${session.turnover.toLocaleString('ru-RU')}</td>
                <td class="history-profit">${session.profit.toLocaleString('ru-RU')}</td>
            `;
            row.onclick = () => showHistoryDetails(session);
            body.appendChild(row);
        });
        
        document.getElementById('totalHistoryProfit').textContent = totalProfit.toFixed(2).toLocaleString('ru-RU');
    }

    function showHistoryDetails(session) {
        let details = `–û—Ç—á–µ—Ç: ${new Date(session.date).toLocaleString('ru-RU')}\n\n`;
        details += `–û–±—â–∏–π –û–±–æ—Ä–æ—Ç: ${session.turnover.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–¢–∞–∑–∞ –ü–∞–π–¥–∞: ${session.profit.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: ${session.expenses.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–ñ–∞“£—ã –°–ø—Ä–µ–¥: ${session.newSpread.toFixed(2)}%\n`;
        details += `______________________\n`;
        details += `–ë–∞–Ω–∫—Ç–∞—Ä –±–æ—é–Ω—á–∞ –û–±–æ—Ä–æ—Ç:\n`;
        
        session.banks.forEach(bank => {
            details += `\n${bank.name}:\n`;
            details += `  –ö–∏—Ä–∏—à: ${bank.income.toLocaleString('ru-RU')}\n`;
            details += `  –ß—ã–≥—ã—à: ${bank.outcome.toLocaleString('ru-RU')}\n`;
            details += `  –ö“Ø–Ω. –ö–∞–ª–¥—ã–∫: ${bank.remainingDaily.toLocaleString('ru-RU')}\n`;
            details += `  –ê–π–ª—ã–∫ –û–±–æ—Ä–æ—Ç: ${bank.monthlyTurnover.toLocaleString('ru-RU')}\n`;
        });
        
        alert(details);
    }
    
    function clearHistory() {
        if (confirm("–ë–∞—Ä–¥—ã–∫ —Ç–∞—Ä—ã—Ö—Ç—ã (–ò—Å—Ç–æ—Ä–∏—è) ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã? –ë—É–ª –∞—Ä–∞–∫–µ—Ç—Ç–∏ –∫–∞–π—Ç–∞—Ä—É—É –º“Ø–º–∫“Ø–Ω —ç–º–µ—Å.")) {
            localStorage.removeItem(STORAGE_HISTORY);
            renderHistory();
            showToast("–¢–∞—Ä—ã—Ö ”©—á“Ø—Ä“Ø–ª–¥“Ø. üóëÔ∏è");
        }
    }

    function resetCurrentDay() {
        if (confirm("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω–¥“Ø–Ω –±–∞—Ä–¥—ã–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä—ã–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            bankLimits.forEach(bank => {
                bank.income = 0;
                bank.outcome = 0;
            });
            transactionLog = [];
            PERSONAL_EXPENSE_TODAY = 0;
            
            // Re-load monthly turnover to undo turnover update
            loadGlobalSettings();
            
            saveState();
            showToast("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. ‚Ü©Ô∏è");
        }
    }

    function clearAllData() {
        if (confirm("‚ö†Ô∏è –ö–û–û–ü–¢–£–£ –ó–û–ù–ê: –ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã, —Ç–∞—Ä—ã—Ö—Ç—ã, –ª–∏–º–∏—Ç—Ç–µ—Ä–¥–∏ –∂–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä–¥—ã —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.clear();
            init(); 
            showToast("–ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø. üî•", 'danger');
        }
    }
    
    function exportHistoryToCSV() {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        if (history.length === 0) {
            showToast("–≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω —Ç–∞—Ä—ã—Ö –∂–æ–∫.", 'warning');
            return;
        }

        let csv = '–î–∞—Ç–∞,–û–±—â–∏–π –û–±–æ—Ä–æ—Ç (–°–æ–º),–¢–∞–∑–∞ –ü–∞–π–¥–∞ (–°–æ–º),–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–æ–º),–ñ–∞“£—ã –°–ø—Ä–µ–¥ (%),–≠—Å–∫–∏ –°–ø—Ä–µ–¥ (%),–ö–∞–ª–¥—ã–∫ (–°–æ–º)\n';

        history.forEach(session => {
            const date = new Date(session.date).toLocaleString('ru-RU');
            csv += `"${date}",${session.turnover},${session.profit},${session.expenses},${session.newSpread},${session.oldSpread},${session.remainingAmount}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `p2p_history_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast("–¢–∞—Ä—ã—Ö CSV —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ —ç–∫—Å–ø–æ—Ä—Ç—Ç–æ–ª–¥—É. üíæ");
    }

    // --- SYNC/EXPORT/IMPORT ---

    function exportDataCode() {
        const data = {
            currentData: localStorage.getItem(STORAGE_CURRENT_DATA),
            history: localStorage.getItem(STORAGE_HISTORY),
            settings: localStorage.getItem(STORAGE_SETTINGS),
            monthlyTurnover: localStorage.getItem(STORAGE_MONTHLY_TURNOVER),
            lastDate: localStorage.getItem(STORAGE_LAST_DATE),
            expense: localStorage.getItem(STORAGE_PERSONAL_EXPENSE),
            log: localStorage.getItem(STORAGE_TRANSACTION_LOG)
        };
        document.getElementById('syncInput').value = JSON.stringify(data, null, 2);
        showToast("–ö–æ–¥ –¥–∞—è—Ä. –ö”©—á“Ø—Ä“Ø–ø –∞–ª—ã“£—ã–∑. üìù");
    }

    function importDataCode() {
        const code = document.getElementById('syncInput').value.trim();
        if (!code) {
            showToast("–ò–º–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω –∫–æ–¥–¥—É —á–∞–ø—Ç–∞“£—ã–∑.", 'danger');
            return;
        }

        if (!confirm("–≠–°–ö–ï–†–¢“Æ“Æ: –ò–º–ø–æ—Ä—Ç—Ç–æ–æ —É—á—É—Ä–¥–∞–≥—ã –±–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∞–ª–º–∞—à—Ç—ã—Ä–∞—Ç. –£–ª–∞–Ω—Ç–∞—Å—ã–∑–±—ã?")) {
            return;
        }

        try {
            const data = JSON.parse(code);
            
            // Check if it's a valid export format
            if (!data.currentData || !data.settings) {
                 showToast("–¢—É—É—Ä–∞ —ç–º–µ—Å —Ñ–æ—Ä–º–∞—Ç—Ç–∞–≥—ã –∫–æ–¥.", 'danger');
                 return;
            }

            localStorage.setItem(STORAGE_CURRENT_DATA, data.currentData);
            localStorage.setItem(STORAGE_HISTORY, data.history);
            localStorage.setItem(STORAGE_SETTINGS, data.settings);
            localStorage.setItem(STORAGE_MONTHLY_TURNOVER, data.monthlyTurnover);
            localStorage.setItem(STORAGE_LAST_DATE, data.lastDate);
            localStorage.setItem(STORAGE_PERSONAL_EXPENSE, data.expense);
            localStorage.setItem(STORAGE_TRANSACTION_LOG, data.log);

            loadState();
            renderSettings();
            renderHistory();
            document.getElementById('syncInput').value = '';
            showToast("–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∏–º–ø–æ—Ä—Ç—Ç–æ–ª–¥—É. üíæ");

        } catch (e) {
            showToast("–ö–æ–¥–¥—É —Ç–∞–ª–¥–æ–æ–¥–æ –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏. –§–æ—Ä–º–∞—Ç—Ç—ã —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑.", 'danger');
            console.error(e);
        }
    }
    
    // --- UTILITY ---
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        toast.textContent = message;
        
        // V20.1 FIX: Directly using hex/rgb colors instead of CSS variables in JS for simplicity
        if (type === 'danger') {
             toast.style.backgroundColor = '#dc3545'; 
        } else if (type === 'warning') {
             toast.style.backgroundColor = '#ffc107'; 
        } else {
             toast.style.backgroundColor = '#333';
        }

        toast.classList.add('toast-show');
        setTimeout(() => {
            toast.classList.remove('toast-show');
        }, 3000);
    }
    
    let sortDirection = {};

    function sortTable(columnIndex) {
        const tableBody = document.getElementById('trackerBody');
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        const isNumeric = columnIndex !== 0; // Assuming column 0 (Bank Name) is not numeric

        const key = columnIndex;
        const currentDir = sortDirection[key] === 'asc' ? 'desc' : 'asc';

        rows.sort((a, b) => {
            let aValue;
            let bValue;

            if (columnIndex === 7) { // Status/Remaining column (use data-sort attribute)
                 aValue = parseFloat(a.cells[columnIndex].getAttribute('data-sort'));
                 bValue = parseFloat(b.cells[columnIndex].getAttribute('data-sort'));
            } else if (isNumeric) {
                // Remove non-numeric characters (like ' ' or ',') for numeric columns, except for the last one (Status)
                aValue = parseFloat(a.cells[columnIndex].textContent.replace(/[^0-9.-]+/g, ""));
                bValue = parseFloat(b.cells[columnIndex].textContent.replace(/[^0-9.-]+/g, ""));
            } else {
                aValue = a.cells[columnIndex].textContent.toLowerCase();
                bValue = b.cells[columnIndex].textContent.toLowerCase();
            }

            if (isNumeric) {
                return currentDir === 'asc' ? aValue - bValue : bValue - aValue;
            } else {
                if (aValue < bValue) return currentDir === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentDir === 'asc' ? 1 : -1;
                return 0;
            }
        });

        // Re-append rows to the table body in the sorted order
        rows.forEach(row => tableBody.appendChild(row));
        
        // Update sort direction
        sortDirection = { [key]: currentDir };
    }

</script>
</body>
</html>