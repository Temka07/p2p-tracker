<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P –ì–∏–±—Ä–∏–¥–Ω—ã–π –¢—Ä–µ–∫–µ—Ä V9 (–û“£–¥–æ–ª–≥–æ–Ω)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 15px; background-color: #e8ecf4; }
        .container { max-width: 950px; margin: auto; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px;}
        h1 { color: #1e3a8a; text-align: center; border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 25px; }
        h2 { color: #1e3a8a; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 25px; }
        /* Transaction Form Styles */
        .transaction-form { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; border: 2px solid #ef4444; border-radius: 10px; margin-bottom: 25px; background-color: #fef2f2; }
        .transaction-form input, .transaction-form select, .transaction-form button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
        .transaction-form button { background-color: #ef4444; color: white; font-weight: bold; cursor: pointer; flex-grow: 1; transition: background-color 0.3s; }
        .transaction-form button:hover { background-color: #dc2626; }
        .close-session-btn { background-color: #10b981 !important; }
        .close-session-btn:hover { background-color: #047857 !important; }
        .export-btn { background-color: #007bff !important; margin-top: 10px; }
        .export-btn:hover { background-color: #0056b3 !important; }
        .settings-btn { background-color: #f97316 !important; margin-top: 10px; }
        .settings-btn:hover { background-color: #ea580c !important; }
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 12px 6px; text-align: center; border: 1px solid #e5e7eb; }
        th { background-color: #3b82f6; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #f3f4f6; }
        .status-cell { font-weight: bold; border-left: 4px solid transparent; }
        .status-ok { background-color: #d1fae5; color: #065f46; border-left-color: #065f46; }
        .status-danger { background-color: #fee2e2; color: #991b1b; border-left-color: #991b1b; }
        .status-rest { background-color: #6366f1; color: white; font-size: 0.9em; padding: 4px; border-radius: 6px; display: inline-block; }
        .profit-box { margin-top: 20px; padding: 20px; border: 2px solid #10b981; border-radius: 10px; background-color: #ecfdf5; text-align: center; }
        .profit-value { font-size: 2em; font-weight: bold; color: #047857; }
        .history-section { margin-top: 40px; }
        .history-table th { background-color: #555; }
        .history-table td { background-color: #f9fafb; }
        .history-profit { color: #047857; font-weight: bold; }
        #settingsSection { border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-top: 20px; background-color: #fffbeb; }
        .settings-form { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        .settings-table input { width: 100%; text-align: center; }
        .add-bank-form { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        
        .utility-buttons { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        .utility-buttons button { background-color: #6b7280; color: white; padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; }
        .utility-buttons button:hover { background-color: #4b5563; }
    </style>
</head>
<body onload="init()">

<div class="container">
    <h1>P2P –ì–∏–±—Ä–∏–¥–Ω—ã–π –¢—Ä–µ–∫–µ—Ä V9 (–û“£–¥–æ–ª–≥–æ–Ω)</h1>

    <div class="transaction-form">
        <select id="actionType" style="flex-basis: 150px;">
            <option value="income">–ü—Ä–æ–¥–∞–∂–∞ (–ü—Ä–∏—Ö–æ–¥)</option>
            <option value="outcome">–ü–æ–∫—É–ø–∫–∞ (–†–∞—Å—Ö–æ–¥)</option>
        </select>
        <input type="number" id="transactionAmount" placeholder="–°—É–º–º–∞ (–°–æ–º)" style="flex-basis: 150px;">
        <select id="transactionBank" style="flex-basis: 150px;"></select>
        <button onclick="logTransaction()">–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –°–¥–µ–ª–∫—É</button>
        <button onclick="closeSession()" class="close-session-btn">‚úîÔ∏è –ó–ê–ö–´–¢ –°–ú–ï–ù–£ & –°–û–•–†–ê–ù–ò–¢–¨</button>
        <div class="utility-buttons" style="width: 100%; justify-content: space-between;">
            <button onclick="resetCurrentDay()">‚Ü©Ô∏è –£—á—É—Ä–¥–∞–≥—ã –ö“Ø–Ω–¥“Ø –¢–∞–∑–∞–ª–æ–æ</button>
            <button onclick="toggleSettings()" class="settings-btn" style="flex-grow: 0;">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
    </div>

    <div id="settingsSection" style="display:none;">
        <h2>üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –õ–∏–º–∏—Ç–æ–≤ –∏ –ö—É—Ä—Å–æ–≤</h2>
        <div class="settings-form">
            <label>BUY Rate (USD): <input type="number" id="settingBuyRate" step="0.01"></label>
            <label>Spread (%): <input type="number" id="settingSpread" step="0.01"></label>
            <label>–®—Ç—Ä–∞—Ñ (%): <input type="number" id="settingPenalty" step="0.01" disabled title="–ê–∑—ã—Ä–∫—ã –≤–µ—Ä—Å–∏—è–¥–∞ –∫–æ–ª–¥–æ–Ω—É–ª–±–∞–π—Ç"></label>
            <button onclick="updateSettings()" class="export-btn" style="flex-grow: 0;">–°–û–•–†–ê–ù–ò–¢–¨ –í–°–ï</button>
        </div>
        
        <table class="settings-table">
            <thead>
                <tr>
                    <th>–ë–∞–Ω–∫</th>
                    <th>–ë–∞–∑–æ–≤—ã–π –õ–∏–º–∏—Ç (–°–æ–º)</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="settingsBody">
                </tbody>
        </table>

        <div class="add-bank-form">
            <input type="text" id="newBankName" placeholder="–ñ–∞“£—ã –ë–∞–Ω–∫ –ê—Ç—ã">
            <input type="number" id="newBankLimit" placeholder="–õ–∏–º–∏—Ç (–°–æ–º)">
            <button onclick="addBank()" class="close-session-btn" style="flex-grow: 1;">+ –ë–ê–ù–ö –ö–û–®–£–£</button>
        </div>
    </div>
    <div class="notes">
        <h3>–ö“Ø–Ω“Ø–º–¥“Ø–∫ –ú–∞–∞–ª—ã–º–∞—Ç (–°–µ–≥–æ–¥–Ω—è)</h3>
        <p>‚ö†Ô∏è –≠–†–ï–ñ–ï: –≠–≥–µ—Ä –±–∞–Ω–∫—Ç—ã–Ω –∫“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç–∏ –∞—à—ã–ø –∫–µ—Ç—Å–µ, –∞—à–∫–∞–Ω —Å—É–º–º–∞–≥–∞ –∂–∞—Ä–∞—à–∞ –∫–µ—Ä–µ–∫—Ç“Ø“Ø –∫“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç—Ç–µ—Ä–¥–∏ –∂–∞–±—É—É “Ø—á“Ø–Ω **"–û–¢–î–´–•–ê–ï–¢"** —Å—Ç–∞—Ç—É—Å—É–Ω–∞ ”©—Ç”©—Ç.</p>
    </div>

    <table>
        <thead>
            <tr>
                <th>–ë–∞–Ω–∫</th>
                <th>–ú–∞–∫—Å. –õ–∏–º–∏—Ç (–°–æ–º)</th>
                <th>–ü—Ä–∏—Ö–æ–¥ (–í—Ö.)</th>
                <th>–†–∞—Å—Ö–æ–¥ (–ò—Å—Ö.)</th>
                <th>–û–±—â–∏–π –û–±–æ—Ä–æ—Ç</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫ / –°–¢–ê–¢–£–°</th>
            </tr>
        </thead>
        <tbody id="trackerBody">
        </tbody>
        <tfoot>
            <tr class="total-row">
                <th colspan="2">–û–ë–©–ò–ô –ò–¢–û–ì –î–ù–Ø</th>
                <th id="totalIncome">0</th>
                <th id="totalOutcome">0</th>
                <th id="totalTurnover">0</th>
                <th id="totalRemaining">0</th>
            </tr>
        </tfoot>
    </table>
    
    <div class="profit-box">
        <h2>üí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è –î–Ω–µ–≤–Ω–∞—è –ü—Ä–∏–±—ã–ª—å (–°–ø—Ä–µ–¥: <span id="spreadDisplay">0.5%</span>)</h2>
        <div class="profit-value" id="estimatedProfit">0.00 –°–æ–º</div>
        <p style="font-size: 0.8em; color: #555;">(–≠—Å–µ–ø—Ç”©”©: –û–±—â–∏–π –û–±–æ—Ä–æ—Ç / <span id="buyRateDisplay">88.0</span> * <span id="spreadValueDisplay">0.005</span>)</p>
    </div>
    
    <div class="history-section">
        <h2 id="historyHeader">üìä –¢–∞—Ä—ã—Ö (–ò—Å—Ç–æ—Ä–∏—è)</h2>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button onclick="exportHistoryToCSV()" class="export-btn" style="margin: 0;">üíæ Excel'–≥–µ —Å–∞–∫—Ç–æ–æ (CSV)</button>
            <span style="font-size: 0.9em; color: #555;">*–¢–∞—Ä—ã—Ö—Ç—ã –∫”©—Ä“Ø“Ø “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –±–∞—Å—ã“£—ã–∑</span>
        </div>
        
        <table class="history-table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–û–±—â–∏–π –û–±–æ—Ä–æ—Ç</th>
                    <th>–ü—Ä–∏—Ö–æ–¥ (–í—Ö.)</th>
                    <th>–†–∞—Å—Ö–æ–¥ (–ò—Å—Ö.)</th>
                    <th>–ü–∞–π–¥–∞ (–ß–∏—Å—Ç–∞—è)</th>
                </tr>
            </thead>
            <tbody id="historyBody">
                <tr><td colspan="5">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const STORAGE_CURRENT_DATA = 'p2p_tracker_v9_data';
    const STORAGE_HISTORY = 'p2p_history_v9';
    const STORAGE_LAST_DATE = 'p2p_last_session_date';
    const STORAGE_SETTINGS = 'p2p_settings_v9';
    
    let BUY_RATE = 88.0;
    let SPREAD = 0.5; 
    let PENALTY_PERCENTAGE = 0.20; 

    const RISK_TIER_2_DAYS = 50000; 
    const RISK_TIER_3_DAYS = 100000; 
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    let STARTING_LIMITS = {
        "Optima24": 35000, "DemirBank": 25000, "KICB": 25000, 
        "Mbank": 20000, "BaKai": 20000, "–ú–æ–π –û! –ë–∞–Ω–∫": 20000, 
        "–ö–æ–º–ø–∞–Ω—å–æ–Ω": 20000, "SimBank": 11000
    };

    let bankLimits = [];

    // --- –£—Ç–∏–ª–∏—Ç—ã ---

    function saveGlobalSettings() {
        const settings = {
            buyRate: BUY_RATE,
            spread: SPREAD,
            penalty: PENALTY_PERCENTAGE,
            startingLimits: STARTING_LIMITS
        };
        localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
    }

    function loadGlobalSettings() {
        const storedSettings = localStorage.getItem(STORAGE_SETTINGS);
        if (storedSettings) {
            const settings = JSON.parse(storedSettings);
            BUY_RATE = settings.buyRate || 88.0;
            SPREAD = settings.spread || 0.5;
            PENALTY_PERCENTAGE = settings.penalty || 0.20;
            STARTING_LIMITS = settings.startingLimits || STARTING_LIMITS;
        }
    }

    function syncBankLimits() {
        const updatedBankLimits = [];

        for (const name in STARTING_LIMITS) {
            const baseLimit = STARTING_LIMITS[name];
            let existingBank = bankLimits.find(b => b.name === name);
            
            if (existingBank) {
                existingBank.baseLimit = baseLimit;
                existingBank.limit = baseLimit; 
                updatedBankLimits.push(existingBank);
            } else {
                updatedBankLimits.push({ name: name, limit: baseLimit, income: 0, outcome: 0, restingUntil: null, baseLimit: baseLimit });
            }
        }
        
        bankLimits = updatedBankLimits.filter(bank => STARTING_LIMITS[bank.name] !== undefined);
    }
    
    function loadState() {
        loadGlobalSettings(); 
        
        const storedData = localStorage.getItem(STORAGE_CURRENT_DATA);
        if (storedData) {
            bankLimits = JSON.parse(storedData);
        }

        syncBankLimits();
    }

    function saveState() {
        STARTING_LIMITS = {};
        bankLimits.forEach(bank => {
            STARTING_LIMITS[bank.name] = bank.baseLimit;
        });

        saveGlobalSettings();
        localStorage.setItem(STORAGE_CURRENT_DATA, JSON.stringify(bankLimits));
        localStorage.setItem(STORAGE_LAST_DATE, new Date().toISOString());
    }

    // --- –ù–ê–°–¢–†–û–ô–ö–ê –§–£–ù–ö–¶–ò–Ø–õ–ê–†–´ ---
    // (V8–¥–µ–Ω ”©–∑–≥”©—Ä“Ø“Ø—Å“Ø–∑ –∫–∞–ª–¥—ã)
    function toggleSettings() {
        const settingsDiv = document.getElementById('settingsSection');
        if (settingsDiv.style.display === 'none') {
            renderSettings();
            settingsDiv.style.display = 'block';
        } else {
            settingsDiv.style.display = 'none';
        }
    }

    function renderSettings() {
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;
        document.getElementById('settingPenalty').value = PENALTY_PERCENTAGE * 100;

        const settingsBody = document.getElementById('settingsBody');
        settingsBody.innerHTML = '';

        bankLimits.forEach(bank => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${bank.name}" data-bank-name="${bank.name}" class="bank-name-input"></td>
                <td><input type="number" value="${bank.baseLimit}" data-bank-limit="${bank.name}" class="bank-limit-input"></td>
                <td><button onclick="removeBank('${bank.name}')" style="background-color: #dc2626; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">”®—á“Ø—Ä“Ø“Ø</button></td>
            `;
            settingsBody.appendChild(row);
        });
    }

    function updateSettings() {
        const newBuyRate = parseFloat(document.getElementById('settingBuyRate').value);
        const newSpread = parseFloat(document.getElementById('settingSpread').value);

        if (isNaN(newBuyRate) || isNaN(newSpread) || newBuyRate <= 0) {
            alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä–¥–∞–≥—ã –º–∞–∞–Ω–∏–ª–µ—Ä —Ç—É—É—Ä–∞ —ç–º–µ—Å!");
            return;
        }

        BUY_RATE = newBuyRate;
        SPREAD = newSpread;

        const updatedLimits = {};
        const nameInputs = document.querySelectorAll('.bank-name-input');
        const limitInputs = document.querySelectorAll('.bank-limit-input');

        nameInputs.forEach((nameInput, index) => {
            const newName = nameInput.value.trim();
            const newLimit = parseInt(limitInputs[index].value);

            if (newName && !isNaN(newLimit) && newLimit > 0) {
                updatedLimits[newName] = newLimit;
            }
        });
        
        STARTING_LIMITS = updatedLimits;
        syncBankLimits(); 

        saveState(); 
        renderTable();
        renderBankOptions();
        renderSettings(); 
        alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø —Å–∞–∫—Ç–∞–ª–¥—ã!");
    }

    function addBank() {
        const name = document.getElementById('newBankName').value.trim();
        const limit = parseInt(document.getElementById('newBankLimit').value);

        if (!name || isNaN(limit) || limit <= 0) {
            alert("–ë–∞–Ω–∫—Ç—ã–Ω –∞—Ç—ã–Ω –∂–∞–Ω–∞ —Ç—É—É—Ä–∞ –ª–∏–º–∏—Ç–∏–Ω –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }

        if (STARTING_LIMITS[name] !== undefined) {
            alert("–ú—ã–Ω–¥–∞–π –∞—Ç –º–µ–Ω–µ–Ω –±–∞–Ω–∫ –º—É—Ä—É–Ω—Ç–∞–Ω —ç–ª–µ –±–∞—Ä.");
            return;
        }

        STARTING_LIMITS[name] = limit;
        syncBankLimits(); 

        document.getElementById('newBankName').value = '';
        document.getElementById('newBankLimit').value = '';

        saveState();
        renderTable();
        renderBankOptions();
        renderSettings();
        alert(`–ë–∞–Ω–∫ '${name}' ${limit} —Å–æ–º –ª–∏–º–∏—Ç–∏ –º–µ–Ω–µ–Ω –∫–æ—à—É–ª–¥—É.`);
    }

    function removeBank(name) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–∞–Ω–∫ ${name}? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–±–æ—Ä–æ—Ç—É —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) {
            return;
        }
        
        delete STARTING_LIMITS[name];
        syncBankLimits(); 

        saveState();
        renderTable();
        renderBankOptions();
        renderSettings();
        alert(`–ë–∞–Ω–∫ ${name} ”©—á“Ø—Ä“Ø–ª–¥“Ø.`);
    }

    // --- –ù–ï–ì–ò–ó–ì–ò –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê ---
    function applyLimitAdjustment(bank) {
        const turnover = bank.income + bank.outcome;
        const baseLimit = bank.baseLimit;
        
        if (baseLimit === 0) return;
        
        const exceededAmount = turnover - baseLimit;

        if (exceededAmount > 0) {
            // –ê—à—ã–ø –∫–µ—Ç–∫–µ–Ω —Å—É–º–º–∞–Ω—ã –∂–∞–±—É—É “Ø—á“Ø–Ω –∫–µ—Ä–µ–∫—Ç–µ–ª–≥–µ–Ω –ª–∏–º–∏—Ç—Ç–∏–Ω —Å–∞–Ω—ã–Ω —ç—Å–µ–ø—Ç”©”©
            const daysToRest = Math.ceil(exceededAmount / baseLimit);

            if (daysToRest > 0) {
                const restDate = new Date();
                restDate.setDate(restDate.getDate() + daysToRest);
                bank.restingUntil = restDate.toISOString();
            }
        } 
        bank.limit = baseLimit; 
    }
    
    function logTransaction() {
        const actionType = document.getElementById('actionType').value;
        const amount = parseFloat(document.getElementById('transactionAmount').value);
        const bankName = document.getElementById('transactionBank').value;

        if (!amount || amount <= 0 || !bankName) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫.");
            return;
        }

        const bankIndex = bankLimits.findIndex(b => b.name === bankName);
        if (bankIndex === -1) return;

        const bank = bankLimits[bankIndex];
        const now = new Date();

        // –û—Ç–¥—ã—Ö —Ç–µ–∫—à–µ—Ä“Ø“Ø (–≠–≥–µ—Ä –¥–µ–º –∞–ª—ã–ø –∂–∞—Ç—Å–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ª–æ–≥–∏—Ä–ª”©”©–≥”© –±–æ–ª–±–æ–π—Ç)
        let isResting = false;
        if (bank.restingUntil) {
            const restDate = new Date(bank.restingUntil);
            if (restDate > now) {
                isResting = true;
            } else {
                bank.restingUntil = null; 
            }
        }
        
        if (isResting || bank.limit <= 0) {
            alert(`‚õîÔ∏è ${bankName} –±–∞–Ω–∫—ã –∞–∑—ã—Ä –ª–∏–º–∏—Ç—Ç–∏ –∞—à—ã–ø –∫–µ—Ç–∫–µ–Ω–¥–∏–∫—Ç–µ–Ω –∂–µ —á–æ“£ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–¥–∞–Ω –∫–∏–π–∏–Ω "–û–¢–î–´–•–ê–ï–¢". –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ª–æ–≥–∏—Ä–ª”©”© –º“Ø–º–∫“Ø–Ω —ç–º–µ—Å.`);
            return;
        }
        
        // –õ–∏–º–∏—Ç—Ç–∏ —Ç–µ–∫—à–µ—Ä“Ø“Ø (—ç–≥–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–¥–∞–Ω –∫–∏–π–∏–Ω –∞—à—ã–ø –∫–µ—Ç—Å–µ)
        const turnoverAfter = bank.income + bank.outcome + amount;
        if (turnoverAfter > bank.baseLimit) {
            // –≠—Å–∫–µ—Ä—Ç“Ø“Ø, –±–∏—Ä–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–≥–∞ –∂–æ–ª –±–µ—Ä“Ø“Ø (—Å–µ–±–µ–±–∏ –ª–∏–º–∏—Ç –∞—à—ã–ø –∫–µ—Ç“Ø“Ø - –±—É–ª –∂–∞–∑–∞–ª–æ–æ “Ø—á“Ø–Ω –≥–∞–Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä)
            console.warn(`[WARNING] ${bankName} –ª–∏–º–∏—Ç–∏ –∞—à—ã–ø –∫–µ—Ç—Ç–∏. –°–º–µ–Ω–∞–Ω—ã –∂–∞–±—É—É –∫–µ—Ä–µ–∫.`);
        }

        if (actionType === 'income') {
            bank.income += amount;
        } else {
            bank.outcome += amount;
        }

        // –ê–≤—Ç–æ-–æ—Ç–¥—ã—Ö (–ß–æ“£ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–¥–∞–Ω –∫–∏–π–∏–Ω) 
        let daysToRest = 0;
        if (amount >= RISK_TIER_3_DAYS) {
            daysToRest = 3; 
        } else if (amount >= RISK_TIER_2_DAYS) {
            daysToRest = 2; 
        }
        
        if (daysToRest > 0) {
            const restDate = new Date();
            restDate.setDate(restDate.getDate() + daysToRest);
            bank.restingUntil = restDate.toISOString();
            alert(`üö® –í–ù–ò–ú–ê–ù–ò–ï! –°–¥–µ–ª–∫–∞ (${amount.toLocaleString('ru-RU')} —Å–æ–º) –Ω–∞ ${bankName}. –ë–∞–Ω–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ ${daysToRest} –¥–Ω—è(–µ–π) –æ—Ç–¥—ã—Ö–∞!`);
        }

        document.getElementById('transactionAmount').value = '';
        saveState();
        renderTable();
    }
    
    function closeSession() {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ó–ê–ö–´–¢ –°–ú–ï–ù–£? –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –ª–∏–º–∏—Ç—ã –±—É–¥—É—Ç –∂–∞–∑–∞–ª–∞–Ω–≥–∞–Ω.")) {
            return;
        }
        
        const totals = getTotals();
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        const lastSessionDateString = localStorage.getItem(STORAGE_LAST_DATE);
        
        if (lastSessionDateString && isSameDay(new Date(lastSessionDateString), new Date())) {
            alert("–°–º–µ–Ω–∞ —É–∂–µ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ —Å–µ–≥–æ–¥–Ω—è. –ó–∞–ø–∏—Å—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.");
            return;
        }

        bankLimits.forEach(applyLimitAdjustment);
        
        history.push({
            date: formatDate(new Date().toISOString()),
            turnover: totals.turnover,
            income: totals.income,
            outcome: totals.outcome,
            profit: totals.profit
        });
        
        localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));
        
        clearCurrentDayData(); 
        saveState(); 
        renderTable();
        renderHistory();
        alert(`–°–º–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞! –ü–∞–π–¥–∞: ${totals.profit.toFixed(2).toLocaleString('ru-RU')} —Å–æ–º. –ñ–∞–∑–∞–ª–æ–æ (–æ—Ç–¥—ã—Ö) —ç—Å–µ–ø—Ç–µ–ª–¥–∏.`);
    }

    // --- –°–£–ù–£–®–¢–ê–õ–ì–ê–ù –§–£–ù–ö–¶–ò–Ø: –£—á—É—Ä–¥–∞–≥—ã –ö“Ø–Ω–¥“Ø –¢–∞–∑–∞–ª–æ–æ (Reset) ---
    function resetCurrentDay() {
        if (!confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ò —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è? (–õ–∏–º–∏—Ç—ã –∏ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –±—É–¥—É—Ç –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã).")) {
            return;
        }
        
        clearCurrentDayData();
        saveState();
        renderTable();
        alert("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω–¥“Ø–Ω –±–∞—Ä–¥—ã–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä—ã –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø —Ç–∞–∑–∞–ª–∞–Ω–¥—ã.");
    }

    // --- –û“¢–î–û–õ–ì–û–ù –§–£–ù–ö–¶–ò–Ø: –ë–∞–Ω–∫—Ç–∞—Ä–¥—ã –∫”©—Ä—Å”©—Ç“Ø“Ø ---
    function renderBankOptions() {
        const select = document.getElementById('transactionBank');
        select.innerHTML = '<option value="">--- –ë–∞–Ω–∫ –¢–∞–Ω–¥–æ–æ ---</option>';
        
        // STARTING_LIMITS'—Ç–µ–≥–∏ –∞—Ä –±–∏—Ä –±–∞–Ω–∫—Ç—ã –æ–ø—Ü–∏—è –∫–∞—Ç–∞—Ä—ã –∫–æ—à—É—É
        for (const name in STARTING_LIMITS) {
             const option = document.createElement('option');
             option.value = name;
             option.textContent = name;
             select.appendChild(option);
        }
    }

    function renderTable() {
        const trackerBody = document.getElementById('trackerBody');
        trackerBody.innerHTML = '';
        let grandTotalIncome = 0;
        let grandTotalOutcome = 0;
        let currentTotalLimit = 0;

        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            let currentLimit = bank.baseLimit; 
            
            const now = new Date();
            let isResting = false;
            let statusText = '';
            let statusClass = 'status-ok';

            if (bank.restingUntil) {
                const restDate = new Date(bank.restingUntil);
                if (restDate > now) {
                    const daysLeft = Math.ceil((restDate - now) / MS_PER_DAY);
                    statusText = `<span class="status-rest">–û–¢–î–´–•–ê–ï–¢ (${daysLeft} –¥–Ω. –ñ–ê–ë–£–£)</span>`;
                    statusClass = '';
                    isResting = true;
                    currentLimit = 0; 
                } else {
                    bank.restingUntil = null; 
                    saveState();
                }
            }
            
            const remaining = currentLimit - turnover;
            currentTotalLimit += currentLimit;

            if (!isResting) {
                if (remaining <= 0) {
                    statusText = "–õ–∏–º–∏—Ç –ò—Å—á–µ—Ä–ø–∞–Ω!";
                    statusClass = 'status-danger';
                } else {
                    statusText = remaining.toLocaleString('ru-RU');
                    statusClass = 'status-ok';
                }
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${bank.name}</td>
                <td>${currentLimit.toLocaleString('ru-RU')}</td>
                <td>${bank.income.toLocaleString('ru-RU')}</td>
                <td>${bank.outcome.toLocaleString('ru-RU')}</td>
                <td>${turnover.toLocaleString('ru-RU')}</td>
                <td class="${statusClass}">${statusText}</td>
            `;

            trackerBody.appendChild(row);

            grandTotalIncome += bank.income;
            grandTotalOutcome += bank.outcome;
        });

        const grandTotalTurnover = grandTotalIncome + grandTotalOutcome;
        
        document.getElementById('totalIncome').textContent = grandTotalIncome.toLocaleString('ru-RU');
        document.getElementById('totalOutcome').textContent = grandTotalOutcome.toLocaleString('ru-RU');
        document.getElementById('totalTurnover').textContent = grandTotalTurnover.toLocaleString('ru-RU');
        // –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ - –±—É–ª –∂–µ—Ä–¥–µ –∂–∞–ª–ø—ã –ª–∏–º–∏—Ç –∫”©—Ä—Å”©—Ç“Ø–ª”©—Ç
        document.getElementById('totalRemaining').textContent = currentTotalLimit.toLocaleString('ru-RU'); 

        const estimatedProfit = (grandTotalTurnover / BUY_RATE) * (SPREAD / 100);
        document.getElementById('estimatedProfit').textContent = estimatedProfit.toFixed(2).toLocaleString('ru-RU') + ' –°–æ–º';
        document.getElementById('spreadDisplay').textContent = `${SPREAD}%`;
        document.getElementById('buyRateDisplay').textContent = BUY_RATE.toFixed(2);
        document.getElementById('spreadValueDisplay').textContent = (SPREAD / 100).toFixed(4);
    }

    // --- –¢–∞—Ä—ã—Ö—Ç—ã –∫”©—Ä—Å”©—Ç“Ø“Ø (–∫–ª–∏–∫—Ç–µ —Ç–∞—Ä—ã—Ö—Ç—ã –∫”©—Ä“Ø“Ø —Ñ—É–Ω–∫—Ü–∏—è—Å—ã –∫–æ—à—É–ª–¥—É) ---
    function renderHistory() {
        const historyBody = document.getElementById('historyBody');
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        
        historyBody.innerHTML = '';

        if (history.length === 0) {
              historyBody.innerHTML = '<tr><td colspan="5">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.</td></tr>';
              return;
        }

        history.slice().reverse().forEach((record, index) => {
            const row = document.createElement('tr');
            // –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫”©—Ä—Å”©—Ç“Ø“Ø “Ø—á“Ø–Ω 'data-index' –∫–æ—à—É—É
            row.dataset.index = history.length - 1 - index; 
            row.style.cursor = 'pointer';
            row.onclick = function() { viewHistoryRecord(this.dataset.index); };

            row.innerHTML = `
                <td>${record.date}</td>
                <td>${record.turnover.toLocaleString('ru-RU')}</td>
                <td>${record.income.toLocaleString('ru-RU')}</td>
                <td>${record.outcome.toLocaleString('ru-RU')}</td>
                <td class="history-profit">${record.profit.toFixed(2).toLocaleString('ru-RU')}</td>
            `;
            historyBody.appendChild(row);
        });
    }

    // --- –°–£–ù–£–®–¢–ê–õ–ì–ê–ù –§–£–ù–ö–¶–ò–Ø: –¢–∞—Ä—ã—Ö—Ç—ã –∫”©—Ä“Ø“Ø ---
    function viewHistoryRecord(index) {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        const record = history[index];
        
        let details = `
            <h2>üìÖ –¢–∞—Ä—ã—Ö—ã–π –û—Ç—á–µ—Ç: ${record.date}</h2>
            <p><strong>–û–±—â–∏–π –û–±–æ—Ä–æ—Ç:</strong> ${record.turnover.toLocaleString('ru-RU')} –°–æ–º</p>
            <p><strong>–ü—Ä–∏—Ö–æ–¥ (–í—Ö.):</strong> ${record.income.toLocaleString('ru-RU')} –°–æ–º</p>
            <p><strong>–†–∞—Å—Ö–æ–¥ (–ò—Å—Ö.):</strong> ${record.outcome.toLocaleString('ru-RU')} –°–æ–º</p>
            <p><strong>–ü–∞–π–¥–∞ (–ß–∏—Å—Ç–∞—è):</strong> ${record.profit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º</p>
            <p style="font-size: 0.8em; color: #991b1b;">*–ë—É–ª —Ç–∞—Ä—ã—Ö—ã–π –º–∞–∞–ª—ã–º–∞—Ç, —É—á—É—Ä–¥–∞–≥—ã –ª–∏–º–∏—Ç—Ç–µ—Ä–≥–µ —Ç–∞–∞—Å–∏—Ä —ç—Ç–ø–µ–π—Ç.</p>
        `;
        
        alert(details.replace(/<p>/g, '\n').replace(/<\/p>/g, '').replace(/<h2>/g, '').replace(/<\/h2>/g, ''));
    }

    // --- –ö–∞–ª–≥–∞–Ω —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä ---
    function formatDate(dateString) { /* ... */ return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
    function isSameDay(date1, date2) { /* ... */ return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate(); }
    function getTotals() { /* ... */ let income = bankLimits.reduce((sum, bank) => sum + bank.income, 0); let outcome = bankLimits.reduce((sum, bank) => sum + bank.outcome, 0); let turnover = income + outcome; let profit = (turnover / BUY_RATE) * (SPREAD / 100); return { income, outcome, turnover, profit }; }
    function clearCurrentDayData() {
        bankLimits.forEach(bank => {
            bank.income = 0;
            bank.outcome = 0;
        });
        localStorage.setItem(STORAGE_LAST_DATE, new Date().toISOString());
    }
    function checkAutomaticClosure() {
        const lastDateString = localStorage.getItem(STORAGE_LAST_DATE);
        if (!lastDateString) return;

        const lastDate = new Date(lastDateString);
        const currentDate = new Date();
        
        if (!isSameDay(lastDate, currentDate)) {
            const totals = getTotals();
            const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
            
            bankLimits.forEach(applyLimitAdjustment);

            history.push({
                date: formatDate(lastDateString), 
                turnover: totals.turnover,
                income: totals.income,
                outcome: totals.outcome,
                profit: totals.profit
            });
            
            localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));
            alert(`‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ –∂–∞–±—ã–ª—É—É: –°–º–µ–Ω–∞ ${formatDate(lastDateString)} –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© –∂–∞–±—ã–ª–¥—ã. –ñ–∞–∑–∞–ª–æ–æ (–æ—Ç–¥—ã—Ö) —ç—Å–µ–ø—Ç–µ–ª–¥–∏.`);
            
            clearCurrentDayData(); 
            saveState();
        }
    }
    function exportHistoryToCSV() {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        if (history.length === 0) {
            alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
            return;
        }

        let csvContent = "–î–∞—Ç–∞;–û–±—â–∏–π –û–±–æ—Ä–æ—Ç;–ü—Ä–∏—Ö–æ–¥ (–í—Ö.);–†–∞—Å—Ö–æ–¥ (–ò—Å—Ö.);–ü–∞–π–¥–∞ (–ß–∏—Å—Ç–∞—è)\n";

        history.forEach(record => {
            csvContent += `${record.date};${record.turnover.toFixed(2)};${record.income.toFixed(2)};${record.outcome.toFixed(2)};${record.profit.toFixed(2)}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");

        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `P2P_–û—Ç—á–µ—Ç_${formatDate(new Date().toISOString())}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É.");
        }
    }
    window.exportHistoryToCSV = exportHistoryToCSV; 
    
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function init() {
        loadState();
        checkAutomaticClosure(); 
        renderBankOptions(); // –û“£–¥–æ–ª–≥–æ–Ω
        renderTable();
        renderHistory();
        document.getElementById('settingsSection').style.display = 'none'; 
    }
</script>
</body>
</html>
