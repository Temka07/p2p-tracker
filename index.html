<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Tracker V24.6 | Security & Performance</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght=400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* (CSS STYLES REMAINS UNCHANGED FROM V24.5) */
        :root {
            --bg-dark: #0f0a1d; 
            --bg-dark-gradient: linear-gradient(135deg, #0f0a1d 0%, #050308 100%);
            --accent-neon: #39FF14; 
            --accent-gold: #ffd700; 
            --primary-color: var(--accent-neon);
            --danger-color: #ff3366; 
            --success-color: #00e676; 
            --bg-card: rgba(25, 20, 45, 0.5); 
            --border-neon: 1px solid rgba(57, 255, 20, 0.5);
            --shadow-neon: 0 0 10px rgba(57, 255, 20, 0.7);
            --shadow-gold: 0 0 8px rgba(255, 215, 0, 0.8);
            --text-color: #e0e0e0;
            --section-title-bg: #e1ff00; 
            --section-title-color: #000;
        }
        
        html, body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            background: var(--bg-dark-gradient);
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            position: relative;
        }

        @keyframes network-flow {
            0% { transform: translate(0, 0) scale(1); opacity: 0.1; }
            100% { transform: translate(100px, 100px) scale(1.5); opacity: 0; }
        }

        .background-flow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            opacity: 0.5;
        }

        .network-node {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(57, 255, 20, 0.2); 
            border-radius: 50%;
            animation: network-flow 20s infinite linear alternate;
            box-shadow: 0 0 5px var(--accent-neon);
        }
        
        .container { 
            width: 100%; 
            max-width: 650px;
            margin: auto; 
            padding: 15px; 
            box-sizing: border-box; 
            font-size: 0.95em; 
            position: relative; 
            z-index: 10;
        }
        
        .app-header {
             display: flex; 
             justify-content: space-between; 
             align-items: flex-start; 
             margin-bottom: 25px;
        }
        .app-header h1 { 
            font-size: 1.1em; 
            margin-top: 0;
            margin-bottom: 5px;
            line-height: 1.2;
            font-family: 'Orbitron', sans-serif;
        }
        .app-title-version {
            font-size: 1.3em; 
            font-weight: 900;
            color: var(--accent-neon); 
            text-shadow: var(--shadow-neon); 
        }
        .app-title-nic { 
            font-size: 0.9em; 
            font-weight: 600;
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }
        #userNicDisplay {
            font-weight: 700;
            color: var(--accent-gold); 
        }
        
        .dd-section-title {
            background-color: var(--section-title-bg);
            color: var(--section-title-color);
            font-weight: 900;
            font-size: 1.2em;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px;
            margin: 25px 0 15px 0;
            text-transform: uppercase;
        }
        
        .card-block { 
             display: flex;
             flex-direction: column; 
             gap: 15px; 
             padding: 20px; 
             border-radius: 15px; 
             background-color: var(--bg-card); 
             border: var(--border-neon); 
             box-shadow: var(--shadow-neon), 0 0 20px rgba(0,0,0,0.5);
             margin-bottom: 20px; 
             backdrop-filter: blur(8px) saturate(180%);
             -webkit-backdrop-filter: blur(8px) saturate(180%);
        }
        
        input[type="number"], input[type="text"], select {
            padding: 12px 15px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 10px; 
            font-size: 1.0em; 
            width: 100%; 
            box-sizing: border-box;
            background-color: rgba(30, 20, 60, 0.7); 
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Inter', sans-serif;
        }
        
        .btn {
            padding: 10px 15px; 
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85em; 
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.4s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }
        .btn-primary { 
             background: var(--accent-neon); 
             color: var(--bg-dark); 
             box-shadow: 0 0 10px rgba(57, 255, 20, 0.7);
        }
        .btn-secondary { 
             background: rgba(255, 255, 255, 0.15);
             color: var(--text-color);
        }
        .btn-success {
             background: var(--success-color); 
             color: var(--bg-dark);
        }
        .btn-danger {
             background: var(--danger-color);
             color: #fff;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }
        
        #mobileCardView {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 15px; 
             margin-top: 15px;
        }
        .bank-card {
            padding: 15px 20px;
            border-left: 5px solid var(--accent-neon); 
            background-color: rgba(40, 30, 60, 0.7); 
            border-radius: 10px;
            transition: all 0.3s;
        }
        .card-item .success { color: var(--success-color); }
        .card-item .danger { color: var(--danger-color); }
        .card-item .item-label { color: rgba(224, 224, 224, 0.6); }

        .profit-motivation-box {
            margin-top: 25px; 
            padding: 25px; 
            background: rgba(15, 5, 30, 0.7); 
            color: var(--text-color);
            border-radius: 20px;
            box-shadow: 0 0 20px var(--accent-gold);
            text-align: center;
            border: 2px solid var(--accent-gold);
        }

        .profit-value-large { 
            font-size: 3.5em; 
            margin: 10px 0; 
            font-weight: 900;
            color: var(--accent-neon); 
            text-shadow: 0 0 10px var(--accent-neon); 
            font-family: 'Orbitron', sans-serif;
            overflow: hidden; 
            line-height: 1;
        }

        .analitics-row {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 10px 0;
            border-top: 1px dashed rgba(255, 255, 255, 0.2);
        }

        #remainingLimitDisplay {
             padding: 10px 15px;
             margin-top: 5px;
             border-radius: 8px;
             background-color: rgba(57, 255, 20, 0.1);
             font-weight: 600;
             font-size: 0.9em;
             border: 1px solid rgba(57, 255, 20, 0.5);
             color: var(--accent-neon);
             display: none; 
        }

        .toast-message {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--bg-dark);
            color: var(--text-color);
            text-align: center;
            border-radius: 10px;
            padding: 15px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 0 10px var(--accent-neon);
            border: 2px solid var(--accent-neon);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        .toast-show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        
        .history-table th, .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(224, 224, 224, 0.2);
        }
        .history-table thead th {
            background-color: rgba(57, 255, 20, 0.1);
            color: var(--accent-neon);
            font-family: 'Orbitron', sans-serif;
        }
        .history-table tbody tr:hover {
            background-color: rgba(57, 255, 20, 0.05);
            cursor: pointer;
        }
        .history-table tfoot th {
            color: var(--accent-gold);
            font-weight: 700;
        }
    </style>
</head>
<body onload="init()">

<div class="background-flow">
    <div class="network-node" style="top: 10%; left: 5%;"></div>
    <div class="network-node" style="top: 80%; left: 90%;"></div>
    <div class="network-node" style="top: 45%; left: 30%;"></div>
    <div class="network-node" style="top: 25%; left: 60%;"></div>
</div>

<div id="authSection" style="display: none; justify-content: center; align-items: center; min-height: 100vh;">
    <div class="auth-box card-block" style="text-align: center; max-width: 350px; margin: auto; margin-top: 50px;">
        <h2 id="authTitle" style="color: var(--accent-neon);">üîê –ö–ò–†“Æ“Æ</h2>
        <input type="text" id="authUsername" placeholder="–ù–∏–∫ –∞—Ç—ã“£—ã–∑ (–¢–µ–º–∏—Ä–ª–∞–Ω)" required>
        <button onclick="loginUser()" class="btn btn-primary" id="authButton" style="margin-top: 15px; padding: 12px 20px; font-size: 1em;">üöÄ –£–ª–∞–Ω—Ç—É—É</button>
        <p class="app-title-nic" style="margin-top: 10px; font-size: 0.8em; color: rgba(224, 224, 224, 0.6);">*–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —Å–∏–∑–¥–∏–Ω –Ω–∏–∫–∫–µ —Å–∞–∫—Ç–∞–ª–∞—Ç.</p>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="container">
        
        <div class="app-header">
             <div>
                <h1 style="color: var(--text-color);">P2P –ö–†–ò–ü–¢–û TRACKER <span class="app-title-version">V24.6</span></h1>
                <div class="app-title-nic">–ö–æ–ª–¥–æ–Ω—É—É—á—É: <span id="userNicDisplay">–¢–µ–º–∏—Ä–ª–∞–Ω</span></div>
             </div>
             <button onclick="logout()" class="btn btn-secondary" style="padding: 8px 12px; font-size: 0.8em; align-self: flex-start;">üëã –ß—ã–≥—É—É</button>
        </div>
        
        <div class="settings-control-group" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px;">
             <button onclick="showMainTracker()" class="btn btn-primary" id="homeBtn">üè† –¢–†–ï–ö–ï–†</button>
             <button onclick="toggleSettings()" class="btn btn-secondary" id="settingsBtn">‚öôÔ∏è –ù–ê–°–¢–†.</button>
             <button onclick="undoLastTransaction()" class="btn btn-danger" id="undoBtn" disabled>‚Ü©Ô∏è –û“¢–î–û–û</button>
             <button onclick="openCloseSessionModal()" class="btn btn-success">‚úîÔ∏è –°–ú–ï–ù–ê</button> 
        </div>
        
        <div id="settingsSection" style="display:none;" class="card-block">
            <h2>üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä</h2>
            
            <div class="settings-control-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                 <div class="modal-field">
                     <label style="color: rgba(224, 224, 224, 0.6);">BUY Rate (USD):</label>
                     <input type="number" id="settingBuyRate" step="0.01">
                 </div>
                 <div class="modal-field">
                    <label style="color: rgba(224, 224, 224, 0.6);">Spread (%):</label>
                    <input type="number" id="settingSpread" step="0.01">
                 </div>
            </div>
            
            <button onclick="updateSettings()" class="btn btn-primary" style="margin-bottom: 15px; font-size: 0.9em;">–ë–∞–∞—Ä—ã–Ω –°–∞–∫—Ç–æ–æ</button>

            <h3 style="margin-top: 15px; color: var(--accent-neon);">üè¶ –ë–∞–Ω–∫ –õ–∏–º–∏—Ç—Ç–µ—Ä–∏</h3>
            <div id="mobileSettingsBody">
                </div>

            <div class="card-block" style="margin-top: 15px; border: 2px dashed rgba(255, 215, 0, 0.5); padding: 15px; gap: 10px; background-color: rgba(30, 20, 60, 0.7);">
                <h3 style="margin-top: 0; color: var(--success-color);">‚ûï –ñ–∞“£—ã –ë–∞–Ω–∫</h3>
                <input type="text" id="newBankName" placeholder="–ñ–∞“£—ã –ë–∞–Ω–∫ –ê—Ç—ã">
                <input type="number" id="newBankDailyLimit" placeholder="–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º)">
                <button onclick="addBank()" class="btn btn-success">+ –ë–ê–ù–ö –ö–û–®–£–£</button>
            </div>
            
            <h3 style="margin-top: 20px; color: var(--danger-color);">üî• –ö–û–û–ü–¢–£–£ –ó–û–ù–ê</h3>
            <div class="settings-control-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button onclick="exportHistoryToCSV()" class="btn btn-secondary">üíæ CSV –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button onclick="resetCurrentDay()" class="btn btn-danger">‚Ü©Ô∏è –ö“Æ–ù–î“Æ –¢–ê–ó–ê–õ–û–û</button>
                <button onclick="clearAllData()" class="btn btn-danger" style="grid-column: 1 / span 2;">üí£ –ë–ê–ê–†–´–ù ”®–ß“Æ–†“Æ“Æ</button>
            </div>
        </div>

        <div id="trackerView">
            
            <div id="transactionForm" class="card-block">
                 <h3 style="margin-top: 0; color: var(--accent-gold);">üöÄ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ö–æ—à—É—É (Input Data)</h3>
                 
                 <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="modal-field" style="flex-grow: 1; flex-basis: 45%;">
                       <label style="color: rgba(224, 224, 224, 0.6);">–¢“Ø—Ä“Ø:</label>
                       <select id="actionType" >
                           <option value="income">–ö–∏—Ä–∏—à (–°–∞—Ç—É—É)</option>
                           <option value="outcome">–ß—ã–≥—ã—à (–°–∞—Ç—ã–ø –∞–ª—É—É)</option>
                       </select>
                    </div>
                    <div class="modal-field" style="flex-grow: 1; flex-basis: 45%;">
                       <label style="color: rgba(224, 224, 224, 0.6);">–°—É–º–º–∞ (–°–æ–º):</label>
                       <input type="number" id="transactionAmount" placeholder="–°—É–º–º–∞" min="1">
                    </div>
                 </div>
                 
                 <div class="modal-field">
                    <label style="color: rgba(224, 224, 224, 0.6);">–ë–∞–Ω–∫:</label>
                    <select id="transactionBank" onchange="updateRemainingLimitDisplay()"></select>
                    <div id="remainingLimitDisplay" style="margin-top: 10px;"></div>
                 </div>
                 
                 <button onclick="logTransaction()" class="btn btn-primary" style="font-size: 1em; padding: 12px 15px;">‚ûï –ö–û–®–£–£</button>
            </div>
            
            <div class="dd-section-title">
                 <span style="color: var(--bg-dark); font-size: 1.1em; text-shadow: none;">üè¶ –ë–ê–ù–ö–¢–ê–†–î–´–ù –ö“Æ–ù–î“Æ–ö –°–¢–ê–¢–£–°–£</span>
            </div>
            <div id="mobileCardView"></div>
            
            <div class="card-block recommendation-section">
                <h3>üí° –ë–†–û-–°–û–í–ï–¢–¢–ï–†: –ê–ö–´–õ–î–£–£ –ê–ù–ê–õ–ò–ó</h3>
                <ul id="recommendationList">
                    <li>–°–∏—Å—Ç–µ–º–∞ —É—á—É—Ä–¥–∞ –∞–Ω–∞–ª–∏–∑ –∂“Ø—Ä–≥“Ø–∑“Ø“Ø–¥”©...</li>
                </ul>
            </div>
            
            <div class="profit-motivation-box">
                <h2 style="color: var(--accent-gold); text-shadow: var(--shadow-gold);">‚ú® –ö“Æ–ù–î“Æ–ö –¢–ê–ë–´–® –ñ–´–ô–´–ù–¢–´–ì–´</h2>
                <div class="profit-value-large" id="estimatedProfit">0.00 –°–æ–º</div>
                <div id="motivationMessage" style="font-size: 1.0em; font-weight: 600; padding: 8px; border-radius: 8px; background-color: rgba(57, 255, 20, 0.1); color: var(--accent-neon); margin-top: 15px; border: 1px dashed var(--accent-neon);">
                    "–ê—Ä–∞–∫–µ—Ç –∫—ã–ª! –ë“Ø–≥“Ø–Ω–∫“Ø –∫“Ø–Ω–¥“Ø–Ω –ø–∞–π–¥–∞—Å—ã —Å–∏–∑–¥–∏–Ω –∫–æ–ª—É“£—É–∑–¥–∞. üí™"
                </div>
                
                <div class="analitics-row">
                    <div>
                        <p style="font-size: 0.8em; color: rgba(224, 224, 224, 0.6); margin-bottom: 0;">–ë–∞—à—Ç–∞–ø–∫—ã –°–ø—Ä–µ–¥:</p>
                        <span id="spreadDisplay" style="font-weight: 700; color: var(--accent-gold);">0.5%</span>
                    </div>
                    <div>
                        <p style="font-size: 0.8em; color: rgba(224, 224, 224, 0.6); margin-bottom: 0;">–û—Ä—Ç–æ—á–æ –°–ø—Ä–µ–¥ (–ö“Ø–Ω“Ø–º–¥“Ø–∫):</p>
                        <span id="averageSpreadDisplay" style="font-weight: 700; color: var(--accent-neon);">0.00%</span>
                    </div>
                    <div>
                        <p style="font-size: 0.8em; color: rgba(224, 224, 224, 0.6); margin-bottom: 0;">–ö—É—Ä—Å (USD):</p>
                        <span id="buyRateDisplay" style="font-weight: 700; color: var(--text-color);">88.0</span>
                    </div>
                </div>
                
            </div>
            
            <div id="expenseForm" class="card-block" style="border: 2px solid var(--danger-color);">
                <h3 style="color: var(--danger-color); margin-top: 0;">üõí –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞)</h3>
                <div class="modal-field">
                    <input type="number" id="personalExpenseAmount" placeholder="–†–∞—Å—Ö–æ–¥ –°—É–º–º–∞—Å—ã (–°–æ–º)" min="1">
                </div>
                <button onclick="logPersonalExpense()" class="btn btn-danger" style="font-size: 0.9em;">üî• –†–ê–°–•–û–î–î–£ –ö–ò–†–ì–ò–ó“Æ“Æ</button>
                <div id="personalExpenseSummary" style="margin-top: 5px; font-weight: bold; font-size: 0.85em; text-align: center; color: rgba(224, 224, 224, 0.6);">
                    –ñ–∞–ª–ø—ã –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): 0.00 –°–æ–º
                </div>
            </div>

            <div class="history-section" style="margin-top: 30px;">
                <h2 style="color: var(--accent-gold); text-shadow: var(--shadow-gold);">üìä ”®–¢–ö”®–ù –°–ú–ï–ù–ê–õ–ê–† (–¢–ê–†–´–•)</h2>
                <div style="overflow-x: auto;">
                    <table class="history-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;">
                         <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–±. –û–±–æ—Ä–æ—Ç</th>
                                <th>–ü–∞–π–¥–∞</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                         <tfoot>
                            <tr class="total-row" style="color: var(--accent-gold);">
                                <th colspan="2">–ñ–ê–õ–ü–´ –¢–ê–†–´–•–´–ô –ü–ê–ô–î–ê</th>
                                <th id="totalHistoryProfit">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
        </div>

    </div>
</div>

<div id="closeSessionModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 100;">
    <div class="modal-content card-block" style="max-width: 400px;">
        <h2>–°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£</h2>
        <p style="font-size: 0.9em; color: rgba(224, 224, 224, 0.6);">–ö–∞–ª–¥—ã–∫ –∫–∞—Ä–∞–∂–∞—Ç—Ç–∞—Ä–¥—ã –∂–∞–Ω–∞ —Ç–∞–∑–∞ –ø–∞–π–¥–∞–Ω—ã —Ç–∞–∫—Ç–æ–æ “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.</p>

        <div class="modal-field">
            <label for="remainingAmount">üí∞ –°–∞—Ç—ã–ª–±–∞–π –ö–∞–ª–≥–∞–Ω –ö–∞–ª–¥—ã–∫ –°—É–º–º–∞ (–°–æ–º)</label>
            <input type="number" id="remainingAmount" value="0" placeholder="–ú–∏—Å–∞–ª—ã: 90000">
        </div>

        <div class="modal-field">
            <label for="personalExpensesTotal">üõí –ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞)</label>
            <input type="text" id="personalExpensesTotal" value="0.00" disabled style="background-color: rgba(30, 20, 60, 0.7);">
        </div>

        <div class="modal-field">
            <label for="actualProfitInput">üí∏ –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑–¥—ã –ö–∏—Ä–≥–∏–∑–∏“£–∏–∑ (–°–æ–º)</label>
            <input type="number" id="actualProfitInput" placeholder="–ú–∏—Å–∞–ª—ã: 12500">
            <p style="font-size: 0.7em; color: rgba(224, 224, 224, 0.6); margin-top: 5px;">*–ë—É–ª –º–∞–∞–Ω–∏–≥–µ –∫–∞—Ä–∞–ø –°–ø—Ä–µ–¥ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© —ç—Å–µ–ø—Ç–µ–ª–µ—Ç.</p>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 8px;">
            <button onclick="closeSession(true)" class="btn btn-success" style="flex-grow: 1;">‚úîÔ∏è –°–ú–ï–ù–ê–ù–´ –ë“Æ–¢“Æ–†“Æ“Æ</button>
            <button onclick="document.getElementById('closeSessionModal').style.display='none';" class="btn btn-secondary">‚ùå –ñ–ê–ë–£–£</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 100;">
    <div class="modal-content card-block" style="text-align: center; max-width: 400px;">
        <span class="fireworks" style="font-size: 3em; display: block; margin-bottom: 5px; color: var(--accent-gold); text-shadow: var(--shadow-gold);">üéâ</span>
        <h2 style="color: var(--success-color);">–ò–ô–ì–ò–õ–ò–ö–¢“Æ“Æ! –°–ú–ï–ù–ê –ñ–ê–ë–´–õ–î–´!</h2>
        <p style="font-size: 1.2em;">–°–∏–∑–¥–∏–Ω –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑:</p>
        <div class="profit-value-large" style="color: var(--accent-neon); font-size: 2.5em; text-shadow: var(--shadow-neon);" id="modalProfitDisplay">0.00 –°–æ–º</div>
        <div style="margin-top: 5px; font-weight: 600; font-size: 0.9em; color: var(--accent-neon);">–ñ–∞“£—ã –≠—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –°–ø—Ä–µ–¥: <span id="modalNewSpread" style="color: var(--accent-gold);">0.0%</span></div>
        <div style="margin-top: 5px; font-weight: 600; font-size: 0.9em;">–ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: <span id="modalExpenseDisplay">0.00 –°–æ–º</span></div>
        <button onclick="document.getElementById('successModal').style.display='none';" class="btn btn-primary" style="margin-top: 15px;">–£–ª–∞–Ω—Ç—É—É</button>
    </div>
</div>

<div id="toastNotification" class="toast-message">–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø! ‚úÖ</div>

<script>
    // --- STORAGE KEYS (V24) ---
    const STORAGE_CURRENT_DATA = 'p2p_tracker_v24_data_enc'; // ENCRYPTED
    const STORAGE_HISTORY = 'p2p_history_v24_enc'; // ENCRYPTED
    const STORAGE_LAST_DATE = 'p2p_last_session_date_v24_enc'; // ENCRYPTED
    const STORAGE_SETTINGS = 'p2p_settings_v24_enc'; // ENCRYPTED
    const STORAGE_TRANSACTION_LOG = 'p2p_transaction_log_v24_enc'; // ENCRYPTED
    const STORAGE_PERSONAL_EXPENSE = 'p2p_personal_expense_v24_enc'; // ENCRYPTED
    const STORAGE_AUTH_CREDENTIALS = 'p2p_auth_username_v24'; // NOT ENCRYPTED (UX)
    const STORAGE_AUTH_STATUS = 'p2p_auth_status_v24'; // NOT ENCRYPTED (UX)

    let BUY_RATE = 88.0;
    let SPREAD = 0.5; 
    let PERSONAL_EXPENSE_TODAY = 0; 
    let lastEstimatedProfit = 0; 

    let STARTING_LIMITS = {
        "Optima24": { daily: 35000, isResting: false }, 
        "DemirBank": { daily: 25000, isResting: false }, 
        "Mbank": { daily: 20000, isResting: false }
    };

    let bankLimits = [];
    let transactionLog = [];
    let currentView = 'tracker'; 
    let CURRENT_USER_NIC = null; 
    
    // --- SECURITY: ENCRYPTION / DECRYPTION UTILITIES ---
    // (–ñ–µ“£–∏–ª —à–∏—Ñ—Ä–ª”©”© - –∫–æ–Ω—Å–æ–ª–¥–æ–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø–≥”© —Ç–æ—Å–∫–æ–æ–ª–¥—É–∫ –∫—ã–ª—É—É “Ø—á“Ø–Ω)
    
    const ENCRYPTION_OFFSET = 13; // Simple Caesar Cipher (ROT13 variation)

    /**
     * –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã JSON'–≥–æ –∞–π–ª–∞–Ω—Ç—ã–ø, –∞–Ω–¥–∞–Ω –∫–∏–π–∏–Ω Base64 –º–µ–Ω–µ–Ω –∫–æ–¥–¥–æ–π—Ç.
     * @param {object} data - –ö–æ–¥–¥–æ–ª—É—á—É –º–∞–∞–ª—ã–º–∞—Ç –æ–±—ä–µ–∫—Ç–∏—Å–∏.
     * @returns {string} - –ö–æ–¥–¥–æ–ª–≥–æ–Ω —Å–∞–ø.
     */
    function encodeData(data) {
        try {
            const jsonString = JSON.stringify(data);
            // –ñ–µ“£–∏–ª —à–∏—Ñ—Ä–ª”©”©: –ê—Ä –±–∏—Ä —Å–∏–º–≤–æ–ª–¥—É–Ω ASCII –∫–æ–¥—É–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø
            let encoded = '';
            for (let i = 0; i < jsonString.length; i++) {
                encoded += String.fromCharCode(jsonString.charCodeAt(i) + ENCRYPTION_OFFSET);
            }
            // Base64 –∫–æ—à—É—É
            return btoa(encoded);
        } catch (e) {
            console.error("Encryption error:", e);
            return null;
        }
    }

    /**
     * –ö–æ–¥–¥–æ–ª–≥–æ–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç—ã Base64'—Ç”©–Ω —á—ã–≥–∞—Ä—ã–ø, –¥–µ–∫–æ–¥–¥–æ–ø, JSON'–≥–æ –∞–π–ª–∞–Ω—Ç–∞—Ç.
     * @param {string} encodedString - –ö–æ–¥–¥–æ–ª–≥–æ–Ω —Å–∞–ø.
     * @returns {object|null} - –î–µ–∫–æ–¥–¥–æ–ª–≥–æ–Ω –º–∞–∞–ª—ã–º–∞—Ç –æ–±—ä–µ–∫—Ç–∏—Å–∏ –∂–µ null.
     */
    function decodeData(encodedString) {
        if (!encodedString) return null;
        try {
            // Base64'—Ç”©–Ω —á—ã–≥–∞—Ä—É—É
            let decodedBase64 = atob(encodedString);
            // –ñ–µ“£–∏–ª —à–∏—Ñ—Ä–ª”©”©–¥”©–Ω —á—ã–≥–∞—Ä—É—É
            let decoded = '';
            for (let i = 0; i < decodedBase64.length; i++) {
                decoded += String.fromCharCode(decodedBase64.charCodeAt(i) - ENCRYPTION_OFFSET);
            }
            return JSON.parse(decoded);
        } catch (e) {
            console.error("Decryption error. Data might be corrupted or tampered with.", e);
            showToast("–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –æ–∫—É–ª–±–∞–π –∫–∞–ª–¥—ã. –ö–æ–Ω—Å–æ–ª–¥—É —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑. üîí", 'danger');
            return null;
        }
    }

    // --- MOTIVATION MESSAGES (Unchanged) ---
    const MOTIVATION_MESSAGES = [
        "–ê—Ä–∞–∫–µ—Ç –∫—ã–ª! –ë“Ø–≥“Ø–Ω–∫“Ø –∫“Ø–Ω–¥“Ø–Ω –ø–∞–π–¥–∞—Å—ã —Å–∏–∑–¥–∏–Ω –∫–æ–ª—É“£—É–∑–¥–∞. üí™ (Data Stream: Optimal)",
        "–ê—Ä –±–∏—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è - –±—É–ª –∏–π–≥–∏–ª–∏–∫–∫–µ –∫–∞—Ä–∞–π –±–∏—Ä –∫–∞–¥–∞–º. üöÄ (Matrix Status: Green)",
        "–ë“Ø–≥“Ø–Ω —Å–∏–∑ —Ä–µ–∫–æ—Ä–¥ –∂–∞—Ä–∞—Ç—ã—à—ã“£—ã–∑ –∫–µ—Ä–µ–∫! –ê–õ–ì–ê! üåü (Target Acquisition: Active)",
        "–≠“£ –º—ã–∫—Ç—ã –ø–∞–π–¥–∞ –∞–ª—É—É “Ø—á“Ø–Ω –∞–∫—ã–ª–¥—É—É–ª—É–∫ –º–µ–Ω–µ–Ω —Å–æ–æ–¥–∞ –∫—ã–ª—ã“£—ã–∑. üí° (System Alert: Profit Mode)",
        "–≠—á –∫–∞—á–∞–Ω —Ç–æ–∫—Ç–æ–±–æ! –°–∏–∑–¥–∏–Ω –º–∞–∫—Å–∞—Ç—Ç–∞—Ä—ã“£—ã–∑ –∂–∞–∫—ã–Ω–¥–∞. üéØ (Financial Flow: Unrestricted)",
        "–ß–æ“£ –ø–∞–π–¥–∞–ª–∞—Ä –∫–∏—á–∏–Ω–µ–∫–µ–π –∫–∞–¥–∞–º–¥–∞—Ä–¥–∞–Ω –±–∞—à—Ç–∞–ª–∞—Ç. ‚ú® (Execute Trade: Now)",
        "–ö“Ø–Ω“Ø–º–¥“Ø–∫ –ø–∞–π–¥–∞“£—ã–∑–¥—ã –∫”©—Ä“Ø–ø, –º–æ—Ç–∏–≤–∞—Ü–∏—è –∞–ª—ã“£—ã–∑! üìà (Cyber-Profit: Initiated)"
    ];

    function getMotivationMessage(estimatedProfit) {
        if (estimatedProfit > 15000) {
            return `–£–∫–º—É—à! –ü–∞–π–¥–∞: ${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º. –°–∏–∑ –º—ã–∫—Ç—ã—Å—ã–∑! üéâ (Core System: EXCELLENT)`;
        }
        if (estimatedProfit > 5000) {
            return `–ñ–∞–∫—à—ã –∏—à! –ü–∞–π–¥–∞: ${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º. –£–ª–∞–Ω—Ç—ã“£—ã–∑! üëç (Status: Elevated)`;
        }
        if (estimatedProfit < 0) {
            return "–ö”©–∑”©–º”©–ª–¥”©“£“Ø–∑! –ü–∞–π–¥–∞ —Ç–µ—Ä—Å –±–æ–ª—É–ø –∂–∞—Ç–∞—Ç. –ö”©–±“Ø—Ä”©”©–∫ —Å–∞—Ç—ã“£—ã–∑! ‚ö†Ô∏è (System Alert: Deficiency)";
        }
        
        const randomIndex = Math.floor(Math.random() * MOTIVATION_MESSAGES.length);
        return MOTIVATION_MESSAGES[randomIndex];
    }
    
    // --- AUTH, VIEW TOGGLE, INIT (Unchanged) ---
    
    function displayUserName() { 
        document.getElementById('userNicDisplay').textContent = CURRENT_USER_NIC || '–ö–æ–ª–¥–æ–Ω—É—É—á—É';
    }

    function checkAuthStatus() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        const authStatus = localStorage.getItem(STORAGE_AUTH_STATUS);
        
        if (authStatus === 'logged_in' && storedNic) {
            CURRENT_USER_NIC = storedNic;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadState(); 
            initTrackerContent();
        } else {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    }

    function loginUser() {
        const username = document.getElementById('authUsername').value.trim();

        if (username.length < 3) {
            showToast("–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã (–ù–∏–∫) 3 —Å–∏–º–≤–æ–ª—É–Ω–∞–Ω –∫–µ–º –±–æ–ª–±–æ—Å—É–Ω.", 'danger');
            return;
        }

        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);

        if (!storedNic || storedNic === username) {
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        } else {
             if (!confirm(`–≠–°–ö–ï–†–¢“Æ“Æ: –ú—É—Ä—É–Ω–∫—É –∫–æ–ª–¥–æ–Ω—É—É—á—É "${storedNic}" –±–æ–ª–≥–æ–Ω. "${username}" –º–µ–Ω–µ–Ω —É–ª–∞–Ω—Ç–∞—Å—ã–∑–±—ã? –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–∏—à–∏ –º“Ø–º–∫“Ø–Ω.`)) {
                 return;
             }
             localStorage.clear(); 
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        }
        
        CURRENT_USER_NIC = username;
        localStorage.setItem(STORAGE_AUTH_STATUS, 'logged_in');
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        loadState(); 
        initTrackerContent();
        showToast(`–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∫–∏—Ä–¥–∏“£–∏–∑: ${username}! üöÄ`);
    }

    function logout() {
        if (confirm("–ß—ã–≥—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.removeItem(STORAGE_AUTH_STATUS); 
            
            document.getElementById('authUsername').value = CURRENT_USER_NIC || '';
            CURRENT_USER_NIC = null;
            
            checkAuthStatus(); 
        }
    }

    function setActiveView(viewName) {
        document.getElementById('trackerView').style.display = 'none';
        document.getElementById('settingsSection').style.display = 'none';
        
        if (viewName === 'tracker') {
            document.getElementById('trackerView').style.display = 'block';
        } else if (viewName === 'settings') {
            renderSettings();
            document.getElementById('settingsSection').style.display = 'block';
        }
        currentView = viewName;
    }

    function showMainTracker() { 
        setActiveView('tracker'); 
        document.getElementById('homeBtn').classList.add('btn-primary');
        document.getElementById('settingsBtn').classList.remove('btn-primary');
        document.getElementById('settingsBtn').classList.add('btn-secondary'); 
    }
    
    function toggleSettings() { 
        const isSettings = currentView === 'settings';
        setActiveView(isSettings ? 'tracker' : 'settings'); 
        
        if (isSettings) {
             document.getElementById('homeBtn').classList.add('btn-primary');
             document.getElementById('settingsBtn').classList.remove('btn-primary');
             document.getElementById('settingsBtn').classList.add('btn-secondary');
        } else {
             document.getElementById('homeBtn').classList.remove('btn-primary');
             document.getElementById('settingsBtn').classList.add('btn-primary');
             document.getElementById('settingsBtn').classList.remove('btn-secondary');
        }
    }
    
    function initTrackerContent() {
        displayUserName(); 
        renderBankOptions(); 
        updateDisplay(); 
        renderHistory();
        generateRecommendations(); 
        setActiveView('tracker');
        showMainTracker();
    }
    
    function init() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        if (storedNic) {
             document.getElementById('authUsername').value = storedNic;
        }

        checkAuthStatus(); 
    }
    
    // --- CORE LOGIC (V24.6 - ENCRYPTION / DECRYPTION IMPLEMENTATION) ---

    function saveGlobalSettings() {
        const settings = {
            buyRate: BUY_RATE,
            spread: SPREAD,
            startingLimits: STARTING_LIMITS
        };
        const encodedSettings = encodeData(settings);
        if (encodedSettings) localStorage.setItem(STORAGE_SETTINGS, encodedSettings);
    }

    function loadGlobalSettings() {
        const storedSettings = localStorage.getItem(STORAGE_SETTINGS);
        if (storedSettings) {
            const settings = decodeData(storedSettings);
            if (settings) {
                BUY_RATE = settings.buyRate || 88.0;
                SPREAD = settings.spread || 0.5;
                const loadedLimits = settings.startingLimits || STARTING_LIMITS;
                
                STARTING_LIMITS = {}; 
                for (const name in loadedLimits) {
                     STARTING_LIMITS[name] = { 
                         daily: loadedLimits[name].daily || 0,
                         isResting: loadedLimits[name].isResting || false
                     };
                }
            } else {
                // If decoding fails, reset to default limits
                showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä –±—É–∑—É–ª–≥–∞–Ω. –ë–∞—à—Ç–∞–ø–∫—ã–≥–∞ –∫–∞–π—Ç–∞—Ä—ã–ª–¥—ã.", 'warning');
                STARTING_LIMITS = {
                    "Optima24": { daily: 35000, isResting: false }, 
                    "DemirBank": { daily: 25000, isResting: false }, 
                    "Mbank": { daily: 20000, isResting: false }
                };
            }
        }
        if (Object.keys(STARTING_LIMITS).length === 0) {
            STARTING_LIMITS = {
                "Optima24": { daily: 35000, isResting: false }, 
                "DemirBank": { daily: 25000, isResting: false }, 
                "Mbank": { daily: 20000, isResting: false }
            };
        }
    }
    
    function syncBankLimits() {
         const updatedBankLimits = [];
         for (const name in STARTING_LIMITS) {
             const limits = STARTING_LIMITS[name];
             let existingBank = bankLimits.find(b => b.name === name);
             
             if (existingBank) {
                 existingBank.baseLimit = limits.daily; 
                 existingBank.isResting = limits.isResting;
                 if (existingBank.isAutoRest === undefined) {
                     existingBank.isAutoRest = false;
                 }
                 updatedBankLimits.push(existingBank);
             } else {
                 updatedBankLimits.push({ 
                     name: name, 
                     baseLimit: limits.daily, 
                     income: 0, 
                     outcome: 0, 
                     isResting: limits.isResting,
                     isAutoRest: false 
                 });
             }
         }
         bankLimits = updatedBankLimits.filter(bank => STARTING_LIMITS[bank.name] !== undefined);
         saveGlobalSettings(); 
    }
    
    function loadState() {
        loadGlobalSettings();
        
        const storedData = localStorage.getItem(STORAGE_CURRENT_DATA);
        if (storedData) {
            const decodedData = decodeData(storedData);
            if (decodedData) {
                bankLimits = decodedData;
            } else {
                showToast("–ë–∞–Ω–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã –±—É–∑—É–ª–≥–∞–Ω. –ë–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–µ—Ç.", 'warning');
                syncBankLimits();
            }
        } else {
            syncBankLimits();
        }
        
        bankLimits.forEach(bank => {
             if (bank.isResting === undefined) {
                 bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false;
             }
             if (bank.isAutoRest === undefined) {
                 bank.isAutoRest = false;
             }
        });
        
        syncBankLimits(); 

        const storedLog = localStorage.getItem(STORAGE_TRANSACTION_LOG);
        if (storedLog) {
            const decodedLog = decodeData(storedLog);
            if (decodedLog) {
                 transactionLog = decodedLog;
            } else {
                 showToast("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ª–æ–≥—É –±—É–∑—É–ª–≥–∞–Ω. –¢–∞–∑–∞–ª–∞–Ω–¥—ã.", 'warning');
                 transactionLog = [];
            }
        }

        const storedExpense = localStorage.getItem(STORAGE_PERSONAL_EXPENSE);
        if (storedExpense) {
            const decodedExpense = decodeData(storedExpense);
            if (decodedExpense !== null) {
                 PERSONAL_EXPENSE_TODAY = parseFloat(decodedExpense) || 0;
            } else {
                 showToast("–†–∞—Å—Ö–æ–¥ –º–∞–∞–ª—ã–º–∞—Ç—ã –±—É–∑—É–ª–≥–∞–Ω. –¢–∞–∑–∞–ª–∞–Ω–¥—ã.", 'warning');
                 PERSONAL_EXPENSE_TODAY = 0;
            }
        }
        
        checkNewDay();
        bankLimits.forEach(checkBankAutoRest); 
        updateDisplay();
    }

    function saveState() {
        const encodedBankLimits = encodeData(bankLimits);
        const encodedLog = encodeData(transactionLog);
        const encodedExpense = encodeData(PERSONAL_EXPENSE_TODAY.toFixed(2));

        if (encodedBankLimits) localStorage.setItem(STORAGE_CURRENT_DATA, encodedBankLimits);
        if (encodedLog) localStorage.setItem(STORAGE_TRANSACTION_LOG, encodedLog);
        if (encodedExpense) localStorage.setItem(STORAGE_PERSONAL_EXPENSE, encodedExpense);
        
        saveGlobalSettings();
        updateDisplay();
        generateRecommendations(); 
    }

    function checkNewDay() {
        const today = new Date();
        const lastSessionDateEncoded = localStorage.getItem(STORAGE_LAST_DATE);
        
        let lastSessionDateStr = null;
        if (lastSessionDateEncoded) {
            lastSessionDateStr = decodeData(lastSessionDateEncoded);
        }
        
        let isNewDay = false;

        if (lastSessionDateStr) {
            const lastSessionDate = new Date(lastSessionDateStr);
            if (today.toDateString() !== lastSessionDate.toDateString()) {
                isNewDay = true;
            } 
        } else {
             isNewDay = true; 
        }
        
        if (isNewDay) {
            bankLimits.forEach(bank => {
                bank.income = 0;
                bank.outcome = 0;
                bank.isAutoRest = false; 
                bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false;
            });
            
            transactionLog = [];
            PERSONAL_EXPENSE_TODAY = 0;
            localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
            localStorage.removeItem(STORAGE_TRANSACTION_LOG);
            
            if (lastSessionDateStr) { 
                showToast("–ñ–∞“£—ã –∫“Ø–Ω! –ö“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç—Ç–µ—Ä —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. ‚òÄÔ∏è");
            }
        }
        
        const encodedDate = encodeData(today.toISOString());
        if (encodedDate) localStorage.setItem(STORAGE_LAST_DATE, encodedDate);
    }
    
    function checkBankAutoRest(bank) {
        const turnover = bank.income + bank.outcome;
        
        if (turnover >= bank.baseLimit) {
            if (!bank.isAutoRest) {
                 bank.isAutoRest = true;
                 bank.isResting = true; 
                 return true; 
            }
        } 
        return false;
    }

    function renderBankOptions() {
        const select = document.getElementById('transactionBank');
        select.innerHTML = '';
        
        bankLimits.forEach(bank => {
            if (!bank.isResting && !bank.isAutoRest) {
                 const option = document.createElement('option');
                 option.value = bank.name;
                 option.textContent = bank.name;
                 select.appendChild(option);
            }
        });
        
        const transactionButton = document.querySelector('#transactionForm button');

        if (select.children.length === 0) {
             select.innerHTML = '<option value="">(–≠—Å –∞–ª—É—É–¥–∞ –∂–µ –±–∞–Ω–∫ –∂–æ–∫)</option>';
             if (transactionButton) transactionButton.disabled = true;
             document.getElementById('remainingLimitDisplay').style.display = 'none'; 
        } else {
             if (transactionButton) transactionButton.disabled = false;
             updateRemainingLimitDisplay(); 
        }
    }
    
    function updateRemainingLimitDisplay() {
        const selectedBankName = document.getElementById('transactionBank').value;
        const displayDiv = document.getElementById('remainingLimitDisplay');
        
        if (!selectedBankName) {
            displayDiv.style.display = 'none';
            return;
        }

        const bank = bankLimits.find(b => b.name === selectedBankName);
        
        if (bank) {
            const turnover = bank.income + bank.outcome;
            const remaining = bank.baseLimit - turnover;
            const color = remaining < bank.baseLimit * 0.1 ? 'var(--danger-color)' : 'var(--accent-neon)';
            const statusText = `–ö–∞–ª–¥—ã–∫ –õ–∏–º–∏—Ç: <span style="color: ${color};">${remaining.toLocaleString('ru-RU')} –°–æ–º</span>`;
            
            displayDiv.innerHTML = statusText;
            displayDiv.style.display = 'block';
        } else {
            displayDiv.style.display = 'none';
        }
    }

    function renderTable() {
        const mobileView = document.getElementById('mobileCardView');
        mobileView.innerHTML = '';
        
        const sortedBanks = [...bankLimits].sort((a, b) => {
            if (a.isAutoRest && !b.isAutoRest) return 1;
            if (!a.isAutoRest && b.isAutoRest) return -1;
            
            if (a.isResting && !b.isResting) return 1;
            if (!a.isResting && b.isResting) return -1;

            return a.name.localeCompare(b.name);
        });
        
        let mobileCards = '';

        sortedBanks.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;
            const percentageUsed = (turnover / bank.baseLimit) * 100;

            let statusText = '';
            let statusEmoji = '';
            let cardClass = '';
            let neonColor = 'var(--accent-neon)';
            let buttonDisabled = '';
            let buttonText = '';

            if (bank.isAutoRest) {
                statusText = '–ê–í–¢–û –≠–° –ê–õ–£–£! (–õ–∏–º–∏—Ç —Ç–æ–ª–¥—É)';
                statusEmoji = 'üõë';
                cardClass = 'auto-rest';
                neonColor = 'var(--danger-color)';
                buttonDisabled = 'disabled'; 
                buttonText = 'üîí –ê–í–¢–û-–≠–° –ê–õ–£–£';
            } else if (bank.isResting) {
                statusText = '–ö–æ–ª –º–µ–Ω–µ–Ω –≠—Å –∞–ª—É—É–¥–∞';
                statusEmoji = 'üò¥';
                cardClass = 'resting';
                neonColor = 'rgba(224, 224, 224, 0.5)';
                buttonText = '‚úÖ –ê–î–ê–¢–¢–ê–ì–´';
            } else if (percentageUsed >= 90) {
                statusText = '–ê–∑ –∫–∞–ª–¥—ã (>90%)';
                statusEmoji = '‚ö†Ô∏è';
                neonColor = 'var(--accent-gold)';
                buttonText = 'üò¥ –≠–° –ê–õ–£–£';
            } else {
                statusText = '–ò—à—Ç–µ–ø –∂–∞—Ç–∞—Ç';
                statusEmoji = '‚úÖ';
                buttonText = 'üò¥ –≠–° –ê–õ–£–£';
            }
            
            mobileCards += `
                <div class="bank-card ${cardClass}" style="border-left-color: ${neonColor};">
                    <div class="card-header">
                        <h3 style="color: ${neonColor};">${statusEmoji} ${bank.name}</h3>
                    </div>
                    <div class="card-item"><span class="item-label">–°—Ç–∞—Ç—É—Å:</span><span class="item-value" style="color: ${neonColor}; font-weight: 700;">${statusText}</span></div>
                    <div class="card-item"><span class="item-label">–ö“Ø–Ω. –õ–∏–º–∏—Ç:</span><span class="item-value">${bank.baseLimit.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ö–∏—Ä–∏—à (–ü—Ä–∏—Ö–æ–¥):</span><span class="item-value success">${bank.income.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ß—ã–≥—ã—à (–†–∞—Å—Ö–æ–¥):</span><span class="item-value danger">${bank.outcome.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ö“Ø–Ω. –û–±–æ—Ä–æ—Ç:</span><span class="item-value" style="color: var(--accent-gold);">${turnover.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ö“Ø–Ω. –ö–∞–ª–¥—ã–∫:</span><span class="item-value" style="color: ${remainingDaily < 0 ? 'var(--danger-color)' : neonColor};">${remainingDaily.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-controls">
                        <button onclick="toggleBankResting('${bank.name}')" class="btn ${bank.isResting && !bank.isAutoRest ? 'btn-success' : 'btn-secondary'}" style="font-size: 0.75em;" ${buttonDisabled}>
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        });
        
        mobileView.innerHTML = mobileCards;
        renderBankOptions(); 
    }
    
    function toggleBankResting(bankName) {
        const bank = bankLimits.find(b => b.name === bankName);
        if (!bank) return;
        
        if (bank.isAutoRest) {
            showToast(`${bankName} –ª–∏–º–∏—Ç–∏ —Ç–æ–ª–≥–æ–Ω. –°—Ç–∞—Ç—É—Å—É–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø –º“Ø–º–∫“Ø–Ω —ç–º–µ—Å. üõ°Ô∏è`, 'danger');
            return; 
        }
        
        const isResting = !bank.isResting;
        
        if (isResting) {
             if (!confirm(`${bankName} –±–∞–Ω–∫—ã–Ω –≠–° –ê–õ–£–£ —Ä–µ–∂–∏–º–∏–Ω–µ –∫–æ—é—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã? –ë—É–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä–¥—ã –∫–æ—à—É—É–≥–∞ –±”©–≥”©—Ç –∫–æ—ë—Ç.`)) {
                 return;
             }
        }

        bank.isResting = isResting;
        if (STARTING_LIMITS[bankName]) {
             STARTING_LIMITS[bankName].isResting = isResting;
        }

        saveState();
        showToast(`${bankName} —Å—Ç–∞—Ç—É—Å—É ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø: ${isResting ? 'üò¥ –≠—Å –∞–ª—É—É' : '‚úÖ –ê–¥–∞—Ç—Ç–∞–≥—ã'}`, isResting ? 'warning' : 'success');
    }

    function calculateAverageSpread() {
        const totalIncome = bankLimits.reduce((sum, bank) => sum + bank.income, 0);
        
        if (totalIncome > 0) {
            const currentTheoreticalProfit = totalIncome * (SPREAD / 100);
            const averageSpread = (currentTheoreticalProfit / totalIncome) * 100;
            return averageSpread;
        }
        return 0;
    }
    
    function updateDisplay() {
        renderTable();
        renderProfit();
        updateRemainingLimitDisplay(); 

        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;
        
        document.getElementById('spreadDisplay').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('buyRateDisplay').textContent = BUY_RATE.toFixed(1);
        
        const avgSpread = calculateAverageSpread();
        document.getElementById('averageSpreadDisplay').textContent = `${avgSpread.toFixed(2)}%`;

        document.getElementById('undoBtn').disabled = transactionLog.length === 0;
        document.getElementById('personalExpenseSummary').textContent = `–ñ–∞–ª–ø—ã –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): ${PERSONAL_EXPENSE_TODAY.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;

    }

    function renderProfit() {
        const totalIncome = bankLimits.reduce((sum, bank) => {
             return bank.isResting ? sum : sum + bank.income;
        }, 0);
        
        let estimatedProfit = totalIncome * (SPREAD / 100);
        estimatedProfit = estimatedProfit - PERSONAL_EXPENSE_TODAY;
        
        const profitElement = document.getElementById('estimatedProfit');
        
        function animateNumber(element, finalValue) {
            const duration = 500; 
            const steps = 10;
            const stepDuration = duration / steps;
            let currentValue = lastEstimatedProfit;
            let counter = 0;

            const interval = setInterval(() => {
                counter++;
                const diff = finalValue - currentValue;
                currentValue += diff / (steps - counter + 1); 

                if (counter >= steps) {
                    clearInterval(interval);
                    currentValue = finalValue;
                }
                
                const currentString = currentValue.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                element.innerHTML = currentString.split('').map((char, index) => {
                    if (char === ' ' || char === ',' || char === '.') return char;
                    let color = 'var(--accent-neon)';
                    if (currentValue < 0) color = 'var(--danger-color)';
                    
                    return `<span style="animation-delay: ${index * 0.05}s; color: ${color}; text-shadow: 0 0 5px ${color};">${char}</span>`;
                }).join('');
                element.innerHTML += ' –°–æ–º';

            }, stepDuration);
        }

        animateNumber(profitElement, estimatedProfit);
        lastEstimatedProfit = estimatedProfit;
        
        document.getElementById('motivationMessage').textContent = getMotivationMessage(estimatedProfit);
    }

    function logTransaction() {
        const actionType = document.getElementById('actionType').value;
        const amountStr = document.getElementById('transactionAmount').value;
        const bankName = document.getElementById('transactionBank').value;

        if (!amountStr || parseFloat(amountStr) <= 0) {
            showToast("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Å—É–º–º–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }

        const amount = parseFloat(amountStr);
        const bank = bankLimits.find(b => b.name === bankName);
        
        if (!bank) {
             showToast("–ë–∞–Ω–∫ —Ç–∞–Ω–¥–∞–ª–≥–∞–Ω –∂–æ–∫ –∂–µ –∂–æ–∫.", 'danger');
             return;
        }

        if (bank.isResting || bank.isAutoRest) { 
            showToast(`${bank.name} –≠—Å –∞–ª—É—É–¥–∞ –∂–µ –õ–∏–º–∏—Ç–∏ —Ç–æ–ª–≥–æ–Ω. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—à—É–ª–≥–∞–Ω –∂–æ–∫.`, 'danger');
            return;
        }
        
        let shouldCheckAutoRest = false;
        const turnoverBefore = bank.income + bank.outcome;

        if (actionType === 'income') {
            bank.income += amount;
            shouldCheckAutoRest = true;
        } else {
            bank.outcome += amount;
            shouldCheckAutoRest = true;
        }
        
        const turnoverAfter = bank.income + bank.outcome;
        
        if (shouldCheckAutoRest) {
            if (turnoverAfter >= bank.baseLimit) {
                 if (checkBankAutoRest(bank)) {
                      showToast(`${bank.name} –ê–í–¢–û –≠–° –ê–õ–£–£ —Ä–µ–∂–∏–º–∏–Ω–µ ”©—Ç—Ç“Ø. üõë (–õ–∏–º–∏—Ç —Ç–æ–ª–¥—É)`, 'danger');
                 }
            } else if (turnoverAfter >= bank.baseLimit * 0.9 && turnoverBefore < bank.baseLimit * 0.9) {
                 showToast(`${bank.name} –ª–∏–º–∏—Ç–∏ 90% –∞—à—Ç—ã. –¢–µ–∑ –∞—Ä–∞–¥–∞ —ç—Å –∞–ª–¥—ã—Ä—ã“£—ã–∑. ‚ö†Ô∏è`, 'warning');
            }
        }


        transactionLog.push({ 
            type: actionType, 
            amount: amount, 
            bank: bankName, 
            expense: 0,
            timestamp: new Date().toISOString()
        });

        document.getElementById('transactionAmount').value = '';
        saveState();
        showToast("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—à—É–ª–¥—É. ‚úÖ");
    }

    function logPersonalExpense() {
        const amountStr = document.getElementById('personalExpenseAmount').value;

        if (!amountStr || parseFloat(amountStr) <= 0) {
            showToast("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥ —Å—É–º–º–∞—Å—ã–Ω –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }
        
        const amount = parseFloat(amountStr);
        
        PERSONAL_EXPENSE_TODAY += amount;
        
        transactionLog.push({ 
            type: 'expense', 
            amount: amount, 
            bank: null, 
            expense: amount,
            timestamp: new Date().toISOString()
        });

        document.getElementById('personalExpenseAmount').value = '';
        saveState();
        showToast("–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ –∫–æ—à—É–ª–¥—É. üí∞");
    }
    
    function undoLastTransaction() {
        if (transactionLog.length === 0) return;
        
        if (!confirm("–ê–∫—ã—Ä–∫—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) return;
        
        const lastTransaction = transactionLog.pop();
        
        if (lastTransaction.type === 'expense') {
            PERSONAL_EXPENSE_TODAY -= lastTransaction.amount;
        } else {
            const bank = bankLimits.find(b => b.name === lastTransaction.bank);
            if (bank) {
                if (lastTransaction.type === 'income') {
                    bank.income -= lastTransaction.amount;
                } else if (lastTransaction.type === 'outcome') {
                    bank.outcome -= lastTransaction.amount;
                }
                
                const turnoverAfterUndo = bank.income + bank.outcome;
                if (bank.isAutoRest && turnoverAfterUndo < bank.baseLimit) {
                    bank.isAutoRest = false;
                    bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false;
                    showToast(`${bank.name} –ê–≤—Ç–æ-–≠—Å –∞–ª—É—É–¥–∞–Ω —á—ã–∫—Ç—ã. ‚úÖ`, 'success');
                }
            }
        }
        
        if (PERSONAL_EXPENSE_TODAY < 0) PERSONAL_EXPENSE_TODAY = 0; 

        saveState();
        showToast("–ê–∫—ã—Ä–∫—ã –∞—Ä–∞–∫–µ—Ç –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—ã–ª–¥—ã. ‚Ü©Ô∏è");
    }
    
    // --- RECOMMENDATION LOGIC (Unchanged) ---

    function generateRecommendations() {
        const list = document.getElementById('recommendationList');
        list.innerHTML = '';
        const recommendations = [];

        const totalIncome = bankLimits.reduce((sum, b) => b.isResting ? sum : sum + b.income, 0);
        const totalOutcome = bankLimits.reduce((sum, b) => b.isResting ? sum : sum + b.outcome, 0);
        const balance = totalIncome - totalOutcome;
        const estimatedProfit = totalIncome * (SPREAD / 100) - PERSONAL_EXPENSE_TODAY; 
        
        if (estimatedProfit > 2000) {
            recommendations.push(`<li class="recommend-profit">üí∏ **–ò–π–≥–∏–ª–∏–∫, –ë—Ä–æ!** –ü–∞–π–¥–∞: ${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º. –ñ–∞–∫—à—ã —Ç–µ–º–ø! –£—à—É–Ω—É –∫–∞—Ä–º–∞, –∏–π–≥–∏–ª–∏–∫! üëë</li>`);
        } else if (estimatedProfit < 0) {
            recommendations.push(`<li class="recommend-high">üö® **–ê–±–∞–π–ª–∞, –ë—Ä–æ!** –ü–∞–π–¥–∞ —Ç–µ—Ä—Å (${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º). –ß—ã–≥—ã—à-–ö–∏—Ä–∏—à –±–∞–ª–∞–Ω—Å—ã–Ω —Ç–µ–∑–∏—Ä—ç—ç–∫ –∫–∞—Ä–∞–ø –∫–æ–π!</li>`);
        } else if (totalIncome > 10000 && estimatedProfit < 500) {
            recommendations.push(`<li>‚è≥ **–ö“Ø—Ç”©–±“Ø–∑, –ë—Ä–æ!** –ü–∞–π–¥–∞ –∞–∑. –°–ø—Ä–µ–¥–¥–∏/–ö—É—Ä—Å—Ç—É –∫–∞—Ä–∞–ø, –∏—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∂–∞—Å–∞–ø –∫”©—Ä! üéØ</li>`);
        }

        if (Math.abs(balance) > 75000) { 
             const type = balance > 0 ? '–ö”®–ë“Æ–†”®”®–ö –°–ê–¢–´–ü –ê–õ' : '–ö”®–ë“Æ–†”®”®–ö –°–ê–¢';
             recommendations.push(`<li class="recommend-high">‚ùóÔ∏è **–¢–ï“¢–î”®”® –ö–ï–†–ï–ö:** ${type}, –ë—Ä–æ! –ê–π—Ä—ã–º–∞—á—ã–ª—ã–∫ ${Math.abs(balance).toLocaleString('ru-RU')} –°–æ–º. –û–±–æ—Ä–æ—Ç—Ç—É —Ç–µ“£–¥–µ–ø –∫–æ–π—á—É —ç—ç.</li>`);
        } else if (Math.abs(balance) > 30000) {
             recommendations.push(`<li class="recommend-low">üü° **–ê–ó–´–† –û“¢–î–û!** –ñ–µ“£–∏–ª –¥–∏—Å–±–∞–ª–∞–Ω—Å (${Math.abs(balance).toLocaleString('ru-RU')} –°–æ–º). –ö–∏–π–∏–Ω–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è“£–¥—ã —Ç—É—É—Ä–∞ –±–∞–≥—ã—Ç—Ç–∞ –∫—ã–ª, –î–æ—Å.</li>`);
        }
        
        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;
            const percentageUsed = (turnover / bank.baseLimit) * 100;

            if (bank.isAutoRest) { 
                recommendations.push(`<li class="recommend-high">üõë **–ê–í–¢–û-–≠–° –ê–õ–£–£! ${bank.name}** –ª–∏–º–∏—Ç–∏ —Ç–æ–ª—É–ø, –∫—É–ª–ø—É–ª–∞–Ω–¥—ã. –ë“Ø–≥“Ø–Ω–∫“Ø –∏—à –±“Ø—Ç—Ç“Ø, –ë—Ä–æ!</li>`);
            } else if (bank.isResting) {
                recommendations.push(`<li class="recommend-rest" style="border-left-color: rgba(224, 224, 224, 0.5);">üò¥ **${bank.name}:** –≠—Å –∞–ª—Å—ã–Ω, –ë—Ä–æ. –ê–∑—ã—Ä—ã–Ω—á–∞ –∞–Ω—ã –∫–æ–ª–¥–æ–Ω–±–æ–π —ç–ª–µ –∫–æ–π.</li>`);
            } else if (percentageUsed >= 90 && !bank.isAutoRest) { 
                recommendations.push(`<li class="recommend-low">‚ö†Ô∏è **–ê–ó –ö–ê–õ–î–´!** ${bank.name} 90% –∫–æ–ª–¥–æ–Ω—É–ª–¥—É. –ê–∫—ã—Ä—ã–Ω–¥—ã–∫ –º–µ–Ω–µ–Ω –∞–ª–º–∞—à—Ç—ã—Ä, –ë—Ä–æ. (–ö–∞–ª–¥—ã–∫: ${remainingDaily.toLocaleString('ru-RU')} –°–æ–º).</li>`);
            }
        });
        
        if (SPREAD < 0.45 && SPREAD > 0) {
            recommendations.push(`<li class="recommend-low">üí∞ **–°–ø—Ä–µ–¥ –∞–∑, –ë—Ä–æ:** ${SPREAD.toFixed(2)}%. –ü–∞–π–¥–∞–Ω—ã –∫”©–±”©–π—Ç“Ø—à “Ø—á“Ø–Ω 0.5% –∂–æ–≥–æ—Ä—É–ª–∞—Ç—ã–ø –∫–æ–π—á—É —ç—ç.</li>`);
        }


        if (recommendations.length === 0) {
            list.innerHTML = `<li style="border-left-color: var(--success-color); color: var(--success-color);">–ö–µ—Ä–µ–º–µ—Ç! –ë–∞—Ä–¥—ã–≥—ã –æ–ø—Ç–∏–º–∞–ª–¥—É—É! –ú—ã–∫—Ç—ã—Å—ã“£, –î–æ—Å! –≠–º–∏ –∏—à—Ç–µ, –∏–π–≥–∏–ª–∏–∫! ‚ú®</li>`;
        } else {
            list.innerHTML = recommendations.join('');
        }
    }
    
    // --- UTILITY (Changed to use decodeData) ---

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        toast.textContent = message;
        
        let borderColor = 'var(--accent-neon)'; 
        
        if (type === 'danger') {
             borderColor = 'var(--danger-color)'; 
        } else if (type === 'warning') {
             borderColor = 'var(--accent-gold)'; 
        } else if (type === 'success') {
             borderColor = 'var(--success-color)';
        }

        toast.style.borderColor = borderColor;
        toast.style.boxShadow = `0 0 10px ${borderColor}`;
        toast.classList.add('toast-show');
        setTimeout(() => {
            toast.classList.remove('toast-show');
        }, 3000);
    }
    
    function renderHistory() {
        const storedHistory = localStorage.getItem(STORAGE_HISTORY);
        let history = [];
        if (storedHistory) {
             const decodedHistory = decodeData(storedHistory);
             if (decodedHistory) history = decodedHistory;
        }

        const historyBody = document.getElementById('historyBody');
        historyBody.innerHTML = '';
        
        let totalProfit = 0;

        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach((session) => {
            const date = new Date(session.date).toLocaleDateString('ru-RU');
            const row = historyBody.insertRow();
            row.onclick = () => showHistoryDetails(session);
            
            const cellDate = row.insertCell(0);
            const cellTurnover = row.insertCell(1);
            const cellProfit = row.insertCell(2);
            
            cellDate.textContent = date;
            cellTurnover.textContent = session.turnover.toLocaleString('ru-RU');
            cellProfit.textContent = session.profit.toLocaleString('ru-RU');

            totalProfit += session.profit;
        });
        
        document.getElementById('totalHistoryProfit').textContent = totalProfit.toLocaleString('ru-RU');
    }
    
    function showHistoryDetails(session) {
        let details = `–û—Ç—á–µ—Ç: ${new Date(session.date).toLocaleString('ru-RU')}\n\n`;
        details += `–û–±—â–∏–π –û–±–æ—Ä–æ—Ç: ${session.turnover.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–¢–∞–∑–∞ –ü–∞–π–¥–∞: ${session.profit.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: ${session.expenses.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–ñ–∞“£—ã –°–ø—Ä–µ–¥: ${session.newSpread.toFixed(2)}%\n`;
        details += `______________________\n`;
        details += `–ë–∞–Ω–∫—Ç–∞—Ä –±–æ—é–Ω—á–∞ –û–±–æ—Ä–æ—Ç:\n`;
        
        session.banks.forEach(bank => {
            const status = bank.isAutoRest ? '(–ê–í–¢–û-–≠–° –ê–õ–£–£)' : (bank.isResting ? '(–≠–° –ê–õ–£–£–î–ê)' : '(–ò–®–¢–ï)');
            details += `\n${bank.name} ${status}:\n`;
            details += `  –ö–∏—Ä–∏—à: ${bank.income.toLocaleString('ru-RU')}\n`;
            details += `  –ß—ã–≥—ã—à: ${bank.outcome.toLocaleString('ru-RU')}\n`;
            details += `  –ö“Ø–Ω. –ö–∞–ª–¥—ã–∫: ${bank.remainingDaily.toLocaleString('ru-RU')}\n`;
        });
        
        alert(details);
    }
    
    function clearAllData() {
        if (confirm("–≠–°–ö–ï–†–¢“Æ“Æ: –ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã (–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä, –¢–∞—Ä—ã—Ö, –£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω) —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.clear();
            showToast("–ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø. –ö–∞–π—Ä–∞ –∂“Ø–∫—Ç”©–ª”©—Ç. üí•", 'danger');
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }
    }

    function resetCurrentDay() {
        if (confirm("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω–¥“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã–Ω (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä, —Ä–∞—Å—Ö–æ–¥–¥–æ—Ä) —Ç–∞–∑–∞–ª–æ–æ–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            bankLimits.forEach(bank => {
                bank.income = 0;
                bank.outcome = 0;
                bank.isAutoRest = false; 
                bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false; 
            });
            transactionLog = [];
            PERSONAL_EXPENSE_TODAY = 0;
            
            localStorage.removeItem(STORAGE_TRANSACTION_LOG);
            localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
            saveState();
            showToast("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. ‚Ü©Ô∏è", 'danger');
        }
    }

    function exportHistoryToCSV() {
        const storedHistory = localStorage.getItem(STORAGE_HISTORY);
        let history = [];
        if (storedHistory) {
             const decodedHistory = decodeData(storedHistory);
             if (decodedHistory) history = decodedHistory;
        }

        if (history.length === 0) {
            showToast("–≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω —Ç–∞—Ä—ã—Ö –∂–æ–∫.", 'warning');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "–î–∞—Ç–∞;–û–±–æ—Ä–æ—Ç (–°–æ–º);–ü–∞–π–¥–∞ (–°–æ–º);–≠—Å–∫–∏ –°–ø—Ä–µ–¥ (%);–ñ–∞“£—ã –°–ø—Ä–µ–¥ (%);–ö–∞–ª–¥—ã–∫ (–°–æ–º);–†–∞—Å—Ö–æ–¥ (–°–æ–º)\n";

        history.forEach(session => {
            const date = new Date(session.date).toLocaleString('ru-RU').replace(/,/g, '');
            const profit = session.profit.toFixed(2);
            const turnover = session.turnover.toFixed(2);
            const oldSpread = session.oldSpread.toFixed(2);
            const newSpread = session.newSpread.toFixed(2);
            const remaining = session.remainingAmount.toFixed(2);
            const expenses = session.expenses.toFixed(2);

            csvContent += `${date};${turnover};${profit};${oldSpread};${newSpread};${remaining};${expenses}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `p2p_history_export_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("–¢–∞—Ä—ã—Ö CSV —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ —ç–∫—Å–ø–æ—Ä—Ç—Ç–æ–ª–¥—É. üíæ");
    }

    function updateSettings() {
        const newBuyRate = parseFloat(document.getElementById('settingBuyRate').value);
        const newSpread = parseFloat(document.getElementById('settingSpread').value);

        if (!isNaN(newBuyRate) && newBuyRate > 0) BUY_RATE = newBuyRate;
        if (!isNaN(newSpread) && newSpread >= 0) SPREAD = newSpread;
        
        const bankLimitInputs = document.querySelectorAll('#mobileSettingsBody input[type="number"]');
        
        bankLimitInputs.forEach(input => {
            const name = input.getAttribute('data-bank-name');
            const newDaily = parseFloat(input.value);
            
            if (STARTING_LIMITS[name] && !isNaN(newDaily) && newDaily >= 0) {
                 STARTING_LIMITS[name].daily = newDaily;
            }
        });

        syncBankLimits();
        saveState();
        renderSettings();
        showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä —Å–∞–∫—Ç–∞–ª–¥—ã. ‚úÖ");
    }
    
    function addBank() {
        const name = document.getElementById('newBankName').value.trim();
        const dailyLimit = parseFloat(document.getElementById('newBankDailyLimit').value);
        
        if (!name || isNaN(dailyLimit) || dailyLimit <= 0) {
            showToast("–¢—É—É—Ä–∞ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑ (–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç).", 'danger');
            return;
        }

        if (Object.keys(STARTING_LIMITS).includes(name)) {
            showToast("–ú—ã–Ω–¥–∞–π –±–∞–Ω–∫ –º—É—Ä—É–Ω—Ç–∞–Ω –±–∞—Ä.", 'danger');
            return;
        }

        STARTING_LIMITS[name] = { daily: dailyLimit, isResting: false }; 
        syncBankLimits(); 
        saveState();
        
        document.getElementById('newBankName').value = '';
        document.getElementById('newBankDailyLimit').value = '';
        
        renderSettings();
        renderBankOptions();
        showToast(`${name} –∫–æ—à—É–ª–¥—É. ‚úÖ`);
    }

    function removeBank(name) {
        if (!confirm(`${name} –±–∞–Ω–∫—ã–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?`)) return;
        
        delete STARTING_LIMITS[name];
        syncBankLimits(); 
        saveState();
        renderSettings();
        renderBankOptions();
        showToast(`${name} ”©—á“Ø—Ä“Ø–ª–¥“Ø. üóëÔ∏è`);
    }

    function renderSettings() {
        const mobileBody = document.getElementById('mobileSettingsBody');
        mobileBody.innerHTML = '';
        
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;

        let mobileContent = '';
        
        const bankNames = Object.keys(STARTING_LIMITS);

        bankNames.forEach((name) => {
            const bank = bankLimits.find(b => b.name === name) || { name: name, baseLimit: STARTING_LIMITS[name].daily, isResting: STARTING_LIMITS[name].isResting };
            const bankNameClean = bank.name.replace(/\s/g, '');
            const isRestingStatus = STARTING_LIMITS[name].isResting ? 'üò¥ –≠—Å –∞–ª—É—É–¥–∞' : '‚úÖ –ê–¥–∞—Ç—Ç–∞–≥—ã';
            mobileContent += `
                 <div class="bank-settings-card card-block">
                     <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="color: var(--accent-gold);">${bank.name}</h4>
                        <button onclick="removeBank('${bank.name}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8em;">”®–ß“Æ–†“Æ“Æ</button>
                     </div>
                     <p style="font-size: 0.8em; color: rgba(224, 224, 224, 0.6); font-weight: 600;">–£—á—É—Ä–¥–∞–≥—ã –°—Ç–∞—Ç—É—Å: ${isRestingStatus}</p>
                     <div class="modal-field">
                         <label for="mobile-daily-${bankNameClean}" style="color: rgba(224, 224, 224, 0.6);">–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º):</label>
                         <input type="number" id="mobile-daily-${bankNameClean}" data-bank-name="${bank.name}" value="${bank.baseLimit}" min="0">
                     </div>
                 </div>
             `;
        });
        
        mobileBody.innerHTML = mobileContent;
    }
    
    function openCloseSessionModal() {
        document.getElementById('personalExpensesTotal').value = PERSONAL_EXPENSE_TODAY.toFixed(2).toLocaleString('ru-RU');
        document.getElementById('closeSessionModal').style.display = 'flex';
    }

    function closeSession(isFinalClosure) {
        if (!isFinalClosure) {
            openCloseSessionModal();
            return;
        }
        
        const remainingAmount = parseFloat(document.getElementById('remainingAmount').value) || 0;
        const actualProfit = parseFloat(document.getElementById('actualProfitInput').value);
        
        if (isNaN(actualProfit)) {
            alert("–°—É—Ä–∞–Ω—ã—á, –¢–∞–∑–∞ –ü–∞–π–¥–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }

        const totalTurnover = bankLimits.reduce((sum, bank) => {
             return sum + (bank.income + bank.outcome);
        }, 0);
        
        const totalIncome = bankLimits.reduce((sum, bank) => {
             return sum + bank.income;
        }, 0);
        
        let newSpread = SPREAD;
        
        if (totalIncome > 0) {
            newSpread = ((actualProfit + PERSONAL_EXPENSE_TODAY) / totalIncome) * 100; 
        }
        
        const oldSpread = SPREAD;

        SPREAD = parseFloat(newSpread.toFixed(2));
        
        const storedHistory = localStorage.getItem(STORAGE_HISTORY);
        let history = [];
        if (storedHistory) {
             const decodedHistory = decodeData(storedHistory);
             if (decodedHistory) history = decodedHistory;
        }

        const today = new Date();
        
        const totalExpenses = PERSONAL_EXPENSE_TODAY;

        history.push({
            date: today.toISOString(),
            turnover: totalTurnover,
            profit: actualProfit,
            oldSpread: oldSpread,
            newSpread: SPREAD,
            remainingAmount: remainingAmount,
            expenses: totalExpenses,
            banks: bankLimits.map(b => ({
                name: b.name,
                income: b.income,
                outcome: b.outcome,
                turnover: b.income + b.outcome,
                remainingDaily: b.baseLimit - (b.income + b.outcome),
                isResting: b.isResting,
                isAutoRest: b.isAutoRest 
            }))
        });
        
        // SECURITY / PERFORMANCE OPTIMIZATION: History is encoded
        const encodedHistory = encodeData(history);
        if (encodedHistory) localStorage.setItem(STORAGE_HISTORY, encodedHistory);

        // Reset current day state for the new session
        bankLimits.forEach(bank => {
            bank.income = 0;
            bank.outcome = 0;
            bank.isAutoRest = false; 
            bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false; 
        });
        
        // PERFORMANCE OPTIMIZATION: Transaction log is CLEARED after session close
        transactionLog = [];
        PERSONAL_EXPENSE_TODAY = 0;

        localStorage.removeItem(STORAGE_TRANSACTION_LOG);
        localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
        
        const encodedBankLimits = encodeData(bankLimits);
        if (encodedBankLimits) localStorage.setItem(STORAGE_CURRENT_DATA, encodedBankLimits);
        
        saveGlobalSettings(); 
        
        const encodedDate = encodeData(today.toISOString());
        if (encodedDate) localStorage.setItem(STORAGE_LAST_DATE, encodedDate); 

        document.getElementById('closeSessionModal').style.display = 'none';
        document.getElementById('modalProfitDisplay').textContent = `${actualProfit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        document.getElementById('modalNewSpread').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('modalExpenseDisplay').textContent = `${totalExpenses.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        document.getElementById('successModal').style.display = 'flex';
        
        loadState();
        renderHistory();
    }

</script>
</body>
</html>