<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö—Ä–∏–ø—Ç–æ Tracker V24.2 | Auto-Restrictor Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- V24 CORE STYLES (Cyber-Hologram / Neon Lime) --- */
        :root {
            /* 1. –¶–≤–µ—Ç–æ–≤–∞—è –°—Ö–µ–º–∞ */
            --bg-dark: #0f0a1d; /* Deep Indigo / Near-Black */
            --bg-dark-gradient: linear-gradient(135deg, #0f0a1d 0%, #050308 100%);
            --accent-neon: #39FF14; /* Neon Lime / Electric Green (–ê–∫—Ü–µ–Ω—Ç A - Energy) */
            --accent-gold: #ffd700; /* Holographic Gold (–ê–∫—Ü–µ–Ω—Ç B - Premium) */
            --primary-color: var(--accent-neon);
            --danger-color: #ff3366; /* Neon Red */
            --success-color: #00e676; /* Bright Green */
            
            /* 2. –í–∏–∑—É–∞–ª—å–Ω—ã–µ –≠—Ñ—Ñ–µ–∫—Ç—Ç–µ—Ä */
            --bg-card: rgba(25, 20, 45, 0.5); /* Glassmorphism Base */
            --border-neon: 1px solid rgba(57, 255, 20, 0.5);
            --shadow-neon: 0 0 10px rgba(57, 255, 20, 0.7);
            --shadow-gold: 0 0 8px rgba(255, 215, 0, 0.8);
            --glass-filter: backdrop-filter: blur(8px) saturate(180%); -webkit-backdrop-filter: blur(8px) saturate(180%);
            --text-color: #e0e0e0;
        }
        
        html, body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            background: var(--bg-dark-gradient);
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            position: relative;
        }

        /* 3. –§–æ–Ω–æ–≤–∞—è –ê–Ω–∏–º–∞—Ü–∏—è */
        @keyframes network-flow {
            0% { transform: translate(0, 0) scale(1); opacity: 0.1; }
            100% { transform: translate(100px, 100px) scale(1.5); opacity: 0; }
        }

        .background-flow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            opacity: 0.5;
        }

        .network-node {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(57, 255, 20, 0.2); 
            border-radius: 50%;
            animation: network-flow 20s infinite linear alternate;
            box-shadow: 0 0 5px var(--accent-neon);
        }

        .network-node:nth-child(1) { top: 10%; left: 20%; animation-delay: 0s; }
        .network-node:nth-child(2) { top: 50%; left: 80%; animation-delay: 5s; width: 15px; height: 15px; }
        .network-node:nth-child(3) { top: 80%; left: 40%; animation-delay: 10s; }
        
        .container { 
            width: 100%; 
            max-width: 650px;
            margin: auto; 
            padding: 15px; 
            box-sizing: border-box; 
            font-size: 0.95em; 
            position: relative; 
            z-index: 10;
        }
        
        /* --- USER DISPLAY (Chon kylip korunuu) --- */
        .app-header {
             display: flex; 
             justify-content: space-between; 
             align-items: flex-end; 
             margin-bottom: 25px;
        }
        .app-title-nic { 
            font-size: 1.2em; 
            font-weight: 600;
            color: var(--text-color);
            font-family: 'Orbitron', sans-serif;
        }
        #userNicDisplay {
            font-size: 1.5em; 
            font-weight: 900;
            color: var(--accent-neon); 
            text-shadow: var(--shadow-neon); 
        }

        /* --- GLASSMORPHISM CARD BLOCK --- */
        .card-block { 
             display: flex;
             flex-direction: column; 
             gap: 15px; 
             padding: 20px; 
             border-radius: 15px; 
             background-color: var(--bg-card); 
             border: var(--border-neon); 
             box-shadow: var(--shadow-neon), 0 0 20px rgba(0,0,0,0.5);
             margin-bottom: 20px; 
             position: relative;
             backdrop-filter: blur(8px) saturate(180%);
             -webkit-backdrop-filter: blur(8px) saturate(180%);
             transition: box-shadow 0.3s ease-in-out;
        }
        .card-block:hover {
            box-shadow: var(--shadow-neon), 0 0 20px rgba(255, 215, 0, 0.5); 
        }
        
        /* INPUT & SELECT STYLING */
        input[type="number"], input[type="text"], select {
            padding: 12px 15px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 10px; 
            font-size: 1.0em; 
            width: 100%; 
            box-sizing: border-box;
            background-color: rgba(30, 20, 60, 0.7); 
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Inter', sans-serif;
        }
        input:focus, select:focus {
             border-color: var(--accent-neon);
             box-shadow: 0 0 0 4px rgba(57, 255, 20, 0.2); 
             outline: none;
        }
        
        /* BUTTONS (Neon/Gold) */
        .btn {
            padding: 10px 15px; 
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85em; 
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.4s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }
        .btn-primary { 
             background: var(--accent-neon); 
             color: var(--bg-dark); 
             box-shadow: 0 0 10px rgba(57, 255, 20, 0.7);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }
        
        /* Interactive: Neon Burst/Out-denting */
        .btn:hover:not(:disabled) {
             box-shadow: 0 0 15px var(--accent-gold); 
             transform: translateY(-1px);
        }
        .btn:active:not(:disabled) {
             transform: scale(0.98);
             box-shadow: none;
        }

        /* --- MOTIVATIONAL / PROFIT BOX (Neon Glow / Gold Border) --- */
        .profit-motivation-box {
            margin-top: 25px; 
            padding: 25px; 
            background: rgba(15, 5, 30, 0.7); 
            color: var(--text-color);
            border-radius: 20px;
            box-shadow: 0 0 20px var(--accent-gold);
            text-align: center;
            border: 2px solid var(--accent-gold);
            transition: all 0.5s ease;
        }

        .profit-value-large { 
            font-size: 3.5em; 
            margin: 10px 0; 
            font-weight: 900;
            color: var(--accent-neon); 
            text-shadow: 0 0 10px var(--accent-neon); 
            font-family: 'Orbitron', sans-serif;
            overflow: hidden; 
            line-height: 1;
        }
        
        /* --- BANK CARDS (Neon Indicators) --- */
        #mobileCardView {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 15px; 
             margin-top: 15px;
        }
        .bank-card {
            padding: 15px 20px;
            border-left: 5px solid var(--accent-neon);
            transition: border-left-color 0.3s;
        }
        .bank-card:hover {
             border-left-color: var(--accent-gold);
        }
        .card-item .item-value {
             font-weight: 700;
        }
        .card-item .success { color: var(--success-color); }
        .card-item .danger { color: var(--danger-color); }
        .card-item .item-label { color: rgba(224, 224, 224, 0.6); }

        /* --- INTELLIGENT RECOMMENDATIONS (Enhanced & BRO-ADVICE) --- */
        .recommendation-section {
             margin-top: 25px; /* –ë–∞–Ω–∫—Ç–∞—Ä–¥—ã–Ω —Å—Ç–∞—Ç—É—Å—É–Ω–∞–Ω –∫–∏–π–∏–Ω */
             border: 2px dashed var(--accent-neon); 
             padding: 20px; 
             gap: 10px; 
             background-color: rgba(10, 5, 20, 0.6); 
             border-radius: 15px;
        }
        .recommendation-section h3 { 
             color: var(--accent-neon); 
             text-shadow: 0 0 5px rgba(57, 255, 20, 0.5);
             font-family: 'Orbitron', sans-serif;
             font-size: 1.4em; /* –ß–æ“£—É—Ä–∞–∞–∫ –∞—Ç–∞–ª—ã—à */
             border-bottom: 2px solid rgba(57, 255, 20, 0.5); 
             padding-bottom: 8px;
             margin-top: 0;
        }
        #recommendationList li {
             list-style: none;
             padding: 10px 0;
             border-left: 3px solid var(--accent-gold); /* –ê–∫—Ü–µ–Ω—Ç –ê–ª—Ç—ã–Ω */
             padding-left: 15px;
             margin-bottom: 8px;
             background-color: rgba(255, 255, 255, 0.03); 
             border-radius: 5px;
             font-size: 1.1em; /* –û–∫—É—É–≥–∞ —ã–Ω–≥–∞–π–ª—É—É (—É–¥–æ–±–Ω—ã–π) —á–æ“£–¥—É–∫ */
             transition: all 0.2s;
             line-height: 1.4;
        }
        .recommend-high { color: var(--danger-color); font-weight: 700; }
        .recommend-low { color: var(--accent-neon); }
        .recommend-profit { color: var(--accent-gold); font-weight: 700; }
        
        /* History & Others - Adjustments for new theme */
        .history-table thead th {
             background-color: rgba(57, 255, 20, 0.1); 
             color: var(--accent-neon);
             font-weight: 700;
        }
        .total-row th {
             background-color: rgba(255, 215, 0, 0.1) !important;
             color: var(--accent-gold);
             font-weight: 900;
        }
        
        /* Modal & Toast Styles */
        .modal-overlay {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
             background: rgba(0, 0, 0, 0.8); z-index: 1000; 
             display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: rgba(20, 15, 40, 0.9);
            color: var(--text-color);
            border: 2px solid var(--accent-neon);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.5);
            max-width: 90%; 
            width: 400px;
        }
        .toast-message {
            visibility: hidden; min-width: 250px; background-color: rgba(5, 5, 15, 0.8);
            color: #fff; text-align: center; border-radius: 8px; padding: 16px; 
            position: fixed; z-index: 1001; left: 50%; bottom: 30px; 
            transform: translateX(-50%); font-size: 17px; 
            border: 2px solid var(--accent-neon);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
        }
        .toast-show {
            visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body onload="init()">

<div class="background-flow">
    <div class="network-node"></div>
    <div class="network-node"></div>
    <div class="network-node"></div>
</div>

<div id="authSection" style="display: none;">
    <div class="auth-box card-block" style="text-align: center; max-width: 350px; margin: auto; margin-top: 50px;">
        <h2 id="authTitle" style="color: var(--accent-neon);">üîê –ö–ò–†“Æ“Æ</h2>
        <input type="text" id="authUsername" placeholder="–ù–∏–∫ –∞—Ç—ã“£—ã–∑ (–¢–µ–º–∏—Ä–ª–∞–Ω)" required>
        <button onclick="loginUser()" class="btn btn-primary" id="authButton" style="margin-top: 15px; padding: 12px 20px; font-size: 1em;">üöÄ –£–ª–∞–Ω—Ç—É—É</button>
        <p class="app-title-nic" style="margin-top: 10px; font-size: 0.8em; color: rgba(224, 224, 224, 0.6);">*–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —Å–∏–∑–¥–∏–Ω –Ω–∏–∫–∫–µ —Å–∞–∫—Ç–∞–ª–∞—Ç.</p>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="container">
        
        <div class="app-header">
             <div>
                <h1 style="color: var(--text-color); font-family: 'Orbitron', sans-serif;">–ö–†–ò–ü–¢–û TRACKER <span style="color: var(--accent-neon); text-shadow: var(--shadow-neon); font-size: 1.1em;">V24.2</span></h1>
                <div class="app-title-nic">–ö–æ–ª–¥–æ–Ω—É—É—á—É: <span id="userNicDisplay">–¢–µ–º–∏—Ä–ª–∞–Ω</span></div>
             </div>
             <button onclick="logout()" class="btn btn-secondary" style="padding: 8px 12px; font-size: 0.8em;">üëã –ß—ã–≥—É—É</button>
        </div>
        
        <div class="settings-control-group" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px;">
             <button onclick="showMainTracker()" class="btn btn-primary" id="homeBtn">üè† –¢–†–ï–ö–ï–†</button>
             <button onclick="toggleSettings()" class="btn btn-primary" id="settingsBtn">‚öôÔ∏è –ù–ê–°–¢–†.</button>
             <button onclick="undoLastTransaction()" class="btn btn-danger" id="undoBtn" disabled>‚Ü©Ô∏è –û“¢–î–û–û</button>
             <button onclick="openCloseSessionModal()" class="btn btn-success">‚úîÔ∏è –°–ú–ï–ù–ê</button> 
        </div>
        
        <div id="settingsSection" style="display:none;" class="card-block">
            <h2>üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä</h2>
            
            <div class="settings-control-group" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                 <div class="modal-field">
                     <label style="color: rgba(224, 224, 224, 0.6);">BUY Rate (USD):</label>
                     <input type="number" id="settingBuyRate" step="0.01">
                 </div>
                 <div class="modal-field">
                    <label style="color: rgba(224, 224, 224, 0.6);">Spread (%):</label>
                    <input type="number" id="settingSpread" step="0.01">
                 </div>
            </div>
            
            <button onclick="updateSettings()" class="btn btn-primary" style="margin-bottom: 15px; font-size: 0.9em;">–ë–∞–∞—Ä—ã–Ω –°–∞–∫—Ç–æ–æ</button>

            <h3 style="margin-top: 15px; color: var(--accent-neon);">üè¶ –ë–∞–Ω–∫ –õ–∏–º–∏—Ç—Ç–µ—Ä–∏</h3>
            <div id="mobileSettingsBody">
                </div>

            <div class="card-block" style="margin-top: 15px; border: 2px dashed rgba(255, 215, 0, 0.5); padding: 15px; gap: 10px; background-color: rgba(30, 20, 60, 0.7);">
                <h3 style="margin-top: 0; color: var(--success-color);">‚ûï –ñ–∞“£—ã –ë–∞–Ω–∫</h3>
                <input type="text" id="newBankName" placeholder="–ñ–∞“£—ã –ë–∞–Ω–∫ –ê—Ç—ã">
                <input type="number" id="newBankDailyLimit" placeholder="–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º)">
                <button onclick="addBank()" class="btn btn-success">+ –ë–ê–ù–ö –ö–û–®–£–£</button>
            </div>
            
            <h3 style="margin-top: 20px; color: var(--danger-color);">üî• –ö–û–û–ü–¢–£–£ –ó–û–ù–ê</h3>
            <div class="settings-control-group" style="grid-template-columns: 1fr 1fr;">
                <button onclick="exportHistoryToCSV()" class="btn btn-secondary">üíæ CSV –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button onclick="resetCurrentDay()" class="btn btn-danger">‚Ü©Ô∏è –ö“Æ–ù–î“Æ –¢–ê–ó–ê–õ–û–û</button>
                <button onclick="clearAllData()" class="btn btn-danger" style="grid-column: 1 / span 2;">üí£ –ë–ê–ê–†–´–ù ”®–ß“Æ–†“Æ“Æ</button>
            </div>
        </div>

        <div id="trackerView">
            
            <div id="transactionForm" class="card-block">
                 <h3 style="margin-top: 0; color: var(--accent-gold);">üöÄ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ö–æ—à—É—É</h3>
                 <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="modal-field" style="flex-grow: 1; flex-basis: 45%;">
                       <label style="color: rgba(224, 224, 224, 0.6);">–¢“Ø—Ä“Ø:</label>
                       <select id="actionType" >
                           <option value="income">–ö–∏—Ä–∏—à (–°–∞—Ç—É—É)</option>
                           <option value="outcome">–ß—ã–≥—ã—à (–°–∞—Ç—ã–ø –∞–ª—É—É)</option>
                       </select>
                    </div>
                    <div class="modal-field" style="flex-grow: 1; flex-basis: 45%;">
                       <label style="color: rgba(224, 224, 224, 0.6);">–°—É–º–º–∞ (–°–æ–º):</label>
                       <input type="number" id="transactionAmount" placeholder="–°—É–º–º–∞" min="1">
                    </div>
                 </div>
                 <div class="modal-field">
                    <label style="color: rgba(224, 224, 224, 0.6);">–ë–∞–Ω–∫:</label>
                    <select id="transactionBank"></select>
                 </div>
                 <button onclick="logTransaction()" class="btn btn-primary" style="font-size: 1em; padding: 12px 15px;">‚ûï –ö–û–®–£–£</button>
            </div>

            <h3 style="margin-top: 30px; color: var(--accent-neon); text-shadow: var(--shadow-neon);">üè¶ –ë–∞–Ω–∫—Ç–∞—Ä–¥—ã–Ω –°—Ç–∞—Ç—É—Å—É</h3>
            <div id="mobileCardView"></div>
            
            <div class="card-block recommendation-section">
                <h3>üí° –ë–†–û-–°–û–í–ï–¢–¢–ï–†: –ê–∫—ã–ª–¥—É—É –ê–Ω–∞–ª–∏–∑</h3>
                <ul id="recommendationList">
                    <li>–°–∏—Å—Ç–µ–º–∞ —É—á—É—Ä–¥–∞ –∞–Ω–∞–ª–∏–∑ –∂“Ø—Ä–≥“Ø–∑“Ø“Ø–¥”©...</li>
                </ul>
            </div>
            <div class="profit-motivation-box">
                <h2 style="color: var(--accent-gold); text-shadow: var(--shadow-gold);">‚ú® –ö“Ø–Ω–¥“Ø–∫ –ü–∞–π–¥–∞ –ñ—ã–π—ã–Ω—Ç—ã–≥—ã</h2>
                <div class="profit-value-large" id="estimatedProfit">0.00 –°–æ–º</div>
                <div id="motivationMessage" style="font-size: 1.0em; font-weight: 600; padding: 8px; border-radius: 8px; background-color: rgba(57, 255, 20, 0.1); color: var(--accent-neon); margin-top: 15px; border: 1px dashed var(--accent-neon);">
                    "–ê—Ä–∞–∫–µ—Ç –∫—ã–ª! –ë“Ø–≥“Ø–Ω–∫“Ø –∫“Ø–Ω–¥“Ø–Ω –ø–∞–π–¥–∞—Å—ã —Å–∏–∑–¥–∏–Ω –∫–æ–ª—É“£—É–∑–¥–∞. üí™"
                </div>
                <p style="font-size: 0.8em; color: rgba(224, 224, 224, 0.6); margin-top: 15px;">(–ö—É—Ä—Å: <span id="buyRateDisplay">88.0</span> / –°–ø—Ä–µ–¥: <span id="spreadDisplay">0.5%</span>)</p>
            </div>
            
            <div id="expenseForm" class="card-block" style="border: 2px solid var(--danger-color);">
                <h3 style="color: var(--danger-color); margin-top: 0;">üõí –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥</h3>
                <div class="modal-field">
                    <input type="number" id="personalExpenseAmount" placeholder="–†–∞—Å—Ö–æ–¥ –°—É–º–º–∞—Å—ã (–°–æ–º)" min="1">
                </div>
                <button onclick="logPersonalExpense()" class="btn btn-danger" style="font-size: 0.9em;">üî• –†–ê–°–•–û–î–î–£ –ö–ò–†–ì–ò–ó“Æ“Æ</button>
                <div id="personalExpenseSummary" style="margin-top: 5px; font-weight: bold; font-size: 0.85em; text-align: center; color: rgba(224, 224, 224, 0.6);">
                    –ñ–∞–ª–ø—ã –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): 0.00 –°–æ–º
                </div>
            </div>

            <div class="history-section" style="margin-top: 30px;">
                <h2 id="historyHeader" style="color: var(--accent-gold); text-shadow: var(--shadow-gold);">üìä ”®—Ç–∫”©–Ω –°–º–µ–Ω–∞–ª–∞—Ä (–ò—Å—Ç–æ—Ä–∏—è)</h2>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–±. –û–±–æ—Ä–æ—Ç</th>
                                <th>–ü–∞–π–¥–∞</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                         <tfoot>
                            <tr class="total-row">
                                <th colspan="2">–ñ–ê–õ–ü–´ –¢–ê–†–´–•–´–ô –ü–ê–ô–î–ê</th>
                                <th id="totalHistoryProfit">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
        </div>

    </div>
</div>

<div id="closeSessionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card-block">
        <h2>–°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£</h2>
        <p style="font-size: 0.9em; color: rgba(224, 224, 224, 0.6);">–ö–∞–ª–¥—ã–∫ –∫–∞—Ä–∞–∂–∞—Ç—Ç–∞—Ä–¥—ã –∂–∞–Ω–∞ —Ç–∞–∑–∞ –ø–∞–π–¥–∞–Ω—ã —Ç–∞–∫—Ç–æ–æ “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.</p>

        <div class="modal-field">
            <label for="remainingAmount">üí∞ –°–∞—Ç—ã–ª–±–∞–π –ö–∞–ª–≥–∞–Ω –ö–∞–ª–¥—ã–∫ –°—É–º–º–∞ (–°–æ–º)</label>
            <input type="number" id="remainingAmount" value="0" placeholder="–ú–∏—Å–∞–ª—ã: 90000">
        </div>

        <div class="modal-field">
            <label for="personalExpensesTotal">üõí –ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞)</label>
            <input type="text" id="personalExpensesTotal" value="0.00" disabled style="background-color: rgba(30, 20, 60, 0.7);">
        </div>

        <div class="modal-field">
            <label for="actualProfitInput">üí∏ –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑–¥—ã –ö–∏—Ä–≥–∏–∑–∏“£–∏–∑ (–°–æ–º)</label>
            <input type="number" id="actualProfitInput" placeholder="–ú–∏—Å–∞–ª—ã: 12500">
            <p style="font-size: 0.7em; color: rgba(224, 224, 224, 0.6); margin-top: 5px;">*–ë—É–ª –º–∞–∞–Ω–∏–≥–µ –∫–∞—Ä–∞–ø –°–ø—Ä–µ–¥ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© —ç—Å–µ–ø—Ç–µ–ª–µ—Ç.</p>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 8px;">
            <button onclick="closeSession(true)" class="btn btn-success" style="flex-grow: 1;">‚úîÔ∏è –°–ú–ï–ù–ê–ù–´ –ë“Æ–¢“Æ–†“Æ“Æ</button>
            <button onclick="document.getElementById('closeSessionModal').style.display='none';" class="btn btn-secondary">‚ùå –ñ–ê–ë–£–£</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card-block" style="text-align: center;">
        <span class="fireworks" style="font-size: 3em; display: block; margin-bottom: 5px; color: var(--accent-gold); text-shadow: var(--shadow-gold);">üéâ</span>
        <h2 style="color: var(--success-color);">–ò–ô–ì–ò–õ–ò–ö–¢“Æ“Æ! –°–ú–ï–ù–ê –ñ–ê–ë–´–õ–î–´!</h2>
        <p style="font-size: 1.2em;">–°–∏–∑–¥–∏–Ω –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑:</p>
        <div class="profit-value-large" style="color: var(--accent-neon); font-size: 2.5em; text-shadow: var(--shadow-neon);" id="modalProfitDisplay">0.00 –°–æ–º</div>
        <div style="margin-top: 5px; font-weight: 600; font-size: 0.9em; color: var(--accent-neon);">–ñ–∞“£—ã –≠—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –°–ø—Ä–µ–¥: <span id="modalNewSpread" style="color: var(--accent-gold);">0.0%</span></div>
        <div style="margin-top: 5px; font-weight: 600; font-size: 0.9em;">–ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: <span id="modalExpenseDisplay">0.00 –°–æ–º</span></div>
        <button onclick="document.getElementById('successModal').style.display='none';" class="btn btn-primary" style="margin-top: 15px;">–£–ª–∞–Ω—Ç—É—É</button>
    </div>
</div>

<div id="toastNotification" class="toast-message">–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø! ‚úÖ</div>


<script>
    // --- STORAGE KEYS (V24) ---
    const STORAGE_CURRENT_DATA = 'p2p_tracker_v24_data';
    const STORAGE_HISTORY = 'p2p_history_v24';
    const STORAGE_LAST_DATE = 'p2p_last_session_date_v24';
    const STORAGE_SETTINGS = 'p2p_settings_v24';
    const STORAGE_TRANSACTION_LOG = 'p2p_transaction_log_v24';
    const STORAGE_PERSONAL_EXPENSE = 'p2p_personal_expense_v24';
    const STORAGE_AUTH_CREDENTIALS = 'p2p_auth_username_v24'; 
    const STORAGE_AUTH_STATUS = 'p2p_auth_status_v24'; 

    let BUY_RATE = 88.0;
    let SPREAD = 0.5; 
    let PERSONAL_EXPENSE_TODAY = 0; 
    let lastEstimatedProfit = 0; 

    let STARTING_LIMITS = {
        "Optima24": { daily: 35000, isResting: false }, 
        "DemirBank": { daily: 25000, isResting: false }, 
        "Mbank": { daily: 20000, isResting: false }
    };

    let bankLimits = [];
    let transactionLog = [];
    let currentView = 'tracker'; 
    let CURRENT_USER_NIC = null; 

    // --- MOTIVATION MESSAGES (Enhanced and Cyber Themed) ---
    const MOTIVATION_MESSAGES = [
        "–ê—Ä–∞–∫–µ—Ç –∫—ã–ª! –ë“Ø–≥“Ø–Ω–∫“Ø –∫“Ø–Ω–¥“Ø–Ω –ø–∞–π–¥–∞—Å—ã —Å–∏–∑–¥–∏–Ω –∫–æ–ª—É“£—É–∑–¥–∞. üí™ (Data Stream: Optimal)",
        "–ê—Ä –±–∏—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è - –±—É–ª –∏–π–≥–∏–ª–∏–∫–∫–µ –∫–∞—Ä–∞–π –±–∏—Ä –∫–∞–¥–∞–º. üöÄ (Matrix Status: Green)",
        "–ë“Ø–≥“Ø–Ω —Å–∏–∑ —Ä–µ–∫–æ—Ä–¥ –∂–∞—Ä–∞—Ç—ã—à—ã“£—ã–∑ –∫–µ—Ä–µ–∫! –ê–õ–ì–ê! üåü (Target Acquisition: Active)",
        "–≠“£ –º—ã–∫—Ç—ã –ø–∞–π–¥–∞ –∞–ª—É—É “Ø—á“Ø–Ω –∞–∫—ã–ª–¥—É—É–ª—É–∫ –º–µ–Ω–µ–Ω —Å–æ–æ–¥–∞ –∫—ã–ª—ã“£—ã–∑. üí° (System Alert: Profit Mode)",
        "–≠—á –∫–∞—á–∞–Ω —Ç–æ–∫—Ç–æ–±–æ! –°–∏–∑–¥–∏–Ω –º–∞–∫—Å–∞—Ç—Ç–∞—Ä—ã“£—ã–∑ –∂–∞–∫—ã–Ω–¥–∞. üéØ (Financial Flow: Unrestricted)",
        "–ß–æ“£ –ø–∞–π–¥–∞–ª–∞—Ä –∫–∏—á–∏–Ω–µ–∫–µ–π –∫–∞–¥–∞–º–¥–∞—Ä–¥–∞–Ω –±–∞—à—Ç–∞–ª–∞—Ç. ‚ú® (Execute Trade: Now)",
        "–ö“Ø–Ω“Ø–º–¥“Ø–∫ –ø–∞–π–¥–∞“£—ã–∑–¥—ã –∫”©—Ä“Ø–ø, –º–æ—Ç–∏–≤–∞—Ü–∏—è –∞–ª—ã“£—ã–∑! üìà (Cyber-Profit: Initiated)"
    ];

    function getMotivationMessage(estimatedProfit) {
        if (estimatedProfit > 15000) {
            return `–£–∫–º—É—à! –ü–∞–π–¥–∞: ${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º. –°–∏–∑ –º—ã–∫—Ç—ã—Å—ã–∑! üéâ (Core System: EXCELLENT)`;
        }
        if (estimatedProfit > 5000) {
            return `–ñ–∞–∫—à—ã –∏—à! –ü–∞–π–¥–∞: ${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º. –£–ª–∞–Ω—Ç—ã“£—ã–∑! üëç (Status: Elevated)`;
        }
        if (estimatedProfit < 0) {
            return "–ö”©–∑”©–º”©–ª–¥”©“£“Ø–∑! –ü–∞–π–¥–∞ —Ç–µ—Ä—Å –±–æ–ª—É–ø –∂–∞—Ç–∞—Ç. –ö”©–±“Ø—Ä”©”©–∫ —Å–∞—Ç—ã“£—ã–∑! ‚ö†Ô∏è (System Alert: Deficiency)";
        }
        
        const randomIndex = Math.floor(Math.random() * MOTIVATION_MESSAGES.length);
        return MOTIVATION_MESSAGES[randomIndex];
    }
    
    // --- AUTH, VIEW TOGGLE, INIT (Functions kept for structure) ---
    
    function displayUserName() { 
        document.getElementById('userNicDisplay').textContent = CURRENT_USER_NIC || '–ö–æ–ª–¥–æ–Ω—É—É—á—É';
    }

    function checkAuthStatus() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        const authStatus = localStorage.getItem(STORAGE_AUTH_STATUS);
        
        if (authStatus === 'logged_in' && storedNic) {
            CURRENT_USER_NIC = storedNic;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadState(); 
            initTrackerContent();
        } else {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    }

    function loginUser() {
        const username = document.getElementById('authUsername').value.trim();

        if (username.length < 3) {
            showToast("–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã (–ù–∏–∫) 3 —Å–∏–º–≤–æ–ª—É–Ω–∞–Ω –∫–µ–º –±–æ–ª–±–æ—Å—É–Ω.", 'danger');
            return;
        }

        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);

        if (!storedNic || storedNic === username) {
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        } else {
             if (!confirm(`–≠–°–ö–ï–†–¢“Æ“Æ: –ú—É—Ä—É–Ω–∫—É –∫–æ–ª–¥–æ–Ω—É—É—á—É "${storedNic}" –±–æ–ª–≥–æ–Ω. "${username}" –º–µ–Ω–µ–Ω —É–ª–∞–Ω—Ç–∞—Å—ã–∑–±—ã? –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–∏—à–∏ –º“Ø–º–∫“Ø–Ω.`)) {
                 return;
             }
             localStorage.clear(); 
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        }
        
        CURRENT_USER_NIC = username;
        localStorage.setItem(STORAGE_AUTH_STATUS, 'logged_in');
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        loadState(); 
        initTrackerContent();
        showToast(`–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∫–∏—Ä–¥–∏“£–∏–∑: ${username}! üöÄ`);
    }

    function logout() {
        if (confirm("–ß—ã–≥—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.removeItem(STORAGE_AUTH_STATUS); 
            
            document.getElementById('authUsername').value = CURRENT_USER_NIC || '';
            CURRENT_USER_NIC = null;
            
            checkAuthStatus(); 
        }
    }

    function setActiveView(viewName) {
        document.getElementById('trackerView').style.display = 'none';
        document.getElementById('settingsSection').style.display = 'none';
        
        if (viewName === 'tracker') {
            document.getElementById('trackerView').style.display = 'block';
        } else if (viewName === 'settings') {
            renderSettings();
            document.getElementById('settingsSection').style.display = 'block';
        }
        currentView = viewName;
    }

    function showMainTracker() { 
        setActiveView('tracker'); 
        document.getElementById('homeBtn').classList.add('btn-primary');
        document.getElementById('settingsBtn').classList.remove('btn-primary');
    }
    
    function toggleSettings() { 
        const isSettings = currentView === 'settings';
        setActiveView(isSettings ? 'tracker' : 'settings'); 
        
        if (isSettings) {
             document.getElementById('homeBtn').classList.add('btn-primary');
             document.getElementById('settingsBtn').classList.remove('btn-primary');
        } else {
             document.getElementById('homeBtn').classList.remove('btn-primary');
             document.getElementById('settingsBtn').classList.add('btn-primary');
        }
    }
    
    function initTrackerContent() {
        displayUserName(); 
        renderBankOptions(); 
        updateDisplay(); 
        renderHistory();
        generateRecommendations(); 
        setActiveView('tracker');
        showMainTracker();
    }
    
    function init() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        if (storedNic) {
             document.getElementById('authUsername').value = storedNic;
        }

        checkAuthStatus(); 
    }
    
    // --- CORE LOGIC (V24.2) ---

    function saveGlobalSettings() {
        const settings = {
            buyRate: BUY_RATE,
            spread: SPREAD,
            startingLimits: STARTING_LIMITS
        };
        localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
    }

    function loadGlobalSettings() {
        const storedSettings = localStorage.getItem(STORAGE_SETTINGS);
        if (storedSettings) {
            const settings = JSON.parse(storedSettings);
            BUY_RATE = settings.buyRate || 88.0;
            SPREAD = settings.spread || 0.5;
            const loadedLimits = settings.startingLimits || STARTING_LIMITS;
            
            STARTING_LIMITS = {}; 
            for (const name in loadedLimits) {
                 STARTING_LIMITS[name] = { 
                     daily: loadedLimits[name].daily || 0,
                     isResting: loadedLimits[name].isResting || false
                 };
            }
        }
        if (Object.keys(STARTING_LIMITS).length === 0) {
            STARTING_LIMITS = {
                "Optima24": { daily: 35000, isResting: false }, 
                "DemirBank": { daily: 25000, isResting: false }, 
                "Mbank": { daily: 20000, isResting: false }
            };
        }
    }
    
    // V24.2: isAutoRest –∫–æ—à—É–ª–¥—É
    function syncBankLimits() {
         const updatedBankLimits = [];
         for (const name in STARTING_LIMITS) {
             const limits = STARTING_LIMITS[name];
             let existingBank = bankLimits.find(b => b.name === name);
             
             if (existingBank) {
                 existingBank.baseLimit = limits.daily; 
                 existingBank.isResting = limits.isResting;
                 if (existingBank.isAutoRest === undefined) {
                     existingBank.isAutoRest = false;
                 }
                 updatedBankLimits.push(existingBank);
             } else {
                 updatedBankLimits.push({ 
                     name: name, 
                     baseLimit: limits.daily, 
                     income: 0, 
                     outcome: 0, 
                     isResting: limits.isResting,
                     isAutoRest: false 
                 });
             }
         }
         bankLimits = updatedBankLimits.filter(bank => STARTING_LIMITS[bank.name] !== undefined);
         saveGlobalSettings(); 
    }
    
    // V24.2: isAutoRest –∫–æ—à—É–ª–¥—É
    function loadState() {
        loadGlobalSettings();
        
        const storedData = localStorage.getItem(STORAGE_CURRENT_DATA);
        if (storedData) {
            bankLimits = JSON.parse(storedData);
        } else {
            syncBankLimits();
        }
        
        bankLimits.forEach(bank => {
             if (bank.isResting === undefined) {
                 bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false;
             }
             if (bank.isAutoRest === undefined) {
                 bank.isAutoRest = false;
             }
        });
        
        syncBankLimits(); 

        const storedLog = localStorage.getItem(STORAGE_TRANSACTION_LOG);
        if (storedLog) {
            transactionLog = JSON.parse(storedLog);
        }

        const storedExpense = localStorage.getItem(STORAGE_PERSONAL_EXPENSE);
        if (storedExpense) {
            PERSONAL_EXPENSE_TODAY = parseFloat(storedExpense) || 0;
        }
        
        checkNewDay();
        // V24.2: Check all banks status on load to set auto-rest
        bankLimits.forEach(checkBankAutoRest); 
        updateDisplay();
    }

    function saveState() {
        localStorage.setItem(STORAGE_CURRENT_DATA, JSON.stringify(bankLimits));
        localStorage.setItem(STORAGE_TRANSACTION_LOG, JSON.stringify(transactionLog));
        localStorage.setItem(STORAGE_PERSONAL_EXPENSE, PERSONAL_EXPENSE_TODAY.toFixed(2));
        saveGlobalSettings();
        updateDisplay();
        generateRecommendations(); 
    }

    function checkNewDay() {
        const today = new Date();
        const lastSessionDateStr = localStorage.getItem(STORAGE_LAST_DATE);
        
        let isNewDay = false;

        if (lastSessionDateStr) {
            const lastSessionDate = new Date(lastSessionDateStr);
            if (today.toDateString() !== lastSessionDate.toDateString()) {
                isNewDay = true;
            } 
        } else {
             isNewDay = true; 
        }
        
        if (isNewDay) {
            bankLimits.forEach(bank => {
                bank.income = 0;
                bank.outcome = 0;
                // V24.2: Reset AutoRest status at the beginning of the day
                bank.isAutoRest = false; 
                // –ö–æ–ª –º–µ–Ω–µ–Ω –∫–æ—é–ª–≥–∞–Ω resting –¥–∞–≥—ã –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª–∏—à–∏ –∫–µ—Ä–µ–∫ (STARTING_LIMITS –±–æ—é–Ω—á–∞)
                bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false;
            });
            
            transactionLog = [];
            PERSONAL_EXPENSE_TODAY = 0;
            localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
            localStorage.removeItem(STORAGE_TRANSACTION_LOG);
            
            if (lastSessionDateStr) { 
                showToast("–ñ–∞“£—ã –∫“Ø–Ω! –ö“Ø–Ω“Ø–º–¥“Ø–∫ –ª–∏–º–∏—Ç—Ç–µ—Ä —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. ‚òÄÔ∏è");
            }
        }
        
        localStorage.setItem(STORAGE_LAST_DATE, today.toISOString());
    }
    
    // V24.2: New function to check and set Auto-Rest status
    function checkBankAutoRest(bank) {
        const turnover = bank.income + bank.outcome;
        
        // –ê–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ –≠—Å –ê–ª—É—É –ª–æ–≥–∏–∫–∞—Å—ã: –ª–∏–º–∏—Ç—Ç–µ–Ω –∞—à—ã–ø –∫–µ—Ç—Å–µ
        if (turnover > bank.baseLimit) {
            if (!bank.isAutoRest) {
                 bank.isAutoRest = true;
                 bank.isResting = true; // AutoRest –±–æ–ª–≥–æ–Ω–¥–æ Resting –±–æ–ª—É—à—É –∫–µ—Ä–µ–∫
                 // showToast(`${bank.name} –ª–∏–º–∏—Ç–∏ —Ç–æ–ª—É–ø, –ê–í–¢–û –≠–° –ê–õ–£–£ —Ä–µ–∂–∏–º–∏–Ω–µ ”©—Ç—Ç“Ø. üõë`, 'danger'); // logTransaction'–¥–∞ –≥–∞–Ω–∞ –∫”©—Ä—Å”©—Ç“Ø–ª”©—Ç
            }
        } 
        // –≠–≥–µ—Ä –ª–∏–º–∏—Ç—Ç–µ–Ω –∞—à—ã–ø –∫–µ—Ç–ø–µ—Å–µ, AutoRest —Å—Ç–∞—Ç—É—Å—É–Ω ”©–∑–≥”©—Ä—Ç–ø”©–π–±“Ø–∑ (–∞–ª –∂–∞“£—ã –∫“Ø–Ω–¥”© –≥–∞–Ω–∞ —Ç–∞–∑–∞–ª–∞–Ω–∞—Ç)
    }

    function renderBankOptions() {
        const select = document.getElementById('transactionBank');
        select.innerHTML = '';
        
        bankLimits.forEach(bank => {
            // V24.2: AutoRest –∂–µ –∫–æ–ª –º–µ–Ω–µ–Ω Resting –±–æ–ª–≥–æ–Ω–¥–æ—Ä–¥—É –æ–ø—Ü–∏—è–≥–∞ –∫–æ—à–ø–æ–π–±—É–∑
            if (!bank.isResting && !bank.isAutoRest) {
                 const option = document.createElement('option');
                 option.value = bank.name;
                 option.textContent = bank.name;
                 select.appendChild(option);
            }
        });
        
        const transactionButton = document.querySelector('#transactionForm button');

        if (select.children.length === 0) {
             select.innerHTML = '<option value="">(–≠—Å –∞–ª—É—É–¥–∞ –∂–µ –±–∞–Ω–∫ –∂–æ–∫)</option>';
             if (transactionButton) transactionButton.disabled = true;
        } else {
             if (transactionButton) transactionButton.disabled = false;
        }
    }

    // V24.2: renderTable —Ñ—É–Ω–∫—Ü–∏—è—Å—ã–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø (—Å–æ—Ä—Ç—Ç–æ–æ –∂–∞–Ω–∞ AutoRest –∫”©—Ä—Å”©—Ç“Ø“Ø)
    function renderTable() {
        const mobileView = document.getElementById('mobileCardView');
        mobileView.innerHTML = '';
        
        // V24.2: –ë–∞–Ω–∫—Ç–∞—Ä–¥—ã —Å–æ—Ä—Ç—Ç–æ–æ
        const sortedBanks = [...bankLimits].sort((a, b) => {
            // 1. –ê–í–¢–û–ú–ê–¢–¢–´–ö –≠–° –ê–õ–£–£ (—ç“£ –∞–∫—ã—Ä–∫—ã)
            if (a.isAutoRest && !b.isAutoRest) return 1;
            if (!a.isAutoRest && b.isAutoRest) return -1;
            
            // 2. –ö–û–õ –ú–ï–ù–ï–ù –≠–° –ê–õ–£–£ (–∞–∫—ã—Ä–∫—ã–¥–∞–Ω –º—É—Ä—É–Ω)
            if (a.isResting && !b.isResting) return 1;
            if (!a.isResting && b.isResting) return -1;

            // 3. –ò–®–¢–ï–ü –ñ–ê–¢–ö–ê–ù–î–ê–† (–±–∏—Ä–∏–Ω—á–∏ –æ—Ä—É–Ω–¥–∞—Ä)
            // –ö–∞–ª–≥–∞–Ω–¥–∞—Ä–¥—ã –∫–∞–¥–∏–º–∫–∏–¥–µ–π (–∞—Ç—ã –±–æ—é–Ω—á–∞) —Å–æ—Ä—Ç—Ç–æ–π–±—É–∑
            return a.name.localeCompare(b.name);
        });
        
        let mobileCards = '';

        sortedBanks.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;

            let statusText = '';
            let statusEmoji = '';
            let cardClass = '';
            let neonColor = 'var(--accent-neon)';
            let buttonDisabled = '';
            let buttonText = '';

            if (bank.isAutoRest) {
                statusText = '–ê–í–¢–û –≠–° –ê–õ–£–£! (–õ–∏–º–∏—Ç —Ç–æ–ª–¥—É)';
                statusEmoji = 'üõë';
                cardClass = 'auto-rest';
                neonColor = 'var(--danger-color)';
                buttonDisabled = 'disabled'; // –ö–Ω–æ–ø–∫–∞–Ω—ã ”©—á“Ø—Ä“Ø“Ø
                buttonText = 'üîí –ê–í–¢–û-–≠–° –ê–õ–£–£';
            } else if (bank.isResting) {
                statusText = '–ö–æ–ª –º–µ–Ω–µ–Ω –≠—Å –∞–ª—É—É–¥–∞';
                statusEmoji = 'üò¥';
                cardClass = 'resting';
                neonColor = 'rgba(224, 224, 224, 0.5)';
                buttonText = '‚úÖ –ê–î–ê–¢–¢–ê–ì–´';
            } else if (remainingDaily <= 0) {
                // –ë—É–ª –∂–µ—Ä–≥–µ –∫–µ–ª–±–µ—à–∏ –∫–µ—Ä–µ–∫, –∞–Ω—Ç–∫–µ–Ω–∏ AutoRest –±–æ–ª—É—à—É –∫–µ—Ä–µ–∫. –ö–æ–æ–ø—Å—É–∑–¥—É–∫ “Ø—á“Ø–Ω –∫–∞–ª—Ç—ã—Ä—ã–ª–¥—ã.
                statusText = '–ê—à—ã–ø –∫–µ—Ç—Ç–∏!'; 
                statusEmoji = 'üõë';
                neonColor = 'var(--danger-color)';
                buttonText = 'üò¥ –≠–° –ê–õ–£–£';
            } else if (remainingDaily <= bank.baseLimit * 0.10) {
                statusText = '–ê–∑ –∫–∞–ª–¥—ã (10%)';
                statusEmoji = '‚ö†Ô∏è';
                neonColor = 'var(--accent-gold)';
                buttonText = 'üò¥ –≠–° –ê–õ–£–£';
            } else {
                statusText = '–ò—à—Ç–µ–ø –∂–∞—Ç–∞—Ç';
                statusEmoji = '‚úÖ';
                buttonText = 'üò¥ –≠–° –ê–õ–£–£';
            }
            
            mobileCards += `
                <div class="bank-card ${cardClass}" style="border-left-color: ${neonColor};">
                    <div class="card-header">
                        <h3 style="color: ${neonColor};">${statusEmoji} ${bank.name}</h3>
                    </div>
                    <div class="card-item"><span class="item-label">–°—Ç–∞—Ç—É—Å:</span><span class="item-value" style="color: ${neonColor}; font-weight: 700;">${statusText}</span></div>
                    <div class="card-item"><span class="item-label">–ö“Ø–Ω. –õ–∏–º–∏—Ç:</span><span class="item-value">${bank.baseLimit.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ö–∏—Ä–∏—à (–ü—Ä–∏—Ö–æ–¥):</span><span class="item-value success">${bank.income.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ß—ã–≥—ã—à (–†–∞—Å—Ö–æ–¥):</span><span class="item-value danger">${bank.outcome.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ö“Ø–Ω. –û–±–æ—Ä–æ—Ç:</span><span class="item-value" style="color: var(--accent-gold);">${turnover.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-item"><span class="item-label">–ö“Ø–Ω. –ö–∞–ª–¥—ã–∫:</span><span class="item-value" style="color: ${remainingDaily < 0 ? 'var(--danger-color)' : neonColor};">${remainingDaily.toLocaleString('ru-RU')} –°–æ–º</span></div>
                    <div class="card-controls">
                        <button onclick="toggleBankResting('${bank.name}')" class="btn ${bank.isResting && !bank.isAutoRest ? 'btn-success' : 'btn-secondary'}" style="font-size: 0.75em;" ${buttonDisabled}>
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        });
        
        mobileView.innerHTML = mobileCards;
        renderBankOptions(); 
    }
    
    // V24.2: toggleBankResting —Ñ—É–Ω–∫—Ü–∏—è—Å—ã–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø (AutoRest –±–æ–ª—Å–æ –±”©–≥”©—Ç –∫–æ—é—É)
    function toggleBankResting(bankName) {
        const bank = bankLimits.find(b => b.name === bankName);
        if (!bank) return;
        
        // V24.2: –≠–≥–µ—Ä AutoRest –±–æ–ª—Å–æ, –∫–æ–ª –º–µ–Ω–µ–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø–≥”© —Ç—ã—é—É —Å–∞–ª—ã–Ω–∞—Ç
        if (bank.isAutoRest) {
            showToast(`${bankName} –ª–∏–º–∏—Ç–∏ —Ç–æ–ª–≥–æ–Ω. –°—Ç–∞—Ç—É—Å—É–Ω ”©–∑–≥”©—Ä—Ç“Ø“Ø –º“Ø–º–∫“Ø–Ω —ç–º–µ—Å. üõ°Ô∏è`, 'danger');
            return; 
        }
        
        // –≠–≥–µ—Ä–¥–µ AutoRest —ç–º–µ—Å –±–æ–ª—Å–æ, –∫–∞–¥–∏–º–∫–∏–¥–µ–π ”©–∑–≥”©—Ä—Ç”©–±“Ø–∑.
        const isResting = !bank.isResting;
        
        if (isResting) {
             if (!confirm(`${bankName} –±–∞–Ω–∫—ã–Ω –≠–° –ê–õ–£–£ —Ä–µ–∂–∏–º–∏–Ω–µ –∫–æ—é—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã? –ë—É–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä–¥—ã –∫–æ—à—É—É–≥–∞ –±”©–≥”©—Ç –∫–æ—ë—Ç.`)) {
                 return;
             }
        }

        bank.isResting = isResting;
        if (STARTING_LIMITS[bankName]) {
             STARTING_LIMITS[bankName].isResting = isResting;
        }

        saveState();
        showToast(`${bankName} —Å—Ç–∞—Ç—É—Å—É ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø: ${isResting ? 'üò¥ –≠—Å –∞–ª—É—É' : '‚úÖ –ê–¥–∞—Ç—Ç–∞–≥—ã'}`, isResting ? 'warning' : 'success');
    }

    function updateDisplay() {
        renderTable();
        renderProfit();
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;
        
        document.getElementById('spreadDisplay').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('buyRateDisplay').textContent = BUY_RATE.toFixed(1);
        
        document.getElementById('undoBtn').disabled = transactionLog.length === 0;
        document.getElementById('personalExpenseSummary').textContent = `–ñ–∞–ª–ø—ã –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): ${PERSONAL_EXPENSE_TODAY.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;

    }

    function renderProfit() {
        const totalTurnover = bankLimits.reduce((sum, bank) => {
             return bank.isResting ? sum : sum + (bank.income + bank.outcome);
        }, 0);
        
        let estimatedProfit = (totalTurnover / BUY_RATE) * (SPREAD / 100) * BUY_RATE;
        estimatedProfit = estimatedProfit - PERSONAL_EXPENSE_TODAY;
        
        const profitElement = document.getElementById('estimatedProfit');
        
        // --- PROFIT COUNTER ANIMATION ---
        
        // Function to split and animate numbers
        function animateNumber(element, finalValue) {
            const finalString = finalValue.toFixed(2).toLocaleString('ru-RU');
            const duration = 500; // ms
            const steps = 10;
            const stepDuration = duration / steps;
            let currentValue = lastEstimatedProfit;
            let counter = 0;

            const interval = setInterval(() => {
                counter++;
                const diff = finalValue - currentValue;
                currentValue += diff / (steps - counter + 1); 

                if (counter >= steps) {
                    clearInterval(interval);
                    currentValue = finalValue;
                }
                
                const currentString = currentValue.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                // Simple animation: replace text content and trigger CSS animation
                element.innerHTML = currentString.split('').map((char, index) => {
                    if (char === ' ' || char === ',' || char === '.') return char;
                    // Add subtle glow based on profit status
                    let color = 'var(--accent-neon)';
                    if (currentValue < 0) color = 'var(--danger-color)';
                    
                    return `<span style="animation-delay: ${index * 0.05}s; color: ${color}; text-shadow: 0 0 5px ${color};">${char}</span>`;
                }).join('');
                element.innerHTML += ' –°–æ–º';

            }, stepDuration);
        }

        animateNumber(profitElement, estimatedProfit);
        lastEstimatedProfit = estimatedProfit;
        
        // --- End of Animation ---
        
        document.getElementById('motivationMessage').textContent = getMotivationMessage(estimatedProfit);
    }

    // V24.2: checkBankAutoRest –∫–æ—à—É–ª–¥—É
    function logTransaction() {
        const actionType = document.getElementById('actionType').value;
        const amountStr = document.getElementById('transactionAmount').value;
        const bankName = document.getElementById('transactionBank').value;

        if (!amountStr || parseFloat(amountStr) <= 0) {
            showToast("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Å—É–º–º–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }

        const amount = parseFloat(amountStr);
        const bank = bankLimits.find(b => b.name === bankName);
        
        if (!bank) {
             showToast("–ë–∞–Ω–∫ —Ç–∞–Ω–¥–∞–ª–≥–∞–Ω –∂–æ–∫ –∂–µ –∂–æ–∫.", 'danger');
             return;
        }

        // V24.2: Resting –∂–µ AutoRest –±–æ–ª–≥–æ–Ω –±–∞–Ω–∫—Ç–∞—Ä–¥—ã –∫–æ–ª–¥–æ–Ω—É—É–≥–∞ —Ç—ã—é—É —Å–∞–ª—É—É
        if (bank.isResting || bank.isAutoRest) { 
            showToast(`${bankName} –≠—Å –∞–ª—É—É–¥–∞ –∂–µ –õ–∏–º–∏—Ç–∏ —Ç–æ–ª–≥–æ–Ω. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—à—É–ª–≥–∞–Ω –∂–æ–∫.`, 'danger');
            return;
        }
        
        // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –∫–æ—à—É—É
        if (actionType === 'income') {
            bank.income += amount;
        } else {
            bank.outcome += amount;
        }
        
        // V24.2: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–¥–∞–Ω –∫–∏–π–∏–Ω AutoRest'—Ç–∏ —Ç–µ–∫—à–µ—Ä“Ø“Ø
        const wasAutoRestBefore = bank.isAutoRest;
        checkBankAutoRest(bank); 
        
        // –≠–≥–µ—Ä –∂–∞“£—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–¥–∞–Ω –∫–∏–π–∏–Ω AutoRest –±–æ–ª—Å–æ, –∫–æ–ª–¥–æ–Ω—É—É—á—É–≥–∞ –±–∏–ª–¥–∏—Ä“Ø“Ø
        if (bank.isAutoRest && !wasAutoRestBefore) {
             showToast(`${bank.name} –ê–í–¢–û –≠–° –ê–õ–£–£ —Ä–µ–∂–∏–º–∏–Ω–µ ”©—Ç—Ç“Ø. üõë`, 'danger');
        }


        transactionLog.push({ 
            type: actionType, 
            amount: amount, 
            bank: bankName, 
            expense: 0,
            timestamp: new Date().toISOString()
        });

        document.getElementById('transactionAmount').value = '';
        saveState();
        showToast("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—à—É–ª–¥—É. ‚úÖ");
    }

    function logPersonalExpense() {
        const amountStr = document.getElementById('personalExpenseAmount').value;

        if (!amountStr || parseFloat(amountStr) <= 0) {
            showToast("–°—É—Ä–∞–Ω—ã—á, —Ç—É—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥ —Å—É–º–º–∞—Å—ã–Ω –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.", 'danger');
            return;
        }
        
        const amount = parseFloat(amountStr);
        
        PERSONAL_EXPENSE_TODAY += amount;
        
        transactionLog.push({ 
            type: 'expense', 
            amount: amount, 
            bank: null, 
            expense: amount,
            timestamp: new Date().toISOString()
        });

        document.getElementById('personalExpenseAmount').value = '';
        saveState();
        showToast("–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ –∫–æ—à—É–ª–¥—É. üí∞");
    }
    
    function undoLastTransaction() {
        if (transactionLog.length === 0) return;
        
        if (!confirm("–ê–∫—ã—Ä–∫—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) return;
        
        const lastTransaction = transactionLog.pop();
        
        if (lastTransaction.type === 'expense') {
            PERSONAL_EXPENSE_TODAY -= lastTransaction.amount;
        } else {
            const bank = bankLimits.find(b => b.name === lastTransaction.bank);
            if (bank) {
                if (lastTransaction.type === 'income') {
                    bank.income -= lastTransaction.amount;
                } else if (lastTransaction.type === 'outcome') {
                    bank.outcome -= lastTransaction.amount;
                }
                
                // V24.2: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—ã–ª–≥–∞–Ω–¥–∞ AutoRest —Å—Ç–∞—Ç—É—Å—É–Ω –∫–∞–π—Ä–∞ —Ç–µ–∫—à–µ—Ä“Ø“Ø
                const turnoverAfterUndo = bank.income + bank.outcome;
                if (bank.isAutoRest && turnoverAfterUndo <= bank.baseLimit) {
                    // –≠–≥–µ—Ä –ª–∏–º–∏—Ç—Ç–µ–Ω —ã–ª–¥—ã–π —Ç“Ø—à“Ø–ø –∫–µ—Ç—Å–µ, AutoRest'—Ç–∏ –∞–ª—ã–ø —Å–∞–ª–∞–±—ã–∑
                    bank.isAutoRest = false;
                    
                    // –ë–∏—Ä–æ–∫ –∫–æ–ª –º–µ–Ω–µ–Ω –∫–æ—é–ª–≥–∞–Ω Resting'–¥–∏ –∫–∞–ª—Ç—ã—Ä—ã—à—ã–±—ã–∑ –∫–µ—Ä–µ–∫ (STARTING_LIMITS'–∫–µ —ã–ª–∞–π—ã–∫)
                    bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false;
                }
            }
        }
        
        if (PERSONAL_EXPENSE_TODAY < 0) PERSONAL_EXPENSE_TODAY = 0; 

        saveState();
        showToast("–ê–∫—ã—Ä–∫—ã –∞—Ä–∞–∫–µ—Ç –∂–æ–∫–∫–æ —á—ã–≥–∞—Ä—ã–ª–¥—ã. ‚Ü©Ô∏è");
    }
    
    // --- RECOMMENDATION LOGIC (V24.1 BRO-ADVICE) ---

    function generateRecommendations() {
        const list = document.getElementById('recommendationList');
        list.innerHTML = '';
        const recommendations = [];

        // 1. Profit Analysis and Strategy
        const totalTurnover = bankLimits.reduce((sum, bank) => sum + (bank.income + bank.outcome), 0);
        const totalIncome = bankLimits.reduce((sum, b) => b.isResting ? sum : sum + b.income, 0);
        const totalOutcome = bankLimits.reduce((sum, b) => b.isResting ? sum : sum + b.outcome, 0);
        const balance = totalIncome - totalOutcome;
        const estimatedProfit = (totalTurnover / BUY_RATE) * (SPREAD / 100) * BUY_RATE - PERSONAL_EXPENSE_TODAY;
        
        if (estimatedProfit > 2000) {
            recommendations.push(`<li class="recommend-profit">üí∏ **–ò–π–≥–∏–ª–∏–∫, –ë—Ä–æ!** –ü–∞–π–¥–∞: ${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º. –ñ–∞–∫—à—ã —Ç–µ–º–ø! –£—à—É–Ω—É –∫–∞—Ä–º–∞, –∏–π–≥–∏–ª–∏–∫! üëë</li>`);
        } else if (estimatedProfit < 0) {
            recommendations.push(`<li class="recommend-high">üö® **–ê–±–∞–π–ª–∞, –ë—Ä–æ!** –ü–∞–π–¥–∞ —Ç–µ—Ä—Å (${estimatedProfit.toLocaleString('ru-RU')} –°–æ–º). –ß—ã–≥—ã—à-–ö–∏—Ä–∏—à –±–∞–ª–∞–Ω—Å—ã–Ω —Ç–µ–∑–∏—Ä—ç—ç–∫ –∫–∞—Ä–∞–ø –∫–æ–π!</li>`);
        } else if (totalTurnover > 10000) {
            recommendations.push(`<li>‚è≥ **–ö“Ø—Ç”©–±“Ø–∑, –ë—Ä–æ!** –ü–∞–π–¥–∞ –∞–∑ (–ñ–µ –Ω”©–ª–≥”© –∂–∞–∫—ã–Ω). –°–ø—Ä–µ–¥–¥–∏/–ö—É—Ä—Å—Ç—É –∫–∞—Ä–∞–ø, –∏—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∂–∞—Å–∞–ø –∫”©—Ä! üéØ</li>`);
        }

        // 2. Balance Strategy (Bro-Tone)
        if (Math.abs(balance) > 75000) { 
             const type = balance > 0 ? '–ö”®–ë“Æ–†”®”®–ö –°–ê–¢–´–ü –ê–õ' : '–ö”®–ë“Æ–†”®”®–ö –°–ê–¢';
             recommendations.push(`<li class="recommend-high">‚ùóÔ∏è **–¢–ï“¢–î”®”® –ö–ï–†–ï–ö:** ${type}, –ë—Ä–æ! –ê–π—Ä—ã–º–∞—á—ã–ª—ã–∫ ${Math.abs(balance).toLocaleString('ru-RU')} –°–æ–º. –û–±–æ—Ä–æ—Ç—Ç—É —Ç–µ“£–¥–µ–ø –∫–æ–π—á—É —ç—ç.</li>`);
        } else if (Math.abs(balance) > 30000) {
             recommendations.push(`<li class="recommend-low">üü° **–ê–ó–´–† –û“¢–î–û!** –ñ–µ“£–∏–ª –¥–∏—Å–±–∞–ª–∞–Ω—Å (${Math.abs(balance).toLocaleString('ru-RU')} –°–æ–º). –ö–∏–π–∏–Ω–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è“£–¥—ã —Ç—É—É—Ä–∞ –±–∞–≥—ã—Ç—Ç–∞ –∫—ã–ª, –î–æ—Å.</li>`);
        }
        
        // 3. Bank Status Checks (Bro-Tone)
        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;
            const percentageUsed = (turnover / bank.baseLimit) * 100;

            if (bank.isAutoRest) { // V24.2: AutoRest –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏ –∂–æ–≥–æ—Ä—É
                recommendations.push(`<li class="recommend-high">üõë **–ê–í–¢–û-–≠–° –ê–õ–£–£! ${bank.name}** –ª–∏–º–∏—Ç–∏ —Ç–æ–ª—É–ø, –∫—É–ª–ø—É–ª–∞–Ω–¥—ã. –ë“Ø–≥“Ø–Ω–∫“Ø –∏—à –±“Ø—Ç—Ç“Ø, –ë—Ä–æ!</li>`);
            } else if (bank.isResting) {
                recommendations.push(`<li class="recommend-rest" style="border-left-color: rgba(224, 224, 224, 0.5);">üò¥ **${bank.name}:** –≠—Å –∞–ª—Å—ã–Ω, –ë—Ä–æ. –ê–∑—ã—Ä—ã–Ω—á–∞ –∞–Ω—ã –∫–æ–ª–¥–æ–Ω–±–æ–π —ç–ª–µ –∫–æ–π.</li>`);
            } else if (remainingDaily <= 0) {
                recommendations.push(`<li class="recommend-high">üõë **–õ–ò–ú–ò–¢ –¢–û–õ–£–® –ö–ï–†–ï–ö!** ${bank.name} '“Ø –±“Ø—Ç—Ç“Ø. –¢–µ–∑ –∞—Ä–∞–¥–∞ AutoRest'–∫–µ ”©—Ç”©—Ç.</li>`);
            } else if (percentageUsed >= 90) { 
                recommendations.push(`<li class="recommend-low">‚ö†Ô∏è **–ê–ó –ö–ê–õ–î–´!** ${bank.name} 90% –∫–æ–ª–¥–æ–Ω—É–ª–¥—É. –ê–∫—ã—Ä—ã–Ω–¥—ã–∫ –º–µ–Ω–µ–Ω –∞–ª–º–∞—à—Ç—ã—Ä, –ë—Ä–æ. (–ö–∞–ª–¥—ã–∫: ${remainingDaily.toLocaleString('ru-RU')} –°–æ–º).</li>`);
            }
        });
        
        // 4. Spread/Rate Check (Bro-Tone)
        if (SPREAD < 0.45) {
            recommendations.push(`<li class="recommend-low">üí∞ **–°–ø—Ä–µ–¥ –∞–∑, –ë—Ä–æ:** ${SPREAD.toFixed(2)}%. –ü–∞–π–¥–∞–Ω—ã –∫”©–±”©–π—Ç“Ø—à “Ø—á“Ø–Ω 0.5% –∂–æ–≥–æ—Ä—É–ª–∞—Ç—ã–ø –∫–æ–π—á—É —ç—ç.</li>`);
        }


        if (recommendations.length === 0) {
            list.innerHTML = `<li style="border-left-color: var(--success-color); color: var(--success-color);">–ö–µ—Ä–µ–º–µ—Ç! –ë–∞—Ä–¥—ã–≥—ã –æ–ø—Ç–∏–º–∞–ª–¥—É—É! –ú—ã–∫—Ç—ã—Å—ã“£, –î–æ—Å! –≠–º–∏ –∏—à—Ç–µ, –∏–π–≥–∏–ª–∏–∫! ‚ú®</li>`;
        } else {
            list.innerHTML = recommendations.join('');
        }
    }
    
    // --- UTILITY (Kept same, adjusted for new theme) ---

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        toast.textContent = message;
        
        let borderColor = 'var(--accent-neon)'; 
        
        if (type === 'danger') {
             borderColor = 'var(--danger-color)'; 
        } else if (type === 'warning') {
             borderColor = 'var(--accent-gold)'; 
        } else if (type === 'success') {
             borderColor = 'var(--success-color)';
        }

        toast.style.borderColor = borderColor;
        toast.style.boxShadow = `0 0 10px ${borderColor}`;
        toast.classList.add('toast-show');
        setTimeout(() => {
            toast.classList.remove('toast-show');
        }, 3000);
    }
    
    function renderHistory() {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        const historyBody = document.getElementById('historyBody');
        historyBody.innerHTML = '';
        
        let totalProfit = 0;

        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach((session) => {
            const date = new Date(session.date).toLocaleDateString('ru-RU');
            const row = historyBody.insertRow();
            row.onclick = () => showHistoryDetails(session);
            
            const cellDate = row.insertCell(0);
            const cellTurnover = row.insertCell(1);
            const cellProfit = row.insertCell(2);
            
            cellDate.textContent = date;
            cellTurnover.textContent = session.turnover.toLocaleString('ru-RU');
            cellProfit.textContent = session.profit.toLocaleString('ru-RU');

            totalProfit += session.profit;
        });
        
        document.getElementById('totalHistoryProfit').textContent = totalProfit.toLocaleString('ru-RU');
    }
    
    function showHistoryDetails(session) {
        let details = `–û—Ç—á–µ—Ç: ${new Date(session.date).toLocaleString('ru-RU')}\n\n`;
        details += `–û–±—â–∏–π –û–±–æ—Ä–æ—Ç: ${session.turnover.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–¢–∞–∑–∞ –ü–∞–π–¥–∞: ${session.profit.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: ${session.expenses.toLocaleString('ru-RU')} –°–æ–º\n`;
        details += `–ñ–∞“£—ã –°–ø—Ä–µ–¥: ${session.newSpread.toFixed(2)}%\n`;
        details += `______________________\n`;
        details += `–ë–∞–Ω–∫—Ç–∞—Ä –±–æ—é–Ω—á–∞ –û–±–æ—Ä–æ—Ç:\n`;
        
        session.banks.forEach(bank => {
            const status = bank.isAutoRest ? '(–ê–í–¢–û-–≠–° –ê–õ–£–£)' : (bank.isResting ? '(–≠–° –ê–õ–£–£–î–ê)' : '(–ò–®–¢–ï)');
            details += `\n${bank.name} ${status}:\n`;
            details += `  –ö–∏—Ä–∏—à: ${bank.income.toLocaleString('ru-RU')}\n`;
            details += `  –ß—ã–≥—ã—à: ${bank.outcome.toLocaleString('ru-RU')}\n`;
            details += `  –ö“Ø–Ω. –ö–∞–ª–¥—ã–∫: ${bank.remainingDaily.toLocaleString('ru-RU')}\n`;
        });
        
        alert(details);
    }
    
    function clearAllData() {
        if (confirm("–≠–°–ö–ï–†–¢“Æ“Æ: –ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã (–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä, –¢–∞—Ä—ã—Ö, –£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω) —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.clear();
            showToast("–ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø. –ö–∞–π—Ä–∞ –∂“Ø–∫—Ç”©–ª”©—Ç. üí•", 'danger');
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }
    }

    function resetCurrentDay() {
        if (confirm("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω–¥“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã–Ω (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä, —Ä–∞—Å—Ö–æ–¥–¥–æ—Ä) —Ç–∞–∑–∞–ª–æ–æ–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            bankLimits.forEach(bank => {
                bank.income = 0;
                bank.outcome = 0;
                bank.isAutoRest = false; // V24.2: Reset AutoRest
                bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false; // Reset manual resting
            });
            transactionLog = [];
            PERSONAL_EXPENSE_TODAY = 0;
            
            localStorage.removeItem(STORAGE_TRANSACTION_LOG);
            localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
            saveState();
            showToast("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. ‚Ü©Ô∏è", 'danger');
        }
    }

    function exportHistoryToCSV() {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        if (history.length === 0) {
            showToast("–≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω —Ç–∞—Ä—ã—Ö –∂–æ–∫.", 'warning');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "–î–∞—Ç–∞;–û–±–æ—Ä–æ—Ç (–°–æ–º);–ü–∞–π–¥–∞ (–°–æ–º);–≠—Å–∫–∏ –°–ø—Ä–µ–¥ (%);–ñ–∞“£—ã –°–ø—Ä–µ–¥ (%);–ö–∞–ª–¥—ã–∫ (–°–æ–º);–†–∞—Å—Ö–æ–¥ (–°–æ–º)\n";

        history.forEach(session => {
            const date = new Date(session.date).toLocaleString('ru-RU').replace(/,/g, '');
            const profit = session.profit.toFixed(2);
            const turnover = session.turnover.toFixed(2);
            const oldSpread = session.oldSpread.toFixed(2);
            const newSpread = session.newSpread.toFixed(2);
            const remaining = session.remainingAmount.toFixed(2);
            const expenses = session.expenses.toFixed(2);

            csvContent += `${date};${turnover};${profit};${oldSpread};${newSpread};${remaining};${expenses}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `p2p_history_export_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("–¢–∞—Ä—ã—Ö CSV —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ —ç–∫—Å–ø–æ—Ä—Ç—Ç–æ–ª–¥—É. üíæ");
    }

    function updateSettings() {
        const newBuyRate = parseFloat(document.getElementById('settingBuyRate').value);
        const newSpread = parseFloat(document.getElementById('settingSpread').value);

        if (!isNaN(newBuyRate) && newBuyRate > 0) BUY_RATE = newBuyRate;
        if (!isNaN(newSpread) && newSpread >= 0) SPREAD = newSpread;
        
        const bankLimitInputs = document.querySelectorAll('#mobileSettingsBody input[type="number"]');
        
        bankLimitInputs.forEach(input => {
            const name = input.getAttribute('data-bank-name');
            const newDaily = parseFloat(input.value);
            
            if (STARTING_LIMITS[name] && !isNaN(newDaily) && newDaily >= 0) {
                 STARTING_LIMITS[name].daily = newDaily;
            }
        });

        syncBankLimits();
        saveState();
        renderSettings();
        showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä —Å–∞–∫—Ç–∞–ª–¥—ã. ‚úÖ");
    }
    
    function addBank() {
        const name = document.getElementById('newBankName').value.trim();
        const dailyLimit = parseFloat(document.getElementById('newBankDailyLimit').value);
        
        if (!name || isNaN(dailyLimit) || dailyLimit <= 0) {
            showToast("–¢—É—É—Ä–∞ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑ (–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç).", 'danger');
            return;
        }

        if (bankLimits.find(b => b.name === name)) {
            showToast("–ú—ã–Ω–¥–∞–π –±–∞–Ω–∫ –º—É—Ä—É–Ω—Ç–∞–Ω –±–∞—Ä.", 'danger');
            return;
        }

        STARTING_LIMITS[name] = { daily: dailyLimit, isResting: false }; 
        syncBankLimits(); 
        saveState();
        
        document.getElementById('newBankName').value = '';
        document.getElementById('newBankDailyLimit').value = '';
        
        renderSettings();
        renderBankOptions();
        showToast(`${name} –∫–æ—à—É–ª–¥—É. ‚úÖ`);
    }

    function removeBank(name) {
        if (!confirm(`${name} –±–∞–Ω–∫—ã–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?`)) return;
        
        delete STARTING_LIMITS[name];
        syncBankLimits(); 
        saveState();
        renderSettings();
        renderBankOptions();
        showToast(`${name} ”©—á“Ø—Ä“Ø–ª–¥“Ø. üóëÔ∏è`);
    }

    function renderSettings() {
        const mobileBody = document.getElementById('mobileSettingsBody');
        mobileBody.innerHTML = '';
        
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;

        let mobileContent = '';

        bankLimits.forEach((bank) => {
            const bankNameClean = bank.name.replace(/\s/g, '');
            const isRestingStatus = STARTING_LIMITS[bank.name] && STARTING_LIMITS[bank.name].isResting ? 'üò¥ –≠—Å –∞–ª—É—É–¥–∞' : '‚úÖ –ê–¥–∞—Ç—Ç–∞–≥—ã';
            mobileContent += `
                 <div class="bank-settings-card card-block">
                     <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="color: var(--accent-gold);">${bank.name}</h4>
                        <button onclick="removeBank('${bank.name}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8em;">”®–ß“Æ–†“Æ“Æ</button>
                     </div>
                     <p style="font-size: 0.8em; color: rgba(224, 224, 224, 0.6); font-weight: 600;">–£—á—É—Ä–¥–∞–≥—ã –°—Ç–∞—Ç—É—Å: ${isRestingStatus}</p>
                     <div class="modal-field">
                         <label for="mobile-daily-${bankNameClean}" style="color: rgba(224, 224, 224, 0.6);">–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º):</label>
                         <input type="number" id="mobile-daily-${bankNameClean}" data-bank-name="${bank.name}" value="${bank.baseLimit}" min="0">
                     </div>
                 </div>
             `;
        });
        
        mobileBody.innerHTML = mobileContent;
    }
    
    function openCloseSessionModal() {
        document.getElementById('personalExpensesTotal').value = PERSONAL_EXPENSE_TODAY.toFixed(2).toLocaleString('ru-RU');
        document.getElementById('closeSessionModal').style.display = 'flex';
    }

    function closeSession(isFinalClosure) {
        if (!isFinalClosure) {
            openCloseSessionModal();
            return;
        }
        
        const remainingAmount = parseFloat(document.getElementById('remainingAmount').value) || 0;
        const actualProfit = parseFloat(document.getElementById('actualProfitInput').value);
        
        if (isNaN(actualProfit)) {
            alert("–°—É—Ä–∞–Ω—ã—á, –¢–∞–∑–∞ –ü–∞–π–¥–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }

        const totalTurnover = bankLimits.reduce((sum, bank) => {
             return bank.isResting ? sum : sum + (bank.income + bank.outcome);
        }, 0);
        
        let newSpread = SPREAD;
        if (totalTurnover > 0) {
            newSpread = (actualProfit / totalTurnover) * 100;
        }
        
        const oldSpread = SPREAD;

        SPREAD = parseFloat(newSpread.toFixed(2));
        
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        const today = new Date();
        
        const totalExpenses = PERSONAL_EXPENSE_TODAY;

        history.push({
            date: today.toISOString(),
            turnover: totalTurnover,
            profit: actualProfit,
            oldSpread: oldSpread,
            newSpread: SPREAD,
            remainingAmount: remainingAmount,
            expenses: totalExpenses,
            banks: bankLimits.map(b => ({
                name: b.name,
                income: b.income,
                outcome: b.outcome,
                turnover: b.income + b.outcome,
                remainingDaily: b.baseLimit - (b.income + b.outcome),
                isResting: b.isResting,
                isAutoRest: b.isAutoRest // V24.2: Save AutoRest status
            }))
        });
        localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));

        // Reset current day state for the new session
        bankLimits.forEach(bank => {
            bank.income = 0;
            bank.outcome = 0;
            bank.isAutoRest = false; // V24.2: Reset AutoRest
            bank.isResting = STARTING_LIMITS[bank.name] ? STARTING_LIMITS[bank.name].isResting : false; // Reset manual resting
        });
        transactionLog = [];
        PERSONAL_EXPENSE_TODAY = 0;

        localStorage.removeItem(STORAGE_TRANSACTION_LOG);
        localStorage.removeItem(STORAGE_PERSONAL_EXPENSE);
        localStorage.setItem(STORAGE_CURRENT_DATA, JSON.stringify(bankLimits));
        saveGlobalSettings(); 
        localStorage.setItem(STORAGE_LAST_DATE, today.toISOString()); 

        document.getElementById('closeSessionModal').style.display = 'none';
        document.getElementById('modalProfitDisplay').textContent = `${actualProfit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        document.getElementById('modalNewSpread').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('modalExpenseDisplay').textContent = `${totalExpenses.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
        document.getElementById('successModal').style.display = 'flex';
        
        loadState();
        renderHistory();
    }

</script>
</body>
</html>