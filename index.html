<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—à –∫–µ–ª–∏“£–∏–∑ –º–µ–Ω –∏–∑–¥–∏–Ω –∂–∞—Ä–¥–∞–º—á—ã“£—ã–∑–º—ã–Ω P2P</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- V19 COLORS (V15 style restoration) --- */
        :root {
            --primary-color: #0d6efd; 
            --success-color: #198754; 
            --danger-color: #dc3545; 
            --warning-color: #ffc107; 
            --secondary-color: #6c757d; 
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            --info-color: #0dcaf0; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: var(--bg-light); 
            display: flex;
            justify-content: center;
        }

        .container { 
            width: 100%;
            max-width: 1250px; /* Increased max width for the wider table */
            margin: auto; 
            background: var(--bg-white); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            margin-bottom: 30px;
        }

        /* --- UTILITY & CONTROLS --- */
        .header-controls, .utility-buttons, .transaction-form { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        .header-controls { justify-content: space-between; align-items: center; }
        .transaction-form, #expenseForm { 
             padding: 15px; 
             border: 1px solid #ddd; 
             border-radius: 8px; 
             background-color: var(--bg-light);
             align-items: center;
        }
        #expenseForm { 
             border-color: var(--danger-color); 
             margin-top: 15px;
             background-color: #fef7f7;
        }

        /* Input & Select Styling */
        input[type="number"], input[type="text"], select, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            flex-grow: 1;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        
        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-primary:hover, .btn-success:hover, .btn-danger:hover, .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        /* --- TABLE STYLES (Full 8-column style) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
            table-layout: fixed; /* Ensures consistent column width behavior */
            min-width: 900px; /* Minimum width for the table to prevent squishing */
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: right;
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
        }
        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 700;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td:first-child, th:first-child {
            text-align: left;
            width: 12%; /* Fixed width for bank name */
        }
        th:nth-child(2), th:nth-child(3), th:nth-child(6), th:nth-child(7), th:nth-child(8) { 
             width: 12%; 
        } 
        th:nth-child(4), th:nth-child(5) { 
             width: 14%; 
        }

        .total-row th {
            background-color: var(--primary-color);
            color: white;
            font-size: 1.1em;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .monthly-limit-header { background-color: #4f46e5 !important; color: white !important; }
        .status-danger { color: var(--danger-color); font-weight: 700; }
        .status-ok { color: var(--success-color); font-weight: 700; }
        .status-rest { 
             color: var(--warning-color); 
             font-weight: 700; 
             background-color: #fffbe4; 
        }
        
        /* --- PROFIT BOX & COMPARISON --- */
        .profit-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #e6f7ff; 
            border-left: 5px solid var(--info-color);
            box-shadow: var(--shadow);
        }
        .profit-box h2 {
            margin-top: 0;
            color: #0c5460;
            font-size: 1.4em;
        }
        .profit-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .comparison { 
            padding: 8px; 
            border-radius: 5px; 
            margin-top: 10px; 
            font-weight: 600; 
            animation: fadeIn 0.5s ease-out; /* Animation */
        }
        .comp-positive { background-color: #d1e7dd; color: var(--success-color); }
        .comp-negative { background-color: #f8d7da; color: var(--danger-color); }
        .comp-neutral { background-color: #fff3cd; color: var(--warning-color); }

        /* --- HISTORY SECTION --- */
        .history-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        .history-section h2 { margin-bottom: 15px; }
        .history-table th:nth-child(1) { width: 30%; text-align: left; }
        .history-table th:nth-child(2), .history-table th:nth-child(3) { width: 35%; }
        .history-table td { cursor: pointer; }
        .history-profit { color: var(--success-color); font-weight: 600; }

        /* --- AUTH SECTION --- */
        #authSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .auth-box {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 350px;
            text-align: center;
            animation: popIn 0.3s ease-out;
        }
        .auth-box input { margin-bottom: 15px; width: 100%; }
        .auth-box button { width: 100%; }
        
        /* --- RECOMMENDATIONS (V17/V18 style retained for clarity) --- */
        #recommendationSection {
            margin-top: 30px;
            padding: 15px;
            background-color: #f4f4ff;
            border-radius: 8px;
            border: 1px solid #c3c3e6;
            animation: slideInUp 0.4s ease-out; /* Animation */
        }
        #recommendationList {
            list-style-type: none;
            padding: 0;
            margin: 10px 0 0;
        }
        #recommendationList li {
            padding: 8px 0;
            border-bottom: 1px dotted #e0e0e0;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .recommend-low { color: var(--success-color); }
        .recommend-high { color: var(--danger-color); font-weight: 600; }
        .recommend-rest { color: var(--warning-color); font-style: italic; }
        
        /* --- MODAL (Retained V15/V16 Style) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: popIn 0.3s ease-out; 
        }
        .modal-field { margin-bottom: 15px; }
        .modal-field label { display: block; margin-bottom: 5px; font-weight: 600; }
        .modal-field input[type="number"], .modal-field input[type="text"] { width: 100%; }
        
        /* Success Modal Animation */
        .fireworks {
            font-size: 4em;
            display: block;
            margin-bottom: 10px;
            animation: bounce 0.6s infinite alternate;
        }

        /* --- TOAST NOTIFICATION (Retained) --- */
        .toast-message {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 5000;
            left: 50%;
            top: 30px;
            font-size: 17px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: visibility 0.3s, opacity 0.3s;
            opacity: 0;
        }
        .toast-show {
            visibility: visible;
            opacity: 1;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        /* --- KEYFRAMES (Animations Added) --- */
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce {
             from { transform: scale(1.0); }
             to { transform: scale(1.1); }
        }
        @-webkit-keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }
        @keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }
        
    </style>
</head>
<body onload="init()">

<div id="authSection" style="display: none;">
    <div class="auth-box">
        <h2 id="authTitle">–ù–ò–ö–¢–ò –ö–ò–†–ì–ò–ó“Æ“Æ</h2>
        <input type="text" id="authUsername" placeholder="–ö–æ–ª–¥–æ–Ω—É—É—á—É –ê—Ç—ã (–ù–∏–∫)" required>
        <button onclick="loginUser()" class="btn btn-primary" id="authButton">–ö–∏—Ä“Ø“Ø</button>
        <p style="margin-top: 15px; font-size: 0.9em; color: var(--secondary-color);">*–ë–∏—Ä–∏–Ω—á–∏ –∂–æ–ª—É –∫–∏—Ä—Å–µ“£–∏–∑, –Ω–∏–∫ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© –∫–∞—Ç—Ç–∞–ª–∞—Ç.</p>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="container">
        <h1>–°–∞–ª–∞–º –º–µ–Ω —Å–∏–∑–¥–∏–Ω –∂–∞—Ä–¥–∞–º—á—ã“£–∑ –±–æ–ª–æ–º </h1>
        
        <div class="header-controls">
            <div class="utility-buttons">
                 <button onclick="showMainTracker()" class="btn btn-primary" id="homeBtn">üè† –ù–ï–ì–ò–ó–ì–ò –≠–ö–†–ê–ù</button>
                 <button onclick="toggleSettings()" class="btn btn-primary" id="settingsBtn">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê</button>
                 <button onclick="toggleMonthlyLimits()" class="btn btn-primary" id="monthlyLimitsBtn">üìÖ –ê–ô–õ–´–ö –õ–ò–ú–ò–¢–¢–ï–†</button>
                 <button onclick="toggleSync()" class="btn btn-primary" id="syncBtn">üåê –°–ò–ù–•–†–û–ù–î–û–®–¢–£–†–£–£</button>
            </div>
            <div class="session-controls">
                <button onclick="undoLastTransaction()" class="btn btn-danger" id="undoBtn" disabled>‚Ü©Ô∏è –ê–ö–´–†–ö–´–ù–´ –û“¢–î–û–û</button>
                <button onclick="openCloseSessionModal()" class="btn btn-success">‚úîÔ∏è –°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£</button> 
                <button onclick="logout()" class="btn btn-secondary">üëã –ß–´–ì–£–£</button>
            </div>
        </div>
        
        <div id="monthlyLimitsView" style="display:none;">
            <h2>üìÖ –ë–∞–Ω–∫—Ç–∞—Ä–¥—ã–Ω –ê–π–ª—ã–∫ –õ–∏–º–∏—Ç—Ç–µ—Ä–∏ (–ö—ã—Å–∫–∞—á–∞)</h2>
            <p>–ê—Ä –±–∏—Ä –±–∞–Ω–∫—Ç—ã–Ω –∞–π–ª—ã–∫ –æ–±–æ—Ä–æ—Ç—Ç–æ—Ä—É–Ω –∂–∞–Ω–∞ –∫–∞–ª–¥—ã–∫—Ç–∞—Ä—ã–Ω –∫”©—Ä“Ø“Ø.</p>
            <table class="monthly-limit-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">–ë–∞–Ω–∫</th>
                        <th>–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th>
                        <th>–£—á—É—Ä–¥–∞–≥—ã –û–±–æ—Ä–æ—Ç</th>
                        <th>–ö–∞–ª–¥—ã–∫ (–°–æ–º)</th>
                    </tr>
                </thead>
                <tbody id="monthlyLimitBody"></tbody>
            </table>
        </div>
        
        <div id="syncSection" style="display:none;">
            <h2>üåê –°–∏–Ω—Ö—Ä–æ–Ω–¥–æ—à—Ç—É—Ä—É—É & –ë”©–ª“Ø—à“Ø“Ø</h2>
            <p>–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –±–∞—à–∫–∞ —Ç“Ø–∑–º”©–∫–∫”© ”©—Ç–∫”©—Ä“Ø“Ø –∂–µ —Ä–µ–∑–µ—Ä–≤–¥–∏–∫ –∫”©—á“Ø—Ä–º”©—Å“Ø–Ω —Å–∞–∫—Ç–æ–æ “Ø—á“Ø–Ω JSON –∫–æ–¥—É–Ω –∫–æ–ª–¥–æ–Ω—É“£—É–∑.</p>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button onclick="exportDataCode()" class="btn btn-primary">–ö–æ–¥–¥—É –≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ</button>
                <button onclick="importDataCode()" class="btn btn-success">–ö–æ–¥–¥–æ–Ω –ò–º–ø–æ—Ä—Ç—Ç–æ–æ</button>
            </div>
            <textarea id="syncInput" placeholder="–≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–ª–≥–æ–Ω –∫–æ–¥ —É—à—É–ª –∂–µ—Ä–¥–µ –ø–∞–π–¥–∞ –±–æ–ª–æ—Ç –∂–µ –∏–º–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω –∫–æ–¥–¥—É —É—à—É–ª –∂–µ—Ä–≥–µ —á–∞–ø—Ç–∞“£—ã–∑." rows="10"></textarea>
        </div>

        <div id="settingsSection" style="display:none;">
            <h2>üõ†Ô∏è –õ–∏–º–∏—Ç—Ç–µ—Ä–¥–∏ –∂–∞–Ω–∞ –ö—É—Ä—Å—Ç–∞—Ä–¥—ã –ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–æ–æ</h2>
            <div class="settings-form" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background-color: var(--bg-light);">
                <label>BUY Rate (USD): <input type="number" id="settingBuyRate" step="0.01" style="width: 100px;"></label>
                <label>Spread (%): <input type="number" id="settingSpread" step="0.01" style="width: 100px;"></label>
                <button onclick="updateSettings()" class="btn btn-primary" style="flex-grow: 0;">–ë–∞–∞—Ä—ã–Ω –°–∞–∫—Ç–æ–æ</button>
            </div>
            
            <table class="settings-table">
                <thead>
                    <tr>
                        <th>–ë–∞–Ω–∫</th>
                        <th>–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th>
                        <th>–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th> 
                        <th>–ê—Ä–∞–∫–µ—Ç—Ç–µ—Ä</th>
                    </tr>
                </thead>
                <tbody id="settingsBody"></tbody>
            </table>

            <div class="add-bank-form" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <input type="text" id="newBankName" placeholder="–ñ–∞“£—ã –ë–∞–Ω–∫ –ê—Ç—ã">
                <input type="number" id="newBankDailyLimit" placeholder="–ö“Ø–Ω–¥“Ø–∫ –õ–∏–º–∏—Ç (–°–æ–º)">
                <input type="number" id="newBankMonthlyLimit" placeholder="–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)" value="300000"> 
                <button onclick="addBank()" class="btn btn-success" style="flex-grow: 1;">+ –ë–ê–ù–ö –ö–û–®–£–£</button>
            </div>
            
            <h2 style="margin-top: 30px; border-bottom: 1px solid #dee2e6;">‚ö†Ô∏è –ö–æ–æ–ø—Ç—É—É –ó–æ–Ω–∞</h2>
            <div class="utility-buttons">
                <button onclick="exportHistoryToCSV()" class="btn btn-secondary">üíæ CSV –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button onclick="resetCurrentDay()" class="btn btn-danger">‚Ü©Ô∏è –£—á—É—Ä–¥–∞–≥—ã –ö“Ø–Ω–¥“Ø –¢–∞–∑–∞–ª–æ–æ</button>
                <button onclick="clearAllData()" class="btn btn-danger">üî• –ë–ê–†–î–´–ö –ú–ê–ê–õ–´–ú–ê–¢–¢–´ ”®–ß“Æ–†“Æ“Æ</button>
            </div>
        </div>

        <div id="trackerView">
            <div class="notes">
                <h3>–ö“Ø–Ω“Ø–º–¥“Ø–∫ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</h3>
            </div>

            <div class="transaction-form">
                <select id="actionType" >
                    <option value="income">–°–∞—Ç—É—É (–ö–∏—Ä–∏—à)</option>
                    <option value="outcome">–°–∞—Ç—ã–ø –∞–ª—É—É (–ß—ã–≥—ã—à)</option>
                </select>
                <input type="number" id="transactionAmount" placeholder="–°—É–º–º–∞ (–°–æ–º)">
                <select id="transactionBank"></select>
                <button onclick="logTransaction()" class="btn btn-primary">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ö–æ—à—É—É</button>
            </div>

            <div id="expenseForm">
                <input type="number" id="personalExpenseAmount" placeholder="–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–æ–º)">
                <button onclick="logPersonalExpense()" class="btn btn-danger">–†–∞—Å—Ö–æ–¥–¥—É –ö–æ—à—É—É</button>
            </div>

            <div id="recommendationSection">
                <h2>üí° –ê–∫—ã–ª–¥—É—É –°—É–Ω—É—à—Ç–∞—Ä (–ê–Ω–∞–ª–∏–∑)</h2>
                <ul id="recommendationList">
                    <li>–°–∏—Å—Ç–µ–º–∞ —É—á—É—Ä–¥–∞ –∞–Ω–∞–ª–∏–∑ –∂“Ø—Ä–≥“Ø–∑“Ø“Ø–¥”©...</li>
                </ul>
            </div>
            
            <div style="overflow-x: auto; max-height: 500px;">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">–ë–∞–Ω–∫</th>
                            <th onclick="sortTable(1)">–ö“Ø–Ω. –õ–∏–º–∏—Ç (–°–æ–º)</th>
                            <th onclick="sortTable(6)">–ê–π–ª—ã–∫ –õ–∏–º–∏—Ç (–°–æ–º)</th> 
                            <th onclick="sortTable(2)">–ö–∏—Ä–∏—à (–ü—Ä–∏—Ö–æ–¥)</th>
                            <th onclick="sortTable(3)">–ß—ã–≥—ã—à (–†–∞—Å—Ö–æ–¥)</th>
                            <th onclick="sortTable(4)">–ö“Ø–Ω. –û–±–æ—Ä–æ—Ç</th>
                            <th onclick="sortTable(7)">–ê–π–ª—ã–∫ –û—Å—Ç–∞—Ç–æ–∫</th> 
                            <th onclick="sortTable(5)">–ö“Ø–Ω. –û—Å—Ç–∞—Ç–æ–∫ / –°–¢–ê–¢–£–°</th>
                        </tr>
                    </thead>
                    <tbody id="trackerBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <th colspan="3">–ö“Æ–ù–î“Æ–ù –ñ–ê–õ–ü–´ –ñ–´–ô–´–ù–¢–´–ì–´</th>
                            <th id="totalIncome">0</th>
                            <th id="totalOutcome">0</th>
                            <th id="totalTurnover">0</th>
                            <th>-</th>
                            <th id="totalRemaining">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="profit-box">
                <h2>üí∞ –ö“Ø–Ω–¥“Ø–∫ –ü–∞–π–¥–∞ (–°–ø—Ä–µ–¥: <span id="spreadDisplay">0.5%</span>)</h2>
                <div class="profit-value" id="estimatedProfit">0.00 –°–æ–º</div>
                <div class="comparison" id="comparisonDisplay"></div>
                <p style="font-size: 0.8em; color: #555;">(–≠—Å–µ–ø—Ç”©”©: –û–±—â–∏–π –û–±–æ—Ä–æ—Ç / <span id="buyRateDisplay">88.0</span> * <span id="spreadValueDisplay">0.005</span>)</p>
            </div>
            
            <div id="personalExpenseSummary" style="margin-top: 15px; font-weight: bold; color: var(--danger-color);">
                –ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): 0.00 –°–æ–º
            </div>

            <div class="history-section">
                <h2 id="historyHeader">üìä –¢–∞—Ä—ã—Ö (–ò—Å—Ç–æ—Ä–∏—è)</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                     <p style="font-size: 0.9em; color: var(--secondary-color);">*–°–∞–ø—Ç—ã –±–∞—Å—ã–ø, —Ç–æ–ª—É–∫ –æ—Ç—á–µ—Ç—Ç—É –∫”©—Ä“Ø“£“Ø–∑</p>
                     <button onclick="clearHistory()" class="btn btn-danger">üí£ –¢–∞—Ä—ã—Ö—Ç—ã ”®–ß“Æ–†“Æ“Æ</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–±—â–∏–π –û–±–æ—Ä–æ—Ç</th>
                                <th>–ü–∞–π–¥–∞ (–¢–∞–∑–∞)</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                         <tfoot>
                            <tr class="total-row">
                                <th colspan="2">–ñ–ê–õ–ü–´ –¢–ê–†–´–•–´–ô –ü–ê–ô–î–ê</th>
                                <th id="totalHistoryProfit">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="closeSessionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2>–°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£</h2>
        <p>–ö–∞–ª–¥—ã–∫ –∫–∞—Ä–∞–∂–∞—Ç—Ç–∞—Ä–¥—ã –∂–∞–Ω–∞ —Ç–∞–∑–∞ –ø–∞–π–¥–∞–Ω—ã —Ç–∞–∫—Ç–æ–æ “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.</p>

        <div class="modal-field">
            <label for="remainingAmount">üí∞ –°–∞—Ç—ã–ª–±–∞–π –ö–∞–ª–≥–∞–Ω –ö–∞–ª–¥—ã–∫ –°—É–º–º–∞ (–°–æ–º)</label>
            <input type="number" id="remainingAmount" value="0" placeholder="–ú–∏—Å–∞–ª—ã: 90000">
        </div>

        <div class="modal-field">
            <label for="personalExpensesTotal">üõí –ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞)</label>
            <input type="text" id="personalExpensesTotal" value="0.00" disabled>
        </div>

        <div class="modal-field">
            <label for="actualProfitInput">üí∏ –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑–¥—ã –ö–∏—Ä–≥–∏–∑–∏“£–∏–∑ (–°–æ–º)</label>
            <input type="number" id="actualProfitInput" placeholder="–ú–∏—Å–∞–ª—ã: 12500">
            <p style="font-size: 0.8em; color: var(--secondary-color); margin-top: 5px;">*–ë—É–ª –º–∞–∞–Ω–∏–≥–µ –∫–∞—Ä–∞–ø –°–ø—Ä–µ–¥ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© —ç—Å–µ–ø—Ç–µ–ª–µ—Ç.</p>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="closeSession(true)" class="btn btn-success" style="flex-grow: 1;">‚úîÔ∏è –°–ú–ï–ù–ê–ù–´ –ë“Æ–¢“Æ–†“Æ“Æ</button>
            <button onclick="document.getElementById('closeSessionModal').style.display='none';" class="btn btn-secondary">‚ùå –ñ–ê–ë–£–£ / –ê–†–¢–ö–ê</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="text-align: center;">
        <span class="fireworks">üéâ</span>
        <h2 style="color: var(--success-color);">–ò–ô–ì–ò–õ–ò–ö–¢“Æ“Æ! –°–ú–ï–ù–ê –ñ–ê–ë–´–õ–î–´!</h2>
        <p style="font-size: 1.5em;">–°–∏–∑–¥–∏–Ω –¢–∞–∑–∞ –ü–∞–π–¥–∞“£—ã–∑:</p>
        <div class="profit-value" style="color: var(--danger-color); font-size: 3em;" id="modalProfitDisplay">0.00 –°–æ–º</div>
        <div style="margin-top: 10px; font-weight: 600;">–ñ–∞“£—ã –≠—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –°–ø—Ä–µ–¥: <span id="modalNewSpread">0.0%</span></div>
        <div style="margin-top: 5px; font-weight: 600;">–ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: <span id="modalExpenseDisplay">0.00 –°–æ–º</span></div>
        <button onclick="document.getElementById('successModal').style.display='none';" class="btn btn-primary" style="margin-top: 20px;">–£–ª–∞–Ω—Ç—É—É</button>
    </div>
</div>

<div id="toastNotification" class="toast-message">–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø! ‚úÖ</div>


<script>
    // --- STORAGE KEYS (V19 Update: Changed only version number) ---
    const STORAGE_CURRENT_DATA = 'p2p_tracker_v19_data';
    const STORAGE_HISTORY = 'p2p_history_v19';
    const STORAGE_LAST_DATE = 'p2p_last_session_date_v19';
    const STORAGE_SETTINGS = 'p2p_settings_v19';
    const STORAGE_TRANSACTION_LOG = 'p2p_transaction_log_v19';
    const STORAGE_MONTHLY_TURNOVER = 'p2p_monthly_turnover_v19'; 
    const STORAGE_PERSONAL_EXPENSE = 'p2p_personal_expense_v19';
    const STORAGE_AUTH_CREDENTIALS = 'p2p_auth_username_v19'; 
    const STORAGE_AUTH_STATUS = 'p2p_auth_status_v19'; 

    let BUY_RATE = 88.0;
    let SPREAD = 0.5; 
    let PENALTY_PERCENTAGE = 0.20; 
    let PERSONAL_EXPENSE_TODAY = 0; 

    let CURRENT_USER_NIC = null; 

    const RISK_TIER_2_DAYS = 50000; 
    const RISK_TIER_3_DAYS = 100000; 
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    let STARTING_LIMITS = {
        "Optima24": { daily: 35000, monthly: 300000 }, 
        "DemirBank": { daily: 25000, monthly: 250000 }, 
        "Mbank": { daily: 20000, monthly: 200000 }
    };

    let bankLimits = [];
    let transactionLog = [];
    let monthlyTurnover = {}; 
    let currentView = 'tracker'; // 'tracker', 'settings', 'sync', 'monthlyLimits'

    // --- AUTHENTICATION LOGIC (Retained) ---
    function displayUserName() {
        // Not used in V19, but kept for future proofing.
    }

    function checkAuthStatus() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        const authStatus = localStorage.getItem(STORAGE_AUTH_STATUS);
        
        if (authStatus === 'logged_in' && storedNic) {
            CURRENT_USER_NIC = storedNic;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadState(); 
            initTrackerContent();
        } else {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    }

    function loginUser() {
        const username = document.getElementById('authUsername').value.trim();

        if (username.length < 3) {
            alert("–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã (–ù–∏–∫) 3 —Å–∏–º–≤–æ–ª—É–Ω–∞–Ω –∫–µ–º –±–æ–ª–±–æ—Å—É–Ω.");
            return;
        }

        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);

        if (!storedNic || storedNic === username) {
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        } else {
             if (!confirm(`–≠–°–ö–ï–†–¢“Æ“Æ: –ú—É—Ä—É–Ω–∫—É –∫–æ–ª–¥–æ–Ω—É—É—á—É "${storedNic}" –±–æ–ª–≥–æ–Ω. "${username}" –º–µ–Ω–µ–Ω —É–ª–∞–Ω—Ç–∞—Å—ã–∑–±—ã? –ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–∏—à–∏ –º“Ø–º–∫“Ø–Ω.`)) {
                 return;
             }
             localStorage.clear();
             localStorage.setItem(STORAGE_AUTH_CREDENTIALS, username);
        }
        
        CURRENT_USER_NIC = username;
        localStorage.setItem(STORAGE_AUTH_STATUS, 'logged_in');
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        loadState(); 
        initTrackerContent();
        showToast(`–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∫–∏—Ä–¥–∏“£–∏–∑: ${username}!`);
    }

    function logout() {
        if (confirm("–ß—ã–≥—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            localStorage.removeItem(STORAGE_AUTH_STATUS); 
            
            document.getElementById('authUsername').value = CURRENT_USER_NIC || '';
            CURRENT_USER_NIC = null;
            
            checkAuthStatus(); 
        }
    }

    // --- VIEW TOGGLE LOGIC (V15/V16 style) ---

    function setActiveView(viewName) {
        document.getElementById('trackerView').style.display = 'none';
        document.getElementById('settingsSection').style.display = 'none';
        document.getElementById('syncSection').style.display = 'none';
        document.getElementById('monthlyLimitsView').style.display = 'none';
        
        if (viewName === 'tracker') {
            document.getElementById('trackerView').style.display = 'block';
        } else if (viewName === 'settings') {
            renderSettings();
            document.getElementById('settingsSection').style.display = 'block';
        } else if (viewName === 'sync') {
            document.getElementById('syncSection').style.display = 'block';
        } else if (viewName === 'monthlyLimits') {
            renderMonthlyLimitsTable();
            document.getElementById('monthlyLimitsView').style.display = 'block';
        }
        currentView = viewName;
    }

    function showMainTracker() {
        setActiveView('tracker');
    }

    function toggleSettings() {
        setActiveView(currentView === 'settings' ? 'tracker' : 'settings');
    }

    function toggleSync() {
        setActiveView(currentView === 'sync' ? 'tracker' : 'sync');
    }
    
    function toggleMonthlyLimits() {
        setActiveView(currentView === 'monthlyLimits' ? 'tracker' : 'monthlyLimits');
    }

    function renderMonthlyLimitsTable() {
        const body = document.getElementById('monthlyLimitBody');
        body.innerHTML = '';
        
        bankLimits.forEach(bank => {
             const currentMonthlyTurnover = monthlyTurnover[bank.name] || 0;
             const remainingMonthly = bank.monthlyLimit - currentMonthlyTurnover;
             const statusClass = remainingMonthly <= bank.monthlyLimit * 0.1 ? 'status-danger' : 'status-ok';

             const row = document.createElement('tr');
             row.innerHTML = `
                <td>${bank.name}</td>
                <td>${bank.monthlyLimit.toLocaleString('ru-RU')}</td>
                <td>${currentMonthlyTurnover.toLocaleString('ru-RU')}</td>
                <td class="${statusClass}">${remainingMonthly.toLocaleString('ru-RU')}</td>
             `;
             body.appendChild(row);
        });
    }

    // --- INIT --- (Retained)

    function initTrackerContent() {
        displayUserName(); 
        renderBankOptions(); 
        renderTable();
        renderHistory();
        generateRecommendations(); 
        setActiveView('tracker');
    }
    
    function init() {
        const storedNic = localStorage.getItem(STORAGE_AUTH_CREDENTIALS);
        if (storedNic) {
             document.getElementById('authUsername').value = storedNic;
        }

        checkAuthStatus(); 
    }

    // --- CORE JAVASCRIPT FUNCTIONS (Retained logic from V18) ---

    function saveGlobalSettings() {
        const settings = {
            buyRate: BUY_RATE,
            spread: SPREAD,
            startingLimits: STARTING_LIMITS
        };
        localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
    }

    function loadGlobalSettings() {
        const storedSettings = localStorage.getItem(STORAGE_SETTINGS);
        if (storedSettings) {
            const settings = JSON.parse(storedSettings);
            BUY_RATE = settings.buyRate || 88.0;
            SPREAD = settings.spread || 0.5;
            STARTING_LIMITS = settings.startingLimits || STARTING_LIMITS;
        }
        
        const storedMonthlyTurnover = localStorage.getItem(STORAGE_MONTHLY_TURNOVER);
        if (storedMonthlyTurnover) {
             monthlyTurnover = JSON.parse(storedMonthlyTurnover);
             
             const today = new Date();
             if (localStorage.getItem(STORAGE_LAST_DATE)) {
                 const lastDate = new Date(localStorage.getItem(STORAGE_LAST_DATE));
                 if (today.getDate() === 1 && lastDate.getMonth() !== today.getMonth()) {
                      monthlyTurnover = {};
                      localStorage.setItem(STORAGE_MONTHLY_TURNOVER, JSON.stringify(monthlyTurnover));
                 } 
             }
        }
    }

    function syncBankLimits() {
         const updatedBankLimits = [];
         for (const name in STARTING_LIMITS) {
             const limits = STARTING_LIMITS[name];
             let existingBank = bankLimits.find(b => b.name === name);
            
             if (existingBank) {
                 existingBank.baseLimit = limits.daily; 
                 existingBank.monthlyLimit = limits.monthly; 
                 updatedBankLimits.push(existingBank);
             } else {
                 updatedBankLimits.push({ 
                     name: name, 
                     baseLimit: limits.daily, 
                     monthlyLimit: limits.monthly,
                     income: 0, 
                     outcome: 0, 
                     restingUntil: null 
                 });
             }
         }
         bankLimits = updatedBankLimits.filter(bank => STARTING_LIMITS[bank.name] !== undefined);
         saveGlobalSettings(); 
    }
    
    function loadState() {
        loadGlobalSettings(); 
        
        const storedData = localStorage.getItem(STORAGE_CURRENT_DATA);
        if (storedData) {
            bankLimits = JSON.parse(storedData);
        }

        const storedLog = localStorage.getItem(STORAGE_TRANSACTION_LOG);
        if (storedLog) {
            transactionLog = JSON.parse(storedLog);
        }
        
        const storedExpense = localStorage.getItem(STORAGE_PERSONAL_EXPENSE);
        if (storedExpense) {
            PERSONAL_EXPENSE_TODAY = parseFloat(storedExpense) || 0;
        }

        syncBankLimits(); 
        document.getElementById('undoBtn').disabled = transactionLog.length === 0 && PERSONAL_EXPENSE_TODAY === 0;
    }

    function saveState() {
        STARTING_LIMITS = {};
        bankLimits.forEach(bank => {
            STARTING_LIMITS[bank.name] = {
                daily: bank.baseLimit,
                monthly: bank.monthlyLimit || 300000 
            };
        });

        saveGlobalSettings();
        localStorage.setItem(STORAGE_CURRENT_DATA, JSON.stringify(bankLimits));
        localStorage.setItem(STORAGE_LAST_DATE, new Date().toISOString());
        localStorage.setItem(STORAGE_TRANSACTION_LOG, JSON.stringify(transactionLog));
        localStorage.setItem(STORAGE_MONTHLY_TURNOVER, JSON.stringify(monthlyTurnover));
        localStorage.setItem(STORAGE_PERSONAL_EXPENSE, PERSONAL_EXPENSE_TODAY.toFixed(2));

        document.getElementById('undoBtn').disabled = transactionLog.length === 0 && PERSONAL_EXPENSE_TODAY === 0;
    }

    function formatDate(dateString) { 
        const date = new Date(dateString); 
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }); 
    }

    function isSameDay(date1, date2) { 
        return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate(); 
    }

    function getTotals() { 
        let income = bankLimits.reduce((sum, bank) => sum + bank.income, 0); 
        let outcome = bankLimits.reduce((sum, bank) => sum + bank.outcome, 0); 
        let turnover = income + outcome; 
        
        let profit = (turnover / BUY_RATE) * (SPREAD / 100); 
        
        return { income, outcome, turnover, profit, expense: PERSONAL_EXPENSE_TODAY }; 
    }

    function clearCurrentDayData() { 
        bankLimits.forEach(bank => { 
            bank.income = 0; 
            bank.outcome = 0; 
            if (bank.restingUntil && new Date(bank.restingUntil) < new Date()) {
                bank.restingUntil = null; 
            }
        }); 
        localStorage.setItem(STORAGE_LAST_DATE, new Date().toISOString()); 
        PERSONAL_EXPENSE_TODAY = 0;
    }

    function showToast(message) {
        const toast = document.getElementById('toastNotification');
        toast.textContent = message;
        toast.classList.add('toast-show');
        setTimeout(() => {
            toast.classList.remove('toast-show');
        }, 3000);
    }
    
    // –ù–ê–°–¢–†–û–ô–ö–ê
    function renderSettings() {
        document.getElementById('settingBuyRate').value = BUY_RATE;
        document.getElementById('settingSpread').value = SPREAD;

        const settingsBody = document.getElementById('settingsBody');
        settingsBody.innerHTML = '';

        bankLimits.forEach(bank => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${bank.name}" data-bank-name="${bank.name}" class="bank-name-input"></td>
                <td><input type="number" value="${bank.baseLimit}" data-bank-daily-limit="${bank.name}" class="bank-limit-input"></td>
                <td><input type="number" value="${bank.monthlyLimit || 300000}" data-bank-monthly-limit="${bank.name}" class="bank-monthly-limit-input"></td>
                <td><button onclick="removeBank('${bank.name}')" class="btn btn-danger" style="padding: 5px 10px;">”®—á“Ø—Ä“Ø“Ø</button></td>
            `;
            settingsBody.appendChild(row);
        });
    }

    function updateSettings() {
        const newBuyRate = parseFloat(document.getElementById('settingBuyRate').value);
        const newSpread = parseFloat(document.getElementById('settingSpread').value);

        if (isNaN(newBuyRate) || isNaN(newSpread) || newBuyRate <= 0) {
            alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä–¥–∞–≥—ã –º–∞–∞–Ω–∏–ª–µ—Ä —Ç—É—É—Ä–∞ —ç–º–µ—Å!");
            return;
        }

        BUY_RATE = newBuyRate;
        SPREAD = newSpread;

        const updatedLimits = {};
        const nameInputs = document.querySelectorAll('.bank-name-input');
        
        nameInputs.forEach((nameInput) => {
            const name = nameInput.value.trim();
            const dailyLimit = parseInt(document.querySelector(`input[data-bank-daily-limit="${nameInput.dataset.bankName}"]`).value);
            const monthlyLimit = parseInt(document.querySelector(`input[data-bank-monthly-limit="${nameInput.dataset.bankName}"]`).value);

            if (name && !isNaN(dailyLimit) && dailyLimit > 0 && !isNaN(monthlyLimit) && monthlyLimit > 0) {
                updatedLimits[name] = { daily: dailyLimit, monthly: monthlyLimit };
            }
        });
        
        STARTING_LIMITS = updatedLimits;
        syncBankLimits(); 

        saveState(); 
        renderTable();
        renderBankOptions();
        renderSettings(); 
        generateRecommendations(); 
        alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∞–ª–∞—Ä –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø —Å–∞–∫—Ç–∞–ª–¥—ã!");
    }

    function addBank() {
        const name = document.getElementById('newBankName').value.trim();
        const dailyLimit = parseInt(document.getElementById('newBankDailyLimit').value);
        const monthlyLimit = parseInt(document.getElementById('newBankMonthlyLimit').value) || 300000;

        if (!name || isNaN(dailyLimit) || dailyLimit <= 0) {
            alert("–ë–∞–Ω–∫—Ç—ã–Ω –∞—Ç—ã–Ω –∂–∞–Ω–∞ —Ç—É—É—Ä–∞ –∫“Ø–Ω–¥“Ø–∫ –ª–∏–º–∏—Ç–∏–Ω –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }

        if (STARTING_LIMITS[name] !== undefined) {
            alert("–ú—ã–Ω–¥–∞–π –∞—Ç –º–µ–Ω–µ–Ω –±–∞–Ω–∫ –º—É—Ä—É–Ω—Ç–∞–Ω —ç–ª–µ –±–∞—Ä.");
            return;
        }

        STARTING_LIMITS[name] = { daily: dailyLimit, monthly: monthlyLimit };
        syncBankLimits(); 

        document.getElementById('newBankName').value = '';
        document.getElementById('newBankDailyLimit').value = '';
        document.getElementById('newBankMonthlyLimit').value = '300000';

        saveState();
        renderTable();
        renderBankOptions();
        renderSettings();
        generateRecommendations(); 
        alert(`–ë–∞–Ω–∫ '${name}' –∫–æ—à—É–ª–¥—É.`);
    }

    function removeBank(name) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–∞–Ω–∫ ${name}? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–±–æ—Ä–æ—Ç—É —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) {
            return;
        }
        
        delete STARTING_LIMITS[name];
        syncBankLimits(); 

        saveState();
        renderTable();
        renderBankOptions();
        renderSettings();
        generateRecommendations(); 
        alert(`–ë–∞–Ω–∫ ${name} ”©—á“Ø—Ä“Ø–ª–¥“Ø.`);
    }

    function resetCurrentDay() {
         if (!confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ò —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è? (–õ–∏–º–∏—Ç—ã –∏ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –±—É–¥—É—Ç –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã).")) {
            return;
        }
        
        clearCurrentDayData();
        transactionLog = []; 
        saveState();
        renderTable();
        generateRecommendations(); 
        alert("–£—á—É—Ä–¥–∞–≥—ã –∫“Ø–Ω–¥“Ø–Ω –±–∞—Ä–¥—ã–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä—ã –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø —Ç–∞–∑–∞–ª–∞–Ω–¥—ã.");
    }

    function clearAllData() {
        if (!confirm("‚ö†Ô∏è –û–ü–ê–°–ù–û! –°–∏–∑ –±–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã (–õ–∏–º–∏—Ç, –ù–∞—Å—Ç—Ä–æ–π–∫–∞, –¢–∞—Ä—ã—Ö, –õ–æ–≥) —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω ”©—á“Ø—Ä“Ø–ø, —Å–∏—Å—Ç–µ–º–∞–Ω—ã —Ç–∞–∑–∞–ª–∞–≥—ã“£—ã–∑ –∫–µ–ª–µ–±–∏? –ë—É–ª –∫–∞–π—Ç–∞—Ä—ã–ª–±–∞–π—Ç.")) {
            return;
        }
        localStorage.clear();
        
        alert("–ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø. –°–∏—Å—Ç–µ–º–∞ –∫–∞–π—Ä–∞ –∂“Ø–∫—Ç”©–ª”©—Ç.");
        window.location.reload(); 
    }
    
    // –°–ò–ù–•–†–û–ù–î–û–®–¢–£–†–£–£
    function exportDataCode() {
        const exportData = {
            settings: { buyRate: BUY_RATE, spread: SPREAD, startingLimits: STARTING_LIMITS },
            bankLimits: bankLimits, 
            monthlyTurnover: monthlyTurnover,
            history: JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]')
        };
        const jsonString = JSON.stringify(exportData);
        document.getElementById('syncInput').value = jsonString;
        showToast("–≠–∫—Å–ø–æ—Ä—Ç—Ç—É–∫ –∫–æ–¥ –¥–∞—è—Ä–¥–∞–ª–¥—ã!");
    }

    function importDataCode() {
        const jsonString = document.getElementById('syncInput').value;
        if (!jsonString) {
            alert("–ò–º–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω –∫–æ–¥–¥—É –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }

        if (!confirm("‚ö†Ô∏è –≠–°–ö–ï–†–¢“Æ“Æ! –ë—É–ª —Å–∏–∑–¥–∏–Ω —É—á—É—Ä–¥–∞–≥—ã –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã“£—ã–∑–¥—ã —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω –∞–ª–º–∞—à—Ç—ã—Ä–∞—Ç. –£–ª–∞–Ω—Ç–∞—Å—ã–∑–±—ã?")) {
            return;
        }

        try {
            const importData = JSON.parse(jsonString);

            if (!importData.settings || !importData.bankLimits) {
                 throw new Error("–¢—É—É—Ä–∞ —ç–º–µ—Å —Ñ–æ—Ä–º–∞—Ç.");
            }

            BUY_RATE = importData.settings.buyRate;
            SPREAD = importData.settings.spread;
            STARTING_LIMITS = importData.settings.startingLimits;

            bankLimits = importData.bankLimits;
            monthlyTurnover = importData.monthlyTurnover || {};

            localStorage.setItem(STORAGE_HISTORY, JSON.stringify(importData.history || []));

            saveState();
            window.location.reload(); 
            
        } catch (e) {
            alert("–ò–º–ø–æ—Ä—Ç—Ç–æ–æ –∫–∞—Ç–∞—Å—ã: –ö–∏—Ä–≥–∏–∑–∏–ª–≥–µ–Ω –∫–æ–¥ —Ç—É—É—Ä–∞ —ç–º–µ—Å JSON —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞.");
        }
    }
    
    // –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø
    function logTransaction() {
        const actionType = document.getElementById('actionType').value;
        const amount = parseFloat(document.getElementById('transactionAmount').value);
        const bankName = document.getElementById('transactionBank').value;

        if (!amount || amount <= 0 || !bankName) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫.");
            return;
        }

        const bankIndex = bankLimits.findIndex(b => b.name === bankName);
        if (bankIndex === -1) return;

        const bank = bankLimits[bankIndex];
        const now = new Date();
        
        let isResting = false;
        if (bank.restingUntil) {
            const restDate = new Date(bank.restingUntil);
            if (restDate > now) {
                isResting = true;
            } else {
                bank.restingUntil = null; 
            }
        }
        
        const currentMonthlyTurnover = monthlyTurnover[bankName] || 0;
        const dailyTurnover = bank.income + bank.outcome;

        if (isResting) {
            alert(`‚õîÔ∏è ${bankName} –±–∞–Ω–∫—ã –∞–∑—ã—Ä "–≠–° –ê–õ–£–£–î–ê". –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ª–æ–≥–∏—Ä–ª”©”© –º“Ø–º–∫“Ø–Ω —ç–º–µ—Å.`);
            return;
        }
        if (currentMonthlyTurnover + amount > bank.monthlyLimit) {
             alert(`‚õîÔ∏è ${bankName} –±–∞–Ω–∫—ã–Ω—ã–Ω –∞–π–ª—ã–∫ –ª–∏–º–∏—Ç–∏ ${bank.monthlyLimit.toLocaleString('ru-RU')} —Å–æ–º–¥–æ–Ω –∞—à—ã–ø –∫–µ—Ç—Ç–∏. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ª–æ–≥–∏—Ä–ª”©”©–≥”© –±–æ–ª–±–æ–π—Ç.`);
             return;
        }
        if (dailyTurnover + amount > bank.baseLimit) {
            alert(`‚õîÔ∏è ${bankName} –±–∞–Ω–∫—ã–Ω—ã–Ω –∫“Ø–Ω–¥“Ø–∫ –ª–∏–º–∏—Ç–∏ ${bank.baseLimit.toLocaleString('ru-RU')} —Å–æ–º–¥–æ–Ω –∞—à—ã–ø –∫–µ—Ç—Ç–∏. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –ª–æ–≥–∏—Ä–ª”©”©–≥”© –±–æ–ª–±–æ–π—Ç.`);
            return;
        }

        if (actionType === 'income') {
            bank.income += amount;
        } else {
            bank.outcome += amount;
        }
        
        let wasResting = false;
        
        monthlyTurnover[bankName] = currentMonthlyTurnover + amount;

        let daysToRest = 0;
        if (amount >= RISK_TIER_3_DAYS) {
            daysToRest = 3; 
        } else if (amount >= RISK_TIER_2_DAYS) {
            daysToRest = 2; 
        }
        
        if (daysToRest > 0) {
            const restDate = new Date();
            restDate.setDate(restDate.getDate() + daysToRest);
            bank.restingUntil = restDate.toISOString();
            wasResting = true;
            alert(`üö® –í–ù–ò–ú–ê–ù–ò–ï! –°–¥–µ–ª–∫–∞ (${amount.toLocaleString('ru-RU')} —Å–æ–º) –Ω–∞ ${bankName}. –ë–∞–Ω–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ ${daysToRest} –¥–Ω—è(–µ–π) –æ—Ç–¥—ã—Ö–∞!`);
        }
        
        transactionLog.push({
            actionType: actionType,
            amount: amount,
            bankName: bankName,
            wasResting: wasResting 
        });

        showToast("–ò–π–≥–∏–ª–∏–∫—Ç“Ø“Ø! ‚úÖ");

        document.getElementById('transactionAmount').value = '';
        saveState();
        renderTable();
        generateRecommendations(); 
    }
    
    function logPersonalExpense() {
        const amount = parseFloat(document.getElementById('personalExpenseAmount').value);
        if (isNaN(amount) || amount <= 0) {
            alert("–¢—É—É—Ä–∞ —Å—É–º–º–∞–Ω—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }
        
        PERSONAL_EXPENSE_TODAY += amount;
        
        document.getElementById('personalExpenseAmount').value = '';
        saveState();
        renderTable(); 
        showToast(`–ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ ${amount.toLocaleString('ru-RU')} –°–æ–º –∫–æ—à—É–ª–¥—É.`);
    }

    function undoLastTransaction() {
        if (transactionLog.length === 0 && PERSONAL_EXPENSE_TODAY === 0) {
            alert("–ê—Ä—Ç–∫–∞ –∫–∞–π—Ç–∞—Ä—É—É “Ø—á“Ø–Ω —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∂–µ –∂–µ–∫–µ —Ä–∞—Å—Ö–æ–¥ –∂–æ–∫.");
            return;
        }

        if (!confirm("–°–∏–∑ –∞–∫—ã—Ä–∫—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–Ω—ã –∂–µ –∂–µ–∫–µ —Ä–∞—Å—Ö–æ–¥–¥—É –∞—Ä—Ç–∫–∞ –∫–∞–π—Ç–∞—Ä–≥—ã“£—ã–∑ –∫–µ–ª–µ–±–∏?")) {
            return;
        }

        if (PERSONAL_EXPENSE_TODAY > 0 && transactionLog.length === 0) {
            PERSONAL_EXPENSE_TODAY = 0; 
            saveState();
            renderTable();
            showToast("–ñ–µ–∫–µ —Ä–∞—Å—Ö–æ–¥ —Ç–∞–∑–∞–ª–∞–Ω–¥—ã.");
            return;
        }
        
        if (transactionLog.length > 0) {
            const lastTx = transactionLog.pop(); 
            
            const bank = bankLimits.find(b => b.name === lastTx.bankName);

            if (bank) {
                if (lastTx.actionType === 'income') {
                    bank.income -= lastTx.amount;
                } else {
                    bank.outcome -= lastTx.amount;
                }
                
                monthlyTurnover[bank.name] = (monthlyTurnover[bank.name] || 0) - lastTx.amount;
                if (monthlyTurnover[bank.name] < 0) monthlyTurnover[bank.name] = 0;

                if (lastTx.wasResting) {
                    bank.restingUntil = null; 
                }
            }

            saveState();
            renderTable();
            generateRecommendations(); 
            alert(`–ê–∫—ã—Ä–∫—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (${lastTx.bankName} - ${lastTx.amount.toLocaleString('ru-RU')} –°–æ–º) –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∞—Ä—Ç–∫–∞ –∫–∞–π—Ç–∞—Ä—ã–ª–¥—ã.`);
            return;
        }
    }
    
    // –°–ú–ï–ù–ê–ù–´ –ñ–ê–ë–£–£
    function applyLimitAdjustment(bank) {
        const turnover = bank.income + bank.outcome;
        const remaining = bank.baseLimit - turnover;
        
        if (remaining < 0) {
            const excess = Math.abs(remaining);
            const penalty = Math.ceil(excess * PENALTY_PERCENTAGE); 
            bank.baseLimit -= penalty;
            bank.baseLimit = Math.max(1000, bank.baseLimit); 
            
            const restDate = new Date();
            restDate.setDate(restDate.getDate() + 3);
            bank.restingUntil = restDate.toISOString();
            
        } else if (turnover >= bank.baseLimit * 0.9) {
            bank.baseLimit -= 1000; 
            bank.baseLimit = Math.max(1000, bank.baseLimit);
            
            const restDate = new Date();
            restDate.setDate(restDate.getDate() + 1);
            bank.restingUntil = restDate.toISOString();
        }
    }
    
    function getProfitComparison() {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        const totals = getTotals();
        const todaysProfit = totals.profit;
        
        const lastSession = history.filter(h => h.profit > 0).pop(); 
        
        if (!lastSession) {
             return { text: "–ë—É–ª –±–∏—Ä–∏–Ω—á–∏ —Å–µ—Å—Å–∏—è“£—ã–∑ –∂–µ –º—É—Ä—É–Ω–∫—É–ª–∞—Ä—ã–Ω–¥–∞ –ø–∞–π–¥–∞ –∂–æ–∫.", type: 'neutral' };
        }
        
        const yesterdayProfit = lastSession.profit;
        const diff = todaysProfit - yesterdayProfit;
        const percentChange = (diff / yesterdayProfit) * 100;
        
        let text;
        let type;

        if (diff > 0) {
            text = `–ö–µ—á—ç—ç–∫–∏ ${yesterdayProfit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º–≥–æ –∫–∞—Ä–∞–≥–∞–Ω–¥–∞ ${percentChange.toFixed(1)}% –∫”©–±“Ø—Ä”©”©–∫ –ø–∞–π–¥–∞! üìà`;
            type = 'positive';
        } else if (diff < 0) {
            text = `–ö–µ—á—ç—ç–∫–∏ ${yesterdayProfit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º–≥–æ –∫–∞—Ä–∞–≥–∞–Ω–¥–∞ ${Math.abs(percentChange).toFixed(1)}% –∞–∑—ã—Ä–∞–∞–∫ –ø–∞–π–¥–∞. üìâ`;
            type = 'negative';
        } else {
            text = `–ö–µ—á—ç—ç–∫–∏ –ø–∞–π–¥–∞ –º–µ–Ω–µ–Ω –±–∏—Ä–¥–µ–π!`;
            type = 'neutral';
        }

        return { text, type, profit: todaysProfit };
    }
    
    function openCloseSessionModal() {
        const modal = document.getElementById('closeSessionModal');
        const totals = getTotals();
        
        document.getElementById('personalExpensesTotal').value = totals.expense.toFixed(2).toLocaleString('ru-RU');
        document.getElementById('actualProfitInput').value = totals.profit.toFixed(2);
        document.getElementById('remainingAmount').value = (totals.income - totals.outcome).toFixed(0); 

        modal.style.display = 'flex';
    }

    function closeSession(fromModal = false) {
        if (!fromModal) return; 

        const remainingAmount = parseFloat(document.getElementById('remainingAmount').value.replace(/,/g, ''));
        const actualProfitInput = parseFloat(document.getElementById('actualProfitInput').value.replace(/,/g, ''));
        const totalExpense = PERSONAL_EXPENSE_TODAY;
        
        if (isNaN(remainingAmount) || isNaN(actualProfitInput)) {
            alert("–ö–∞–ª–¥—ã–∫ –∂–∞–Ω–∞ –ü–∞–π–¥–∞ —Å—É–º–º–∞–ª–∞—Ä—ã–Ω —Ç—É—É—Ä–∞ –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑.");
            return;
        }
        
        const lastSessionDateString = localStorage.getItem(STORAGE_LAST_DATE);
        if (lastSessionDateString && isSameDay(new Date(lastSessionDateString), new Date())) {
            alert("–°–º–µ–Ω–∞ —É–∂–µ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –±“Ø–≥“Ø–Ω. –ñ–∞“£—ã –∂–∞–∑—É—É —Å–∞–∫—Ç–∞–ª–≥–∞–Ω –∂–æ–∫.");
            return;
        }

        const totals = getTotals();
        const initialTurnover = totals.turnover;
        
        let newSpread = 0;
        if (initialTurnover > 0 && actualProfitInput > 0) {
            const usdTurnover = initialTurnover / BUY_RATE;
            newSpread = (actualProfitInput / usdTurnover) * 100;
        }

        if (newSpread > 0 && newSpread < 5) { 
            SPREAD = newSpread;
            saveGlobalSettings(); 
        } else if (newSpread > 5) {
             alert(`‚ö†Ô∏è –≠–°–ö–ï–†–¢“Æ“Æ: –°–ø—Ä–µ–¥ –º–∞–∞–Ω–∏—Å–∏ ${newSpread.toFixed(2)}% ”©—Ç”© –∂–æ–≥–æ—Ä—É. –£—á—É—Ä–¥–∞–≥—ã ${SPREAD}% —Å–∞–∫—Ç–∞–ª–∞—Ç.`);
        }

        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        
        history.push({
            date: formatDate(new Date().toISOString()),
            turnover: initialTurnover,
            income: totals.income,
            outcome: totals.outcome,
            profit: actualProfitInput, 
            remaining: remainingAmount, 
            expense: totalExpense, 
            spread: SPREAD.toFixed(2) 
        });
        localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));

        bankLimits.forEach(applyLimitAdjustment);
        
        clearCurrentDayData(); 
        transactionLog = []; 
        saveState(); 

        document.getElementById('closeSessionModal').style.display='none';
        
        renderTable();
        renderHistory();
        generateRecommendations(); 

        const successModal = document.getElementById('successModal');
        document.getElementById('modalProfitDisplay').textContent = actualProfitInput.toFixed(2).toLocaleString('ru-RU') + ' –°–æ–º';
        document.getElementById('modalNewSpread').textContent = SPREAD.toFixed(2) + '%'; 
        document.getElementById('modalExpenseDisplay').textContent = totalExpense.toFixed(2).toLocaleString('ru-RU') + ' –°–æ–º';
        
        successModal.style.display = 'flex';
    }
    
    // –¢–ê–ë–õ–ò–¶–ê –ñ–ê–ù–ê –ê–ù–ê–õ–ò–ó (8 –∫–æ–ª–æ–Ω–Ω–∞–≥–∞ —ã–ª–∞–π—ã–∫—Ç–∞—à—Ç—ã—Ä—ã–ª–≥–∞–Ω)
    
    // Column indices:
    // 0: –ë–∞–Ω–∫
    // 1: –ö“Ø–Ω. –õ–∏–º–∏—Ç
    // 2: –ö–∏—Ä–∏—à
    // 3: –ß—ã–≥—ã—à
    // 4: –ö“Ø–Ω. –û–±–æ—Ä–æ—Ç (2+3)
    // 5: –ö“Ø–Ω. –û—Å—Ç–∞—Ç–æ–∫ / –°–¢–ê–¢–£–° (1-4)
    // 6: –ê–π–ª—ã–∫ –õ–∏–º–∏—Ç
    // 7: –ê–π–ª—ã–∫ –û—Å—Ç–∞—Ç–æ–∫ (6 - monthlyTurnover)

    function sortTable(columnIndex) {
        let sortDirection = 'desc'; 
        
        // This is a simplified way to toggle direction for demonstration:
        if (trackerBody.dataset.sortColumn === String(columnIndex) && trackerBody.dataset.sortDirection === 'desc') {
            sortDirection = 'asc';
        }
        
        bankLimits.sort((a, b) => {
            let valA, valB;
            
            // Calculate monthly remaining for sorting
            const monthlyRemA = a.monthlyLimit - (monthlyTurnover[a.name] || 0);
            const monthlyRemB = b.monthlyLimit - (monthlyTurnover[b.name] || 0);
            
            // Calculate daily remaining
            const dailyRemA = a.baseLimit - (a.income + a.outcome);
            const dailyRemB = b.baseLimit - (b.income + b.outcome);

            switch (columnIndex) {
                case 0: 
                    valA = a.name.toLowerCase(); valB = b.name.toLowerCase();
                    return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                case 1: valA = a.baseLimit; valB = b.baseLimit; break;
                case 2: valA = a.income; valB = b.income; break;
                case 3: valA = a.outcome; valB = b.outcome; break;
                case 4: valA = a.income + a.outcome; valB = b.income + b.outcome; break;
                case 5: valA = dailyRemA; valB = dailyRemB; break;
                case 6: valA = a.monthlyLimit; valB = b.monthlyLimit; break; 
                case 7: valA = monthlyRemA; valB = monthlyRemB; break;
                default: return 0;
            }

            // Default sorting (numeric) for columns 1-7
            return sortDirection === 'asc' ? valA - valB : valB - valA;
        });
        
        trackerBody.dataset.sortColumn = String(columnIndex);
        trackerBody.dataset.sortDirection = sortDirection;

        renderTable();
    }
    
    function generateRecommendations() {
        const list = document.getElementById('recommendationList');
        list.innerHTML = '';
        
        const recs = [];
        let highRiskCount = 0;
        
        const leastUsed = bankLimits
            .filter(b => !b.restingUntil || new Date(b.restingUntil) < new Date()) 
            .map(b => ({
                ...b,
                turnover: b.income + b.outcome,
                remainingDaily: b.baseLimit - (b.income + b.outcome),
                remainingMonthly: b.monthlyLimit - (monthlyTurnover[b.name] || 0)
            }))
            .filter(b => b.remainingMonthly > b.monthlyLimit * 0.1) 
            .sort((a, b) => a.turnover - b.turnover) 
            .slice(0, 3); 

        leastUsed.forEach(bank => {
            if (bank.remainingDaily > bank.baseLimit * 0.2) { 
                recs.push({
                    text: `‚úÖ **${bank.name}** –∏—à—Ç–µ—Ç“Ø“Ø–≥”© —Å—É–Ω—É—à—Ç–∞–ª–∞—Ç! –û–±–æ—Ä–æ—Ç –∞–∑: ${bank.turnover.toLocaleString('ru-RU')} –°–æ–º. –ö–∞–ª–¥—ã–∫: ${bank.remainingDaily.toLocaleString('ru-RU')} –°–æ–º.`,
                    type: 'low'
                });
            }
        });

        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const remainingDaily = bank.baseLimit - turnover;
            const currentMonthlyTurnover = monthlyTurnover[bank.name] || 0;
            const remainingMonthly = bank.monthlyLimit - currentMonthlyTurnover;
            
            if (bank.restingUntil && new Date(bank.restingUntil) > new Date()) {
                const daysLeft = Math.ceil((new Date(bank.restingUntil) - new Date()) / MS_PER_DAY);
                recs.push({
                    text: `üõë **${bank.name}** - –≠–° –ê–õ–£–£–î–ê! ${daysLeft} –∫“Ø–Ω –∫–∞–ª–¥—ã.`,
                    type: 'rest'
                });
                highRiskCount++;
            } else if (remainingMonthly <= bank.monthlyLimit * 0.1 && remainingMonthly > 0) {
                 recs.push({
                    text: `üö® **${bank.name}** –ê–π–ª—ã–∫ –ª–∏–º–∏—Ç —Ç“Ø–≥”©–Ω“Ø“Ø –∞–ª–¥—ã–Ω–¥–∞! –ê–π–ª—ã–∫ –û—Å—Ç–∞—Ç–æ–∫: ${remainingMonthly.toLocaleString('ru-RU')} –°–æ–º.`,
                    type: 'high'
                });
                highRiskCount++;
            } else if (remainingMonthly <= 0) {
                 recs.push({
                    text: `üö® **${bank.name}** –ê–π–ª—ã–∫ –ª–∏–º–∏—Ç –¢“Æ–ì”®–ù–î“Æ!`,
                    type: 'high'
                });
                highRiskCount++;
            } else if (remainingDaily <= bank.baseLimit * 0.1 && remainingDaily > 0) {
                recs.push({
                    text: `‚ö†Ô∏è **${bank.name}** –ö“Ø–Ω–¥“Ø–∫ –ª–∏–º–∏—Ç—Ç–∏–Ω 10% –∞–∑—ã –∫–∞–ª–¥—ã! (–ö–∞–ª–¥—ã–∫: ${remainingDaily.toLocaleString('ru-RU')} –°–æ–º). –¢–æ–∫—Ç–æ—Ç—É—É —Å—É–Ω—É—à—Ç–∞–ª–∞—Ç.`,
                    type: 'high'
                });
                highRiskCount++;
            } else if (remainingDaily < 0) {
                 recs.push({
                    text: `üö® **${bank.name}** –ö“Ø–Ω–¥“Ø–∫ –ª–∏–º–∏—Ç–∏ ${(-remainingDaily).toLocaleString('ru-RU')} –°–æ–º–≥–æ –ê–®–´–ü –ö–ï–¢–¢–ò! –°–º–µ–Ω–∞–Ω—ã –∂–∞–±—ã“£—ã–∑.`,
                    type: 'high'
                });
                highRiskCount++;
            }
        });

        if (highRiskCount >= 3) {
             recs.push({
                text: `üî• **–≠–°–ö–ï–†–¢“Æ“Æ!** 3 –∂–µ –∞–Ω–¥–∞–Ω –∫”©–ø –±–∞–Ω–∫ –∂–æ–≥–æ—Ä–∫—É —Ç–æ–±–æ–∫–µ–ª–¥–∏–∫—Ç–µ. –°–º–µ–Ω–∞–Ω—ã –∂–∞–±—É—É —Å—É–Ω—É—à—Ç–∞–ª–∞—Ç.`,
                type: 'high'
            });
        }
        
        if (recs.length === 0) {
             list.innerHTML = `<li>‚ú® –£—á—É—Ä–¥–∞ –±–∞—Ä–¥—ã–∫ –±–∞–Ω–∫—Ç–∞—Ä –∂–∞—à—ã–ª –∑–æ–Ω–∞–¥–∞. –ò—à—Ç–∏ —É–ª–∞–Ω—Ç–∞ –±–µ—Ä–∏“£–∏–∑!</li>`;
             return;
        }

        recs.forEach(rec => {
            const li = document.createElement('li');
            li.className = `recommend-${rec.type}`;
            li.innerHTML = rec.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            list.appendChild(li);
        });
    }

    function renderBankOptions() {
         const select = document.getElementById('transactionBank');
        select.innerHTML = '<option value="">--- –ë–∞–Ω–∫ –¢–∞–Ω–¥–æ–æ ---</option>';
        
        for (const name in STARTING_LIMITS) {
             const option = document.createElement('option');
             option.value = name;
             option.textContent = name;
             select.appendChild(option);
        }
    }

    function renderTable() {
        const trackerBody = document.getElementById('trackerBody');
        trackerBody.innerHTML = '';
        let grandTotalIncome = 0;
        let grandTotalOutcome = 0;

        bankLimits.forEach(bank => {
            const turnover = bank.income + bank.outcome;
            const currentDailyLimit = bank.baseLimit; 
            const remainingDaily = currentDailyLimit - turnover;
            const currentMonthlyTurnover = monthlyTurnover[bank.name] || 0;
            const remainingMonthly = bank.monthlyLimit - currentMonthlyTurnover;

            const now = new Date();
            let isResting = false;
            let statusText = '';
            let statusClass = 'status-ok';

            if (bank.restingUntil) {
                const restDate = new Date(bank.restingUntil);
                if (restDate > now) {
                    const daysLeft = Math.ceil((restDate - now) / MS_PER_DAY);
                    statusText = `<span class="status-rest">–≠–° –ê–õ–£–£–î–ê (${daysLeft} –∫.)</span>`;
                    statusClass = '';
                    isResting = true;
                } else {
                    bank.restingUntil = null; 
                    saveState();
                }
            }
            
            if (!isResting) {
                if (remainingDaily <= 0) {
                    statusText = "–õ–∏–º–∏—Ç –¢“Ø–≥”©–Ω–¥“Ø!";
                    statusClass = 'status-danger';
                } else {
                    statusText = remainingDaily.toLocaleString('ru-RU');
                    statusClass = remainingDaily <= (currentDailyLimit * 0.1) ? 'status-danger' : 'status-ok'; 
                }
            }
            
            // Monthly remaining status
            const monthlyStatusClass = remainingMonthly <= bank.monthlyLimit * 0.1 ? 'status-danger' : 'status-ok';

            // FULL TABLE STRUCTURE (8 columns)
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${bank.name}</td>
                <td>${currentDailyLimit.toLocaleString('ru-RU')}</td>
                <td>${bank.monthlyLimit.toLocaleString('ru-RU')}</td> 
                <td>${bank.income.toLocaleString('ru-RU')}</td>
                <td>${bank.outcome.toLocaleString('ru-RU')}</td>
                <td>${turnover.toLocaleString('ru-RU')}</td>
                <td class="${monthlyStatusClass}">${remainingMonthly.toLocaleString('ru-RU')}</td> 
                <td class="${statusClass}">${statusText}</td>
            `;

            trackerBody.appendChild(row);

            grandTotalIncome += bank.income;
            grandTotalOutcome += bank.outcome;
        });

        const grandTotalTurnover = grandTotalIncome + grandTotalOutcome;
        
        document.getElementById('totalIncome').textContent = grandTotalIncome.toLocaleString('ru-RU');
        document.getElementById('totalOutcome').textContent = grandTotalOutcome.toLocaleString('ru-RU');
        document.getElementById('totalTurnover').textContent = grandTotalTurnover.toLocaleString('ru-RU');
        
        // Final Remaining/Difference calculation (V15/V16 style)
        document.getElementById('totalRemaining').textContent = (grandTotalIncome - grandTotalOutcome).toLocaleString('ru-RU'); 


        const estimatedProfit = (grandTotalTurnover / BUY_RATE) * (SPREAD / 100);
        document.getElementById('estimatedProfit').textContent = estimatedProfit.toFixed(2).toLocaleString('ru-RU') + ' –°–æ–º';
        document.getElementById('spreadDisplay').textContent = `${SPREAD.toFixed(2)}%`;
        document.getElementById('buyRateDisplay').textContent = BUY_RATE.toFixed(2);
        document.getElementById('spreadValueDisplay').textContent = (SPREAD / 100).toFixed(4);

        const comparison = getProfitComparison();
        const comparisonDiv = document.getElementById('comparisonDisplay');
        comparisonDiv.textContent = comparison.text;
        comparisonDiv.className = `comparison comp-${comparison.type}`;
        
        document.getElementById('personalExpenseSummary').textContent = 
            `–ñ–∞–ª–ø—ã –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥ (–°–º–µ–Ω–∞–¥–∞): ${PERSONAL_EXPENSE_TODAY.toFixed(2).toLocaleString('ru-RU')} –°–æ–º`;
    }

    // –¢–ê–†–´–•
    function renderHistory() {
        const historyBody = document.getElementById('historyBody');
        const totalHistoryProfitElement = document.getElementById('totalHistoryProfit');
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        
        historyBody.innerHTML = '';
        let totalProfit = 0;

        if (history.length === 0) {
            historyBody.innerHTML = '<tr><td colspan="3">–ê–∑—ã—Ä—ã–Ω—á–∞ —Å–∞–∫—Ç–∞–ª–≥–∞–Ω —Å–µ—Å—Å–∏—è –∂–æ–∫.</td></tr>';
             totalHistoryProfitElement.textContent = '0.00';
            return;
        }

        history.slice().reverse().forEach((record, index) => {
            const row = document.createElement('tr');
            row.dataset.index = history.length - 1 - index; 
            row.style.cursor = 'pointer';
            row.onclick = function() { viewHistoryRecord(this.dataset.index); };
            totalProfit += record.profit;

            row.innerHTML = `
                <td>${record.date}</td>
                <td>${record.turnover.toLocaleString('ru-RU')}</td>
                <td class="history-profit">${record.profit.toFixed(2).toLocaleString('ru-RU')}</td>
            `;
            historyBody.appendChild(row);
        });
        
        totalHistoryProfitElement.textContent = totalProfit.toFixed(2).toLocaleString('ru-RU');
    }

    function clearHistory() {
         if (!confirm("‚ö†Ô∏è –¢–∞—Ä—ã—Ö—Ç—ã —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω ”©—á“Ø—Ä“Ø“Ø–Ω“Ø –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?")) {
            return;
        }
        localStorage.removeItem(STORAGE_HISTORY);
        renderHistory();
        alert("–¢–∞—Ä—ã—Ö –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø —Ç–∞–∑–∞–ª–∞–Ω–¥—ã.");
    }
    
    function viewHistoryRecord(index) {
         const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
         const record = history[index];
        
         let details = `
             üìÖ –¢–∞—Ä—ã—Ö—ã–π –û—Ç—á–µ—Ç: ${record.date}
             –û–±—â–∏–π –û–±–æ—Ä–æ—Ç: ${record.turnover.toLocaleString('ru-RU')} –°–æ–º
             –ö–∏—Ä–∏—à (–ü—Ä–∏—Ö–æ–¥): ${record.income.toLocaleString('ru-RU')} –°–æ–º
             –ß—ã–≥—ã—à (–†–∞—Å—Ö–æ–¥): ${record.outcome.toLocaleString('ru-RU')} –°–æ–º
             
             üí∏ –¢–∞–∑–∞ –ü–∞–π–¥–∞: ${record.profit.toFixed(2).toLocaleString('ru-RU')} –°–æ–º
             % –°–ø—Ä–µ–¥: ${record.spread || SPREAD.toFixed(2)}%
             üí∞ –ö–∞–ª–¥—ã–∫ –ö–∞—Ä–∞–∂–∞—Ç: ${record.remaining ? record.remaining.toLocaleString('ru-RU') + ' –°–æ–º' : 'N/A'}
             üõí –ñ–µ–∫–µ –†–∞—Å—Ö–æ–¥: ${record.expense ? record.expense.toLocaleString('ru-RU') + ' –°–æ–º' : 'N/A'}
         `;
        
         alert(details);
    }
    
    function exportHistoryToCSV() {
        const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY) || '[]');
        if (history.length === 0) {
            alert("–≠–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ “Ø—á“Ø–Ω —Ç–∞—Ä—ã—Ö—Ç–∞ –º–∞–∞–ª—ã–º–∞—Ç –∂–æ–∫.");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 

        csvContent += "–î–∞—Ç–∞;–û–±—â–∏–π –û–±–æ—Ä–æ—Ç;–ü—Ä–∏—Ö–æ–¥;–†–∞—Å—Ö–æ–¥;–ü—Ä–∏–±—ã–ª—å;–ö–∞–ª–¥—ã–∫;–ñ–µ–∫–µ_–†–∞—Å—Ö–æ–¥;–°–ø—Ä–µ–¥_%\n";

        history.forEach(record => {
            const row = [
                record.date,
                record.turnover.toFixed(2),
                record.income.toFixed(2),
                record.outcome.toFixed(2),
                record.profit.toFixed(2),
                (record.remaining || 0).toFixed(2),
                (record.expense || 0).toFixed(2),
                record.spread || SPREAD.toFixed(2)
            ].join(';');
            csvContent += row + '\n';
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `P2P_Tracker_History_${formatDate(new Date().toISOString()).replace(/\./g, '-')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Global exposure for HTML inline clicks
    window.init = init;
    window.checkAuthStatus = checkAuthStatus;
    window.loginUser = loginUser; 
    window.logout = logout;
    window.showMainTracker = showMainTracker;
    window.toggleSettings = toggleSettings;
    window.toggleSync = toggleSync;
    window.toggleMonthlyLimits = toggleMonthlyLimits; 
    window.exportHistoryToCSV = exportHistoryToCSV; 
    window.clearAllData = clearAllData; 
    window.clearHistory = clearHistory; 
    window.undoLastTransaction = undoLastTransaction;
    window.updateSettings = updateSettings; 
    window.addBank = addBank;
    window.removeBank = removeBank;
    window.resetCurrentDay = resetCurrentDay;
    window.closeSession = closeSession; 
    window.openCloseSessionModal = openCloseSessionModal; 
    window.logPersonalExpense = logPersonalExpense;
    window.logTransaction = logTransaction;
    window.viewHistoryRecord = viewHistoryRecord; 
    window.exportDataCode = exportDataCode;
    window.importDataCode = importDataCode;
    window.sortTable = sortTable;
</script>
</body>
</html>